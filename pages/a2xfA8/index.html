<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linux容器的隔离与限制 | CloudNative Operations</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="专注于云原生运维技术分享,Kubernetes,Prometheus，istio,envoy等技术文章">
    <meta name="CloudNative Operations" content="专注于云原生运维技术分享,致敬每个爱学习的你">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.546f0649.css" as="style"><link rel="preload" href="/assets/js/app.f5785a59.js" as="script"><link rel="preload" href="/assets/js/2.f3cfc96e.js" as="script"><link rel="preload" href="/assets/js/25.6990632a.js" as="script"><link rel="prefetch" href="/assets/js/10.96ead027.js"><link rel="prefetch" href="/assets/js/11.29cd15ad.js"><link rel="prefetch" href="/assets/js/12.d29365cb.js"><link rel="prefetch" href="/assets/js/13.1fa2caec.js"><link rel="prefetch" href="/assets/js/14.cfc40d4c.js"><link rel="prefetch" href="/assets/js/15.a8f19ee2.js"><link rel="prefetch" href="/assets/js/16.8afabe39.js"><link rel="prefetch" href="/assets/js/17.910be118.js"><link rel="prefetch" href="/assets/js/18.c9e39dd1.js"><link rel="prefetch" href="/assets/js/19.5e9dffcc.js"><link rel="prefetch" href="/assets/js/20.e49ff1df.js"><link rel="prefetch" href="/assets/js/21.374ea34b.js"><link rel="prefetch" href="/assets/js/22.a7cc72bd.js"><link rel="prefetch" href="/assets/js/23.dcf8d006.js"><link rel="prefetch" href="/assets/js/24.d423cbe2.js"><link rel="prefetch" href="/assets/js/26.b8a6b958.js"><link rel="prefetch" href="/assets/js/27.c34c8dbb.js"><link rel="prefetch" href="/assets/js/28.5ad8566c.js"><link rel="prefetch" href="/assets/js/29.ec2161e1.js"><link rel="prefetch" href="/assets/js/3.c40e1967.js"><link rel="prefetch" href="/assets/js/30.08ff84c4.js"><link rel="prefetch" href="/assets/js/31.6e688050.js"><link rel="prefetch" href="/assets/js/32.8cde09e7.js"><link rel="prefetch" href="/assets/js/33.69e0ede4.js"><link rel="prefetch" href="/assets/js/34.fb97b72f.js"><link rel="prefetch" href="/assets/js/4.523f8496.js"><link rel="prefetch" href="/assets/js/5.ab2f819c.js"><link rel="prefetch" href="/assets/js/6.027987a4.js"><link rel="prefetch" href="/assets/js/7.850f1c73.js"><link rel="prefetch" href="/assets/js/8.81da17b7.js"><link rel="prefetch" href="/assets/js/9.f022d6ba.js">
    <link rel="stylesheet" href="/assets/css/0.styles.546f0649.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="CloudNative Operations" class="logo"> <span class="site-name can-hide">CloudNative Operations</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/books/" class="nav-link">书籍</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div> <a href="https://github.com/cf1998/kubernetes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://kubesre.com/img/EB-logo.png"> <div class="blogger-info"><h3>船长</h3> <span>CloudNative Operations</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/books/" class="nav-link">书籍</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div> <a href="https://github.com/cf1998/kubernetes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Linux容器的隔离与限制</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a2xfA8/#linux进程引入" class="sidebar-link">Linux进程引入</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/a2xfA8/#linux容器的隔离" class="sidebar-link">Linux容器的隔离</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/a2xfA8/#linux容器的限制" class="sidebar-link">Linux容器的限制</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><!----> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>船长</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-08-12</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-1cd794fe><a href="/categories/?category=Linux" data-v-1cd794fe>Linux </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          Linux容器的隔离与限制
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="linux进程引入"><a href="#linux进程引入" class="header-anchor">#</a> Linux进程引入</h2> <p>如果你要写一个计算加法的小程序，这个程序需要输入来自于一个文件，计算完成后的结果则输入到另一个文件中。

由于计算机只认识0和1，所以无论用那种语言编写这段代码，最后都需要通过某种方式翻译成二进制文件，才能在计算机操作系统中运行起来。</p> <p>而为了能够让这些代码正常运行，我们往往还要给它提供数据，比如我们这个加法程序所需要的输入文件。这些数据加上代码本身的二进制文件，放在磁盘，就是我们平常所说的一个<code>程序</code>，也叫代码的可执行镜像（executable image）。</p> <p>然后，我们就可以在计算机上运行这个<code>程序</code>了。</p> <p>首先，操作系统从<code>程序</code>中发现输入保存在一个文件中，所以这些数据就被会加载到内存中待命。同时，操作系统又读取到了计算加法的指令，这时，它就需要指示CPU完成加法操作。而CPU与内存协作进行加法计算，又会使用寄存器存放数值、内存堆栈保存执行的命令和变量。同时，计算机里还有被打开的文件，以及各种各样的I/O设备在不断地调用中修改自己的状态。</p> <p>就这样，一旦<code>程序</code>被执行起来，它就从磁盘上的二进制文件，变成了计算机内存中的数据、寄存器里的值，堆栈中的指令、被打开的文件，以及各种设备状态信息的一个集合。像这样一个程序运行起来后的计算机执行环境的总和，就是我们的主角：进程。</p> <p>所以，对于进程来说，它的静态表现就是程序，平常都安安静静地待在磁盘上；而一旦运行起来，它就成为了计算机里的数据和状态的总和，这就是它的动态表现，</p> <h2 id="linux容器的隔离"><a href="#linux容器的隔离" class="header-anchor">#</a> Linux容器的隔离</h2> <p>Docker容器本质上就是Linux操作系统的进程，只是Docker通过namespace实现了进程间的资源隔离技术，这样说起来很多人会感觉到很抽象，那接下来我们通过实战进行了解一下吧！</p> <p>首先我们先创建一个容器：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># docker run -it busybox /bin/sh</span>
/ <span class="token comment"># </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在容器里执行一下PS指令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>/ <span class="token comment"># ps</span>
PID   <span class="token environment constant">USER</span>     TIME  COMMAND
    <span class="token number">1</span> root      <span class="token number">0</span>:00 /bin/sh
    <span class="token number">6</span> root      <span class="token number">0</span>:00 <span class="token function">ps</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到，我们在Docker里最开始执行的/bin/sh，就是这个容器内部的第1号进程（PID=1），而这个容器里一共只有两个进程在运行。这就意味着，前面执行的/bin/sh，以及我们刚刚执行的ps，已经被Docker隔离在一个跟宿主机不同的世界当中。</p> <p><strong>这究竟事怎么做到的呢？</strong></p> <p>本来，每当我们在宿主机上运行了一个 /bin/sh 程序，操作系统都会给它分配一个进程编号，比如 PID=100。这个编号是进程的唯一标识，就像员工的工牌一样。所以 PID=100，可以粗略地理解为这个 /bin/sh 是我们公司里的第 100 号员工，而第 1 号员工就自然是比尔 · 盖茨这样统领全局的人物。而现在，我们要通过 Docker 把这个 /bin/sh 程序运行在一个容器当中。这时候，Docker 就会在这个第 100 号员工入职时给他施一个“障眼法”，让他永远看不到前面的其他 99 个员工，更看不到比尔 · 盖茨。这样，他就会错误地以为自己就是公司里的第 1 号员工。这种机制，其实就是对被隔离应用的进程空间做了手脚，使得这些进程只能看到重新计算过的进程编号，比如 PID=1。可实际上，他们在宿主机的操作系统里，还是原来的第 100 号进程。</p> <p>**这种技术，就是 Linux 里面的 Namespace 机制。**而 Namespace 的使用方式也非常有意思：它其实只是 Linux 创建新进程的一个可选参数。我们知道，在 Linux 系统中创建线程的系统调用是 clone()，比如：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>main_function<span class="token punctuation">,</span> stack_size<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个系统调用就会为我们创建一个新的进程，并且返回它的进程号 pid。</p> <p>而当我们用 clone() 系统调用创建一个新进程时，就可以在参数中指定 CLONE_NEWPID 参数，比如：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>main_function<span class="token punctuation">,</span> stack_size<span class="token punctuation">,</span> CLONE_NEWPID <span class="token operator">|</span> SIGCHLD<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这时，新创建的这个进程将会“看到”一个全新的进程空间，在这个进程空间里，它的 PID 是 1。之所以说“看到”，是因为这只是一个“障眼法”，在宿主机真实的进程空间里，这个进程的 PID 还是真实的数值，比如 100。</p> <p>当然，我们还可以多次执行上面的 clone() 调用，这样就会创建多个 PID Namespace，而每个 Namespace 里的应用进程，都会认为自己是当前容器里的第 1 号进程，它们既看不到宿主机里真正的进程空间，也看不到其他 PID Namespace 里的具体情况。</p> <p>而除了我们刚刚用到的 PID Namespace，Linux 操作系统还提供了 Mount、UTS、IPC、Network 和 User 这些 Namespace，用来对各种不同的进程上下文进行“障眼法”操作。比如，Mount Namespace，用于让被隔离进程只看到当前 Namespace 里的挂载点信息；Network Namespace，用于让被隔离进程看到当前 Namespace 里的网络设备和配置。</p> <p><strong>这，就是 Linux 容器最基本的实现原理了。</strong></p> <p>所以，Docker 容器这个听起来玄而又玄的概念，实际上是在创建容器进程时，指定了这个进程所需要启用的一组 Namespace 参数。这样，容器就只能“看”到当前 Namespace 所限定的资源、文件、设备、状态，或者配置。而对于宿主机以及其他不相关的程序，它就完全看不到了。</p> <p><strong>所以说，容器，其实是一种特殊的进程而已。</strong></p> <h2 id="linux容器的限制"><a href="#linux容器的限制" class="header-anchor">#</a> Linux容器的限制</h2> <p><strong>为什么需要对容器做<code>限制</code>呢？</strong></p> <p>虽然容器内的第一号进程在<code>障眼法</code>的干扰下只能看到容器里的情况，但是宿主机上，它作为第100号进程与其他所有进程之间依然事平台的竞争关系，这就意味着，虽然第100号进程表面上被隔离起来，但是它所能够使用到的资源（比如CPU，内存），却是可以随时被宿主机上的其他进程（或者其他机器）占用的。当然这个100号进程自己也可能把所有资源吃光。这些情况，显然都不是一个沙盒应该标识出来的合理行为。</p> <p><strong>Linux Cgroups是什么？</strong></p> <p>cgroups是Linux下控制一个（或一组）进程的资源限制机制，全称是control groups，可以对cpu、内存等资源做精细化控制，比如目前很多的Docker在Linux下就是基于cgroups提供的资源限制机制来实现资源控制的；除此之外，开发者也可以指直接基于cgroups来进行进程资源控制，比如8核的机器上部署了一个web服务和一个计算服务，可以让web服务仅可使用其中6个核，把剩下的两个核留给计算服务。cgroups cpu限制除了可以限制使用多少/哪几个核心之外，还可以设置cpu占用比（注意占用比是各自都跑满情况下的使用比例，如果一个cgroup空闲而另一个繁忙，那么繁忙的cgroup是有可能占满整个cpu核心的）。</p> <p>在Linux中，Cgroups给用户暴漏出的操作接口是文件系统，即它以文件和目录的方式组织在操作系统的<code>/sys/fs/cgroup</code> 路径下。在Centos 机器里，我们可以用mount命令将他们展示：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>/ <span class="token comment"># mount -t cgroup</span>
cgroup on /sys/fs/cgroup/systemd <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,xattr,release_agent<span class="token operator">=</span>/usr/lib/systemd/systemd-cgroups-agent,name<span class="token operator">=</span>systemd<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/hugetlb <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,hugetlb<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,cpuacct,cpu<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/freezer <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,freezer<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,net_prio,net_cls<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/blkio <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,blkio<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/cpuset <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,cpuset<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/perf_event <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,perf_event<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/memory <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,memory<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/devices <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,devices<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/pids <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>ro,seclabel,nosuid,nodev,noexec,relatime,pids<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>目前看到，在<code>/sys/fs/cgroup</code>下面有很多诸如cpuset、cpu、memory这样的子目录，也叫子系统。这些都是我这台机器当前可以被Cgroups进行限制的资源种类。而在子系统对应的资源类下，你就可以看到该类资源具体可以被限制的方法。</p> <p>比如，对CPU子系统来说，我们就可以看到如下几个配置文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>/ <span class="token comment"># ls -l /sys/fs/cgroup/cpu/</span>
total <span class="token number">0</span>
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cgroup.clone_children
--w--w--w-    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cgroup.event_control
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cgroup.procs
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpu.cfs_period_us
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpu.cfs_quota_us
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpu.rt_period_us
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpu.rt_runtime_us
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpu.shares
-r--r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpu.stat
-r--r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpuacct.stat
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpuacct.usage
-r--r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 cpuacct.usage_percpu
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 notify_on_release
-rw-r--r--    <span class="token number">1</span> root     root             <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">10</span>:55 tasks
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>对Linux CPU管理熟悉的同学，应该会注意到cfs_period和cfs_quota这样的关键词。这两个参数需要组合使用，可以用来限制进程在长度cfs_period的一段时间内，只能被分配到总量为cfs_quota的CPU时间。</p> <p><strong>接下来我们来使用下此配置?</strong></p> <p>首先我们需要在对应的子系统下面创建一个目录：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># cd /sys/fs/cgroup/cpu</span>
<span class="token comment"># mkdir container</span>
<span class="token comment"># cd container/</span>
<span class="token comment"># ll</span>
total <span class="token number">0</span>
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cgroup.clone_children
--w--w--w-. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cgroup.event_control
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cgroup.procs
-r--r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpuacct.stat
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpuacct.usage
-r--r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpuacct.usage_percpu
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpu.cfs_period_us
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpu.cfs_quota_us
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpu.rt_period_us
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpu.rt_runtime_us
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpu.shares
-r--r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 cpu.stat
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 notify_on_release
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">0</span> Aug <span class="token number">12</span> <span class="token number">19</span>:38 tasks
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这个目录被称为一个控制组。你会发现，操作系统会在你新创建的container目录下，自动生成子系统对应的资源限制文件。</p> <p>此刻，我们执行一个死循环脚本，把计算的CPU吃到100%</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># while : ; do : ; done </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># top</span>
  PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                 
 <span class="token number">7996</span> root      <span class="token number">20</span>   <span class="token number">0</span>    <span class="token number">1320</span>    <span class="token number">256</span>    <span class="token number">212</span> R  <span class="token number">100</span>  <span class="token number">0.0</span>   <span class="token number">1</span>:12.75 <span class="token function">sh</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过top命令可以看到，CPU的使用率已经100%</p> <p>此时，我们可以通过查看container目录下的文件，可以看到container控制组的CPU quota还没有任何限制（：-1）</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># cat  /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us </span>
-1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接下来我们通过修改这些文件来设置限制：</p> <p>向container组里的cfs_quota文件写入20ms（20000 us）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> echo 20000 &gt; /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>100ms的时间里，被该控制组限制的进行只能使用20MS的CPU时间，也就是说这个进程只能使用到20%的CPU带宽</p></blockquote> <p>接下来，我们把被限制的进程的PID写入container组里的tasks文件，上面的设置就会对该进程生效了</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># echo 7996 &gt; /sys/fs/cgroup/cpu/container/tasks </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后通过top查看下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND               
 <span class="token number">7996</span> root      <span class="token number">20</span>   <span class="token number">0</span>  <span class="token number">119484</span>   <span class="token number">6140</span>   <span class="token number">1652</span> R  <span class="token number">20.3</span>  <span class="token number">0.2</span>   <span class="token number">3</span>:45.10 <span class="token function">sh</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到，计算机的CPU使用率立刻降到了20%</p> <p><strong><u>是不是很神奇？</u></strong></p> <p>除了CPU子系统外，Cgroups的每一项子系统都有独有的资源限制能力：比如</p> <ul><li>blkio，为块设备设定I/O限制，一般用于磁盘等设备</li> <li>cpuset，为进程分配单独的CPU核和对应的内存节点</li> <li>memory，为进程设定内存使用的限制</li></ul> <p>Linux Cgroups的设计还是比较易用的，简单粗暴地理解呢，它就是一个子系统目录加上一组资源限制文件的组合。而对于Docker等Linux容器项目来说，它们只需要在每个子系统下面，为每个容器创建一个控制组（即创建一个目录），然后在启动容器进程之后，把这个进程PID填写到对应控制组的tasks文件中就可以了。</p> <p>而至于在这些控制组下面的资源文件里填上什么值，就靠用户执行docker run时的参数指定就可以了,比如如下命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># docker run -it --cpu-period=10000 --cpu-quota=20000 ubuntu /bin/bash</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在启动这个容器后，我们可以通过查看Cgroup文件系统下，CPU子系统中，<code>docker</code>这个控制组里的资源限制文件的内容来确认：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#cat/sys/fs/cgroup/cpu/docker/0712c3d12935b9a3f69ac976b9d70309b78cb7db9a5a5c8a612742370b7453e4/cpu.cfs_period_us </span>
<span class="token number">10000</span>
<span class="token comment">#cat/sys/fs/cgroup/cpu/docker/0712c3d12935b9a3f69ac976b9d70309b78cb7db9a5a5c8a612742370b7453e4/cpu.cfs_quota_us </span>
<span class="token number">20000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/cf1998/kubernetes/edit/master/docs/_posts/Linux/Linux容器的隔离与限制.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Docker" title="标签">#Docker</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/k8s002/"><div>平滑升级Kubernetes集群(二进制)</div></a> <span>11-28</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/k8s001/"><div>Kubernetes 零宕机滚动更新</div></a> <span>11-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/uvrvk3/"><div>企业级高可用Kubernetes1.20.x集群(二进制)</div></a> <span>11-26</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:995345781@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/cf1998" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2021
    <span>CloudNative Operations</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.f5785a59.js" defer></script><script src="/assets/js/2.f3cfc96e.js" defer></script><script src="/assets/js/25.6990632a.js" defer></script>
  </body>
</html>