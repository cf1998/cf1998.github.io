<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes 控制器-Job | CloudNative Operations</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-9354336437522810" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="专注于云原生运维技术分享,Kubernetes,Prometheus，istio,envoy等技术文章">
    <meta name="CloudNative Operations" content="专注于云原生运维技术分享,致敬每个爱学习的你">
    <meta name="baidu-site-verification" content="code-UYHaqAD5D2">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.546f0649.css" as="style"><link rel="preload" href="/assets/js/app.787830ba.js" as="script"><link rel="preload" href="/assets/js/2.f3cfc96e.js" as="script"><link rel="preload" href="/assets/js/11.c2c674ed.js" as="script"><link rel="prefetch" href="/assets/js/10.16229420.js"><link rel="prefetch" href="/assets/js/12.dea116c0.js"><link rel="prefetch" href="/assets/js/13.2cb6671d.js"><link rel="prefetch" href="/assets/js/14.a5ba773e.js"><link rel="prefetch" href="/assets/js/15.a8f19ee2.js"><link rel="prefetch" href="/assets/js/16.33a07abe.js"><link rel="prefetch" href="/assets/js/17.8154ca7b.js"><link rel="prefetch" href="/assets/js/18.d8fc7faa.js"><link rel="prefetch" href="/assets/js/19.42c2fa93.js"><link rel="prefetch" href="/assets/js/20.0b54bbf5.js"><link rel="prefetch" href="/assets/js/21.5e4704b4.js"><link rel="prefetch" href="/assets/js/22.040d9dbf.js"><link rel="prefetch" href="/assets/js/23.735afcdf.js"><link rel="prefetch" href="/assets/js/24.d423cbe2.js"><link rel="prefetch" href="/assets/js/25.f7f962ca.js"><link rel="prefetch" href="/assets/js/26.d33e81c4.js"><link rel="prefetch" href="/assets/js/27.c34c8dbb.js"><link rel="prefetch" href="/assets/js/28.91af5a5e.js"><link rel="prefetch" href="/assets/js/29.14516ee9.js"><link rel="prefetch" href="/assets/js/3.aef08317.js"><link rel="prefetch" href="/assets/js/30.4ddee204.js"><link rel="prefetch" href="/assets/js/31.94d98463.js"><link rel="prefetch" href="/assets/js/32.2fe9d8c8.js"><link rel="prefetch" href="/assets/js/33.0a408b97.js"><link rel="prefetch" href="/assets/js/34.a2722a59.js"><link rel="prefetch" href="/assets/js/35.ef20d1ab.js"><link rel="prefetch" href="/assets/js/36.1a468a42.js"><link rel="prefetch" href="/assets/js/4.523f8496.js"><link rel="prefetch" href="/assets/js/5.ab2f819c.js"><link rel="prefetch" href="/assets/js/6.027987a4.js"><link rel="prefetch" href="/assets/js/7.850f1c73.js"><link rel="prefetch" href="/assets/js/8.8d86eac4.js"><link rel="prefetch" href="/assets/js/9.42fab877.js">
    <link rel="stylesheet" href="/assets/css/0.styles.546f0649.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="CloudNative Operations" class="logo"> <span class="site-name can-hide">CloudNative Operations</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/books/" class="nav-link">书籍</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div> <a href="https://github.com/cf1998/kubernetes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://kubesre.com/img/EB-logo.png"> <div class="blogger-info"><h3>船长</h3> <span>CloudNative Operations</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/books/" class="nav-link">书籍</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div> <a href="https://github.com/cf1998/kubernetes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="sidebar-slot sidebar-slot-top"><!--  固定100% * 150px可显示，max-height:150px 未见显示-->
    <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:150px"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Kubernetes 控制器-Job</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/uvrvk2/#概述" class="sidebar-link">概述</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk2/#job-example" class="sidebar-link">Job example</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk2/#job的定义" class="sidebar-link">Job的定义</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#pod-模板" class="sidebar-link">Pod 模板</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#pod-选择算符" class="sidebar-link">Pod 选择算符</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#job-的并行执行" class="sidebar-link">Job 的并行执行</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#控制并行性" class="sidebar-link">控制并行性</a></li></ul></li><li><a href="/pages/uvrvk2/#处理-pod-和容器失效" class="sidebar-link">处理 Pod 和容器失效</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#pod-回退失效策略" class="sidebar-link">Pod 回退失效策略</a></li></ul></li><li><a href="/pages/uvrvk2/#job-终止与清理" class="sidebar-link">Job 终止与清理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#自动清理完成的-job" class="sidebar-link">自动清理完成的 Job</a></li></ul></li><li><a href="/pages/uvrvk2/#job-模式" class="sidebar-link">Job 模式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk2/#job的特殊操作" class="sidebar-link">Job的特殊操作</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk2/#job-替代方案" class="sidebar-link">Job 替代方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#裸pod" class="sidebar-link">裸Pod</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#副本控制器" class="sidebar-link">副本控制器</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk2/#单个-job-启动控制器-pod" class="sidebar-link">单个 Job 启动控制器 Pod</a></li></ul></li><li><a href="/pages/uvrvk2/#cron-jobs" class="sidebar-link">Cron Jobs</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk2/#参考文章" class="sidebar-link">参考文章</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><!----> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>船长</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-08-25</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-1cd794fe><a href="/categories/?category=Kubernetes" data-v-1cd794fe>Kubernetes </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          Kubernetes 控制器-Job
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>Job控制器用于调配pod对象运行一次性任务，容器中的进程在正常运行结束后不会对其进行重启，而是将pod对象置于completed状态。若容器中的进程因错误而终止，则需要依据配置确定重启与否，未运行完成的pod对象因其所在的节点故障而意外终止后会被重新调度。</p> <h2 id="job-example"><a href="#job-example" class="header-anchor">#</a> Job example</h2> <p>通过如下Job 示例计算 π 到小数点后 2000 位，并将结果打印出来。 此计算大约需要 10 秒钟完成。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># vim job.yml</span>
apiVersion: batch/v1
kind: Job
metadata:
  name: pi
spec:
  template:
    spec:
      containers:
      - name: pi
        image: perl
        command: <span class="token punctuation">[</span><span class="token string">&quot;perl&quot;</span>,  <span class="token string">&quot;-Mbignum=bpi&quot;</span>, <span class="token string">&quot;-wle&quot;</span>, <span class="token string">&quot;print bpi(2000)&quot;</span><span class="token punctuation">]</span>
      restartPolicy: Never
  backoffLimit: <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>使用以下命令来创建该实例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl apply -f job.yml </span>
job.batch/pi created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用以下命令查看Job详细状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl describe jobs/pi</span>
Name:           pi
Namespace:      default
Selector:       controller-uid<span class="token operator">=</span>c4efb802-2e4a-4165-90c8-5e12422f1719
Labels:         controller-uid<span class="token operator">=</span>c4efb802-2e4a-4165-90c8-5e12422f1719
                job-name<span class="token operator">=</span>pi
Annotations:    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Parallelism:    <span class="token number">1</span>
Completions:    <span class="token number">1</span>
Start Time:     Wed, <span class="token number">25</span> Aug <span class="token number">2021</span> <span class="token number">14</span>:34:22 +0800
Pods Statuses:  <span class="token number">1</span> Running / <span class="token number">0</span> Succeeded / <span class="token number">0</span> Failed
Pod Template:
  Labels:  controller-uid<span class="token operator">=</span>c4efb802-2e4a-4165-90c8-5e12422f1719
           job-name<span class="token operator">=</span>pi
  Containers:
   pi:
    Image:      perl
    Port:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Host Port:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Command:
      perl
      -Mbignum<span class="token operator">=</span>bpi
      -wle
      print bpi<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    Environment:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
  Volumes:        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Events:
  Type    Reason            Age   From            Message
  ----    ------            ----  ----            -------
  Normal  SuccessfulCreate  7s    job-controller  Created pod: pi-wjssf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>要以机器可读的方式列举隶属于某 Job 的全部 Pods，你可以使用类似下面这条命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># pods=$(kubectl get pods --selector=job-name=pi --output=jsonpath='{.items[*].metadata.name}')</span>
<span class="token comment"># echo $pods</span>
pi-wjssf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看 Pod 的标准输出 ：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl logs $pods</span>
<span class="token number">3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275901</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="job的定义"><a href="#job的定义" class="header-anchor">#</a> Job的定义</h2> <p>与Kubernetes中其他资源的配置类似，Job也需要  <code>apiVersion</code>、<code>kind</code> 和 <code>metadata</code> 字段。 Job 的名字必须是合法的 DNS 子域名。</p> <p>Job 对象的 YAML 文件，还需要一个 <code>.spec</code> 字段。</p> <h3 id="pod-模板"><a href="#pod-模板" class="header-anchor">#</a> Pod 模板</h3> <p>Job 的 <code>.spec</code> 中只有 <code>.spec.template</code> 是必需的字段。</p> <p>字段 <code>.spec.template</code> 的值是一个 Pod 模版。 其定义规范与 Pod 完全相同，只是其中不再需要 <code>apiVersion</code> 或 <code>kind</code> 字段。</p> <p>除了作为 Pod 所必需的字段之外，Job 中的 Pod 模版必需设置合适的标签 和合适的重启策略。</p> <p>Job 中 Pod 的 <code>RestartPolicy</code>只能设置为 <code>Never</code> 或 <code>OnFailure</code> 之一</p> <h3 id="pod-选择算符"><a href="#pod-选择算符" class="header-anchor">#</a> Pod 选择算符</h3> <p>字段 <code>.spec.selector</code> 是可选的。在绝大多数场合，你都不需要为其赋值。 参阅<a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/job/#specifying-your-own-pod-selector" target="_blank" rel="noopener noreferrer">设置自己的 Pod 选择算符<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="job-的并行执行"><a href="#job-的并行执行" class="header-anchor">#</a> Job 的并行执行</h3> <p>适合以 Job 形式来运行的任务主要有三种：</p> <ol><li><p>非并行 Job：</p> <ul><li>通常只启动一个 Pod，除非该 Pod 失败。</li></ul> <ul><li>当 Pod 成功终止时，立即视 Job 为完成状态。</li></ul></li> <li><p>具有确定完成计数的并行 Job：</p> <ul><li><code>.spec.completions</code> 字段设置为非 0 的正数值。</li> <li>Job 用来代表整个任务，当成功的 Pod 个数达到 <code>.spec.completions</code> 时，Job 被视为完成。</li> <li>当使用 <code>.spec.completionMode=&quot;Indexed&quot;</code> 时，每个 Pod 都会获得一个不同的 索引值，介于 0 和 <code>.spec.completions-1</code> 之间。</li></ul></li> <li><p>带工作队列的并行 Job：</p> <ul><li>不设置 <code>spec.completions</code>，默认值为 <code>.spec.parallelism</code>。</li> <li>多个 Pod 之间必须相互协调，或者借助外部服务确定每个 Pod 要处理哪个工作条目。 例如，任一 Pod 都可以从工作队列中取走最多 N 个工作条目。</li> <li>每个 Pod 都可以独立确定是否其它 Pod 都已完成，进而确定 Job 是否完成。</li> <li>当 Job 中 <em>任何</em> Pod 成功终止，不再创建新 Pod。</li> <li>一旦至少 1 个 Pod 成功完成，并且所有 Pod 都已终止，即可宣告 Job 成功完成。</li> <li>一旦任何 Pod 成功退出，任何其它 Pod 都不应再对此任务执行任何操作或生成任何输出。 所有 Pod 都应启动退出过程。</li></ul></li></ol> <p>对于 <em>非并行</em> 的 Job，你可以不设置 <code>spec.completions</code> 和 <code>spec.parallelism</code>。 这两个属性都不设置时，均取默认值 1。</p> <p>对于 <em>确定完成计数</em> 类型的 Job，你应该设置 <code>.spec.completions</code> 为所需要的完成个数。 你可以设置 <code>.spec.parallelism</code>，也可以不设置。其默认值为 1。</p> <p>对于一个 <em>工作队列</em> Job，你不可以设置 <code>.spec.completions</code>，但要将<code>.spec.parallelism</code> 设置为一个非负整数。</p> <h3 id="控制并行性"><a href="#控制并行性" class="header-anchor">#</a> 控制并行性</h3> <p>并行性请求（<code>.spec.parallelism</code>）可以设置为任何非负整数。 如果未设置，则默认为 1。 如果设置为 0，则 Job 相当于启动之后便被暂停，直到此值被增加。</p> <p>实际并行性（在任意时刻运行状态的 Pods 个数）可能比并行性请求略大或略小， 原因如下：</p> <ul><li>对于 <em>确定完成计数</em> Job，实际上并行执行的 Pods 个数不会超出剩余的完成数。 如果 <code>.spec.parallelism</code> 值较高，会被忽略。</li> <li>对于 <em>工作队列</em> Job，有任何 Job 成功结束之后，不会有新的 Pod 启动。 不过，剩下的 Pods 允许执行完毕。</li> <li>如果 Job 没有来得及作出响应，或者</li> <li>如果 Job 控制器因为任何原因（例如，缺少 <code>ResourceQuota</code> 或者没有权限）无法创建 Pods。 Pods 个数可能比请求的数目小。</li> <li>Job 控制器可能会因为之前同一 Job 中 Pod 失效次数过多而压制新 Pod 的创建。</li> <li>当 Pod 处于体面终止进程中，需要一定时间才能停止</li></ul> <h2 id="处理-pod-和容器失效"><a href="#处理-pod-和容器失效" class="header-anchor">#</a> 处理 Pod 和容器失效</h2> <p>Pod 中的容器可能因为多种不同原因失效，例如因为其中的进程退出时返回值非零， 或者容器因为超出内存约束而被杀死等等。 如果发生这类事件，并且 <code>.spec.template.spec.restartPolicy = &quot;OnFailure&quot;</code>， Pod 则继续留在当前节点，但容器会被重新运行。 因此，你的程序需要能够处理在本地被重启的情况，或者要设置 <code>.spec.template.spec.restartPolicy = &quot;Never&quot;</code>。</p> <p>整个 Pod 也可能会失败，且原因各不相同。 例如，当 Pod 启动时，节点失效（被升级、被重启、被删除等）或者其中的容器失败而 <code>.spec.template.spec.restartPolicy = &quot;Never&quot;</code>。 当 Pod 失败时，Job 控制器会启动一个新的 Pod。 这意味着，你的应用需要处理在一个新 Pod 中被重启的情况。 尤其是应用需要处理之前运行所产生的临时文件、锁、不完整的输出等问题。</p> <p>注意，即使你将 <code>.spec.parallelism</code> 设置为 1，且将 <code>.spec.completions</code> 设置为 1，并且 <code>.spec.template.spec.restartPolicy</code> 设置为 &quot;Never&quot;，同一程序仍然有可能被启动两次。</p> <p>如果你确实将 <code>.spec.parallelism</code> 和 <code>.spec.completions</code> 都设置为比 1 大的值， 那就有可能同时出现多个 Pod 运行的情况。 为此，你的 Pod 也必须能够处理并发性问题。</p> <h3 id="pod-回退失效策略"><a href="#pod-回退失效策略" class="header-anchor">#</a> Pod 回退失效策略</h3> <p>为了实现这点，可以将 <code>.spec.backoffLimit</code> 设置为视 Job 为失败之前的重试次数。 失效回退的限制值默认为 6。 与 Job 相关的失效的 Pod 会被 Job 控制器重建，回退重试时间将会按指数增长 （从 10 秒、20 秒到 40 秒）最多至 6 分钟。 当 Job 的 Pod 被删除时，或者 Pod 成功时没有其它 Pod 处于失败状态，失效回退的次数也会被重置（为 0）。</p> <blockquote><p>如果你的 Job 的 <code>restartPolicy</code> 被设置为 &quot;OnFailure&quot;，就要注意运行该 Job 的容器 会在 Job 到达失效回退次数上限时自动被终止。 这会使得调试 Job 中可执行文件的工作变得非常棘手。 我们建议在调试 Job 时将 <code>restartPolicy</code> 设置为 &quot;Never&quot;， 或者使用日志系统来确保失效 Jobs 的输出不会意外遗失</p></blockquote> <h2 id="job-终止与清理"><a href="#job-终止与清理" class="header-anchor">#</a> Job 终止与清理</h2> <p>Job 完成时不会再创建新的 Pod，不过已有的 Pod 也不会被删除。 保留这些 Pod 使得你可以查看已完成的 Pod 的日志输出，以便检查错误、警告 或者其它诊断性输出。 Job 完成时 Job 对象也一样被保留下来，这样你就可以查看它的状态。 在查看了 Job 状态之后删除老的 Job 的操作留给了用户自己。 你可以使用 <code>kubectl</code> 来删除 Job（例如，<code>kubectl delete jobs/pi</code> 或者 <code>kubectl delete -f ./job.yaml</code>）。 当使用 <code>kubectl</code> 来删除 Job 时，该 Job 所创建的 Pods 也会被删除。</p> <p>默认情况下，Job 会持续运行，除非某个 Pod 失败（<code>restartPolicy=Never</code>） 或者某个容器出错退出（<code>restartPolicy=OnFailure</code>）。 这时，Job 基于前述的 <code>spec.backoffLimit</code> 来决定是否以及如何重试。 一旦重试次数到达 <code>.spec.backoffLimit</code> 所设的上限，Job 会被标记为失败， 其中运行的 Pods 都会被终止。</p> <p>终止 Job 的另一种方式是设置一个活跃期限。 你可以为 Job 的 <code>.spec.activeDeadlineSeconds</code> 设置一个秒数值。 该值适用于 Job 的整个生命期，无论 Job 创建了多少个 Pod。 一旦 Job 运行时间达到 <code>activeDeadlineSeconds</code> 秒，其所有运行中的 Pod 都会被终止，并且 Job 的状态更新为 <code>type: Failed</code> 及 <code>reason: DeadlineExceeded</code>。</p> <p>注意 Job 的 <code>.spec.activeDeadlineSeconds</code> 优先级高于其 <code>.spec.backoffLimit</code> 设置。 因此，如果一个 Job 正在重试一个或多个失效的 Pod，该 Job 一旦到达 <code>activeDeadlineSeconds</code> 所设的时限即不再部署额外的 Pod，即使其重试次数还未 达到 <code>backoffLimit</code> 所设的限制。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>apiVersion: batch/v1
kind: Job
metadata:
  name: pi-with-timeout
spec:
  backoffLimit: <span class="token number">5</span>
  activeDeadlineSeconds: <span class="token number">100</span>
  template:
    spec:
      containers:
      - name: pi
        image: perl
        command: <span class="token punctuation">[</span><span class="token string">&quot;perl&quot;</span>,  <span class="token string">&quot;-Mbignum=bpi&quot;</span>, <span class="token string">&quot;-wle&quot;</span>, <span class="token string">&quot;print bpi(2000)&quot;</span><span class="token punctuation">]</span>
      restartPolicy: Never
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p><code>restartPolicy</code> 对应的是 Pod，而不是 Job 本身： 一旦 Job 状态变为 <code>type: Failed</code>，就不会再发生 Job 重启的动作。 换言之，由 <code>.spec.activeDeadlineSeconds</code> 和 <code>.spec.backoffLimit</code> 所触发的 Job 终结机制 都会导致 Job 永久性的失败，而这类状态都需要手工干预才能解决。</p></blockquote> <h3 id="自动清理完成的-job"><a href="#自动清理完成的-job" class="header-anchor">#</a> 自动清理完成的 Job</h3> <p>完成的 Job 通常不需要留存在系统中。在系统中一直保留它们会给 API 服务器带来额外的压力。 如果 Job 由某种更高级别的控制器来管理，例如 CronJobs， 则 Job 可以被 CronJob 基于特定的根据容量裁定的清理策略清理掉。</p> <p>自动清理已完成 Job （状态为 <code>Complete</code> 或 <code>Failed</code>）的另一种方式是使用由 TTL 控制器所提供 的 TTL 机制。 通过设置 Job 的 <code>.spec.ttlSecondsAfterFinished</code> 字段，可以让该控制器清理掉 已结束的资源。</p> <p>TTL 控制器清理 Job 时，会级联式地删除 Job 对象。 换言之，它会删除所有依赖的对象，包括 Pod 及 Job 本身。 注意，当 Job 被删除时，系统会考虑其生命周期保障，例如其 Finalizers。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>apiVersion: batch/v1
kind: Job
metadata:
  name: pi-with-ttl
spec:
  ttlSecondsAfterFinished: <span class="token number">100</span>
  template:
    spec:
      containers:
      - name: pi
        image: perl
        command: <span class="token punctuation">[</span><span class="token string">&quot;perl&quot;</span>,  <span class="token string">&quot;-Mbignum=bpi&quot;</span>, <span class="token string">&quot;-wle&quot;</span>, <span class="token string">&quot;print bpi(2000)&quot;</span><span class="token punctuation">]</span>
      restartPolicy: Never
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Job <code>pi-with-ttl</code> 在结束 100 秒之后，可以成为被自动删除的对象。</p> <p>如果该字段设置为 <code>0</code>，Job 在结束之后立即成为可被自动删除的对象。 如果该字段没有设置，Job 不会在结束之后被 TTL 控制器自动清除。</p> <h2 id="job-模式"><a href="#job-模式" class="header-anchor">#</a> Job 模式</h2> <p>Kubernetes Job 对象可以用来支持 Pod 的并发执行，但是：</p> <ul><li>Job 对象并非设计为支持需要紧密相互通信的Pod的并发执行，例如科学计算</li> <li>Job 对象不支持并发处理一系列相互独立但是又相互关联的工作任务，例如：
<ul><li>发送邮件</li> <li>渲染页面</li> <li>转码文件</li> <li>扫描 NoSQL 数据库中的主键</li> <li>其他</li></ul></li></ul> <p>在一个复杂的系统中，可能存在多种类型的工作任务，本文只考虑批处理任务（batch job）。</p> <p>对于批处理任务的并行计算，存在着几种模式，它们各自有自己的优缺点：</p> <ul><li>每个工作任务一个 Job 对象 v.s. 一个 Job 对象负责所有的工作任务
<ul><li>当工作任务特别多时，第二种选择（一个 Job 对象负责所有的工作任务）更合适一些</li> <li>第一种选择（每个工作任务一个 Job 对象）将为管理员和系统带来很大的额外开销，因为要管理很多数量的 Job 对象</li></ul></li> <li>Pod的数量与工作任务的数量相等 v.s. 每个Pod可以处理多个工作任务
<ul><li>第一种选择（Pod的数量与工作任务的数量相等）通常只需要对现有的代码或容器做少量的修改</li> <li>第二种选择（每个Pod可以处理多个工作任务）更适合工作任务的数量特别多的情况，相较于第一种选择可以降低系统开销</li></ul></li> <li>使用工作队列，此时：
<ul><li>需要运行一个队列服务</li> <li>需要对已有的程序或者容器做修改，以便其可以配合队列工作</li> <li>如果是一个已有的程序，改造时可能存在难度</li></ul></li></ul> <p>他们的优缺点归纳如下表所示，其中第二列到第四列罗列了主要考虑的对比因素：</p> <table><thead><tr><th>模式</th> <th style="text-align:center;">单个 Job 对象</th> <th style="text-align:center;">Pods 数少于工作条目数？</th> <th style="text-align:center;">直接使用应用无需修改?</th></tr></thead> <tbody><tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/coarse-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">每工作条目一 Pod 的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">✓</td> <td style="text-align:center;"></td> <td style="text-align:center;">有时</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/fine-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">Pod 数量可变的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">✓</td> <td style="text-align:center;">✓</td> <td style="text-align:center;"></td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/indexed-parallel-processing-static" target="_blank" rel="noopener noreferrer">静态任务分派的带索引的 Job<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">✓</td> <td style="text-align:center;"></td> <td style="text-align:center;">✓</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/parallel-processing-expansion/" target="_blank" rel="noopener noreferrer">Job 模版扩展<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;">✓</td></tr></tbody></table> <p>当你使用 <code>.spec.completions</code> 来设置完成数时，Job 控制器所创建的每个 Pod 使用完全相同的 <a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener noreferrer"><code>spec</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 这意味着任务的所有 Pod 都有相同的命令行，都使用相同的镜像和数据卷，甚至连 环境变量都（几乎）相同。 这些模式是让每个 Pod 执行不同工作的几种不同形式。</p> <p>下表显示的是每种模式下 <code>.spec.parallelism</code> 和 <code>.spec.completions</code> 所需要的设置。 其中，<code>W</code> 表示的是工作条目的个数。</p> <table><thead><tr><th>模式</th> <th style="text-align:center;"><code>.spec.completions</code></th> <th style="text-align:center;"><code>.spec.parallelism</code></th></tr></thead> <tbody><tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/coarse-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">每工作条目一 Pod 的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">W</td> <td style="text-align:center;">任意值</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/fine-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">Pod 个数可变的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">1</td> <td style="text-align:center;">任意值</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/indexed-parallel-processing-static" target="_blank" rel="noopener noreferrer">静态任务分派的带索引的 Job<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">W</td> <td style="text-align:center;"></td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/parallel-processing-expansion/" target="_blank" rel="noopener noreferrer">Job 模版扩展<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">1</td> <td style="text-align:center;">应该为 1</td></tr></tbody></table> <h2 id="job的特殊操作"><a href="#job的特殊操作" class="header-anchor">#</a> Job的特殊操作</h2> <p>在创建 Job 时，系统默认将为其指定一个 <code>.spec.selector</code> 的取值，并确保其不会与任何其他 Job 重叠。</p> <p>在少数情况下，您仍然可能需要覆盖这个自动设置 <code>.spec.selector</code> 的取值。在做此项操作时，您必须十分小心：</p> <ul><li><p>如果指定的.spec.selector</p> <p>不能确定性的标识出该 Job 的 Pod，并可能选中无关的 Pod （例如，selector 可能选中其他控制器创建的 Pod），则：</p> <ul><li>与该 Job 不相关的 Pod 可能被删除</li> <li>该 Job 可能将不相关的 Pod 纳入到 <code>.spec.completions</code> 的计数</li> <li>一个或多个 Job 可能不能够创建 Pod，或者不能够正常结束</li></ul></li> <li><p>如果指定的 <code>.spec.selector</code> 不是唯一的，则其他控制器（例如，Deployment、StatefulSet 等）及其 Pod 的行为也将难以预测</p></li></ul> <p>在 Kubernetes 中，系统并不能帮助你避免此类型的错误，您需要自己关注所指定的 <code>.spec.selector</code> 的取值是否合理。</p> <p>让我们来看一个实际使用 <code>.spec.selector</code> 的例子：假设 Job <code>old</code> 已经运行，您希望已经创建的 Pod 继续运行，但是您又想要修改该 Job 的 名字，同时想要使该 Job 新建的 Pod 使用新的 template。此时您不能够修改已有的 Job 对象，因为这些字段都是不可修改的。此时，您可以执行命令 <code>kubectl delete jobs/old --cascade=false</code>，以删除 Job <code>old</code> 但是保留其创建的 Pod。</p> <ul><li>在删除之前，先记录 Job <code>old</code> 的 selector，执行命令：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get job old -o yaml

输出结果：
kind: Job
metadata:
  name: old
  <span class="token punctuation">..</span>.
spec:
  selector:
    matchLabels:
      controller-uid: a8f3d00d-c6d2-11e5-9f87-42010af00002
  <span class="token punctuation">..</span>.

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>创建新的 Job <code>new</code>，并使用已有的 selector。由于已创建的 Pod 带有标签 <code>controller-uid=a8f3d00d-c6d2-11e5-9f87-42010af00002</code>，这些 Pod 也将被新的 Job <code>new</code> 所管理。使用类似如下的 yaml 文件创建 Job <code>new</code>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kind: Job
metadata:
  name: new
  <span class="token punctuation">..</span>.
spec:
  manualSelector: <span class="token boolean">true</span>
  selector:
    matchLabels:
      controller-uid: a8f3d00d-c6d2-11e5-9f87-42010af00002
      
  <span class="token punctuation">..</span>.

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><ul><li>当您不使用系统自动创建的 <code>.spec.selector</code> 时，需要在 Job <code>new</code> 中指定 <code>.spec.manualSelector: true</code></li> <li>新建的 Job <code>new</code> 其 uid 将不同于 <code>a8f3d00d-c6d2-11e5-9f87-42010af00002</code>。设置 <code>.spec.manualSelector: true</code> 意味着，您知道这个设定是有意为之，系统将使用您指定的 <code>.spec.selector</code>，而不是使用 Job <code>new</code> 的 uid 作为 <code>.spec.selector</code> 的取值</li></ul></blockquote> <h2 id="job-替代方案"><a href="#job-替代方案" class="header-anchor">#</a> Job 替代方案</h2> <h3 id="裸pod"><a href="#裸pod" class="header-anchor">#</a> 裸Pod</h3> <p>当 Pod 运行所在的节点重启或者失败，Pod 会被终止并且不会被重启。 Job 会重新创建新的 Pod 来替代已终止的 Pod。 因为这个原因，我们建议你使用 Job 而不是独立的裸 Pod， 即使你的应用仅需要一个 Pod。</p> <h3 id="副本控制器"><a href="#副本控制器" class="header-anchor">#</a> 副本控制器</h3> <p>Job 与副本控制器是彼此互补的。 副本控制器管理的是那些不希望被终止的 Pod （例如，Web 服务器）， Job 管理的是那些希望被终止的 Pod（例如，批处理作业）。</p> <p>正如在 Pod 生命期中讨论的， <code>Job</code> 仅适合于 <code>restartPolicy</code> 设置为 <code>OnFailure</code> 或 <code>Never</code> 的 Pod。 注意：如果 <code>restartPolicy</code> 未设置，其默认值是 <code>Always</code>。</p> <h3 id="单个-job-启动控制器-pod"><a href="#单个-job-启动控制器-pod" class="header-anchor">#</a> 单个 Job 启动控制器 Pod</h3> <p>另一种模式是用唯一的 Job 来创建 Pod，而该 Pod 负责启动其他 Pod，因此扮演了一种 后启动 Pod 的控制器的角色。 这种模式的灵活性更高，但是有时候可能会把事情搞得很复杂，很难入门， 并且与 Kubernetes 的集成度很低。</p> <p>这种模式的实例之一是用 Job 来启动一个运行脚本的 Pod，脚本负责启动 Spark 主控制器（参见 <a href="https://github.com/kubernetes/examples/tree/main/staging/spark/README.md" target="_blank" rel="noopener noreferrer">Spark 示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）， 运行 Spark 驱动，之后完成清理工作。</p> <p>这种方法的优点之一是整个过程得到了 Job 对象的完成保障， 同时维持了对创建哪些 Pod、如何向其分派工作的完全控制能力，</p> <h2 id="cron-jobs"><a href="#cron-jobs" class="header-anchor">#</a> Cron Jobs</h2> <p>你可以使用 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/cron-jobs/" target="_blank" rel="noopener noreferrer"><code>CronJob</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 创建一个在指定时间/日期运行的 Job，类似于 UNIX 系统上的 <code>cron</code> 工具。</p> <h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <p><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/job/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/zh/docs/concepts/workloads/controllers/job/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/cf1998/kubernetes/edit/master/docs/_posts/Kubernetes/Kubernetes控制器 Job.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Kubernetes" title="标签">#Kubernetes</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/12/14, 19:42:15</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/opens1/"><div>OpenSSL 自签证书详解</div></a> <span>12-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/acme01/"><div>acme.sh免费签发SSL证书</div></a> <span>12-20</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/k8s002/"><div>平滑升级Kubernetes集群(二进制)</div></a> <span>11-28</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:995345781@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/cf1998" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2021
    <span>CloudNative Operations</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <div class="custom-html-window custom-html-window-lb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定200*200px -->
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <ins class="adsbygoogle"
          style="display:inline-block;width:200px;height:200px"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></div></div> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.787830ba.js" defer></script><script src="/assets/js/2.f3cfc96e.js" defer></script><script src="/assets/js/11.c2c674ed.js" defer></script>
  </body>
</html>