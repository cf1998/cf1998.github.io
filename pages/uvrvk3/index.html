<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>企业级高可用Kubernetes1.20.x集群(二进制) | CloudNative Operations</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="专注于云原生运维技术分享,Kubernetes,Prometheus，istio,envoy等技术文章">
    <meta name="CloudNative Operations" content="专注于云原生运维技术分享,致敬每个爱学习的你">
    <meta name="baidu-site-verification" content="code-UYHaqAD5D2">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.546f0649.css" as="style"><link rel="preload" href="/assets/js/app.f9e56d5e.js" as="script"><link rel="preload" href="/assets/js/2.f3cfc96e.js" as="script"><link rel="preload" href="/assets/js/18.8277b4ef.js" as="script"><link rel="prefetch" href="/assets/js/10.96ead027.js"><link rel="prefetch" href="/assets/js/11.29cd15ad.js"><link rel="prefetch" href="/assets/js/12.0416fa81.js"><link rel="prefetch" href="/assets/js/13.5d65f72d.js"><link rel="prefetch" href="/assets/js/14.cfc40d4c.js"><link rel="prefetch" href="/assets/js/15.a8f19ee2.js"><link rel="prefetch" href="/assets/js/16.33a07abe.js"><link rel="prefetch" href="/assets/js/17.f4c7d679.js"><link rel="prefetch" href="/assets/js/19.3343f1d1.js"><link rel="prefetch" href="/assets/js/20.7a3c1517.js"><link rel="prefetch" href="/assets/js/21.5e4704b4.js"><link rel="prefetch" href="/assets/js/22.2bd14cab.js"><link rel="prefetch" href="/assets/js/23.dcf8d006.js"><link rel="prefetch" href="/assets/js/24.d423cbe2.js"><link rel="prefetch" href="/assets/js/25.f7f962ca.js"><link rel="prefetch" href="/assets/js/26.d33e81c4.js"><link rel="prefetch" href="/assets/js/27.c34c8dbb.js"><link rel="prefetch" href="/assets/js/28.97455768.js"><link rel="prefetch" href="/assets/js/29.62bf6809.js"><link rel="prefetch" href="/assets/js/3.c40e1967.js"><link rel="prefetch" href="/assets/js/30.f6a06ce8.js"><link rel="prefetch" href="/assets/js/31.cf172abd.js"><link rel="prefetch" href="/assets/js/32.8cde09e7.js"><link rel="prefetch" href="/assets/js/33.69e0ede4.js"><link rel="prefetch" href="/assets/js/34.fb97b72f.js"><link rel="prefetch" href="/assets/js/4.523f8496.js"><link rel="prefetch" href="/assets/js/5.ab2f819c.js"><link rel="prefetch" href="/assets/js/6.6d76752c.js"><link rel="prefetch" href="/assets/js/7.0b585a2a.js"><link rel="prefetch" href="/assets/js/8.b6ccc37a.js"><link rel="prefetch" href="/assets/js/9.42fab877.js">
    <link rel="stylesheet" href="/assets/css/0.styles.546f0649.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="CloudNative Operations" class="logo"> <span class="site-name can-hide">CloudNative Operations</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/books/" class="nav-link">书籍</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div> <a href="https://github.com/cf1998/kubernetes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://kubesre.com/img/EB-logo.png"> <div class="blogger-info"><h3>船长</h3> <span>CloudNative Operations</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/books/" class="nav-link">书籍</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友链</a></div> <a href="https://github.com/cf1998/kubernetes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>企业级高可用Kubernetes1.20.x集群(二进制)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/uvrvk3/#集群环境" class="sidebar-link">集群环境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk3/#基本环境配置" class="sidebar-link">基本环境配置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk3/#基本组件安装" class="sidebar-link">基本组件安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#docker-安装" class="sidebar-link">Docker 安装</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#分发软件包" class="sidebar-link">分发软件包</a></li></ul></li><li><a href="/pages/uvrvk3/#生成证书" class="sidebar-link">生成证书</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#etcd-证书" class="sidebar-link">etcd 证书</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#apiserver证书" class="sidebar-link">apiserver证书</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#controller-manage证书" class="sidebar-link">controller-manage证书</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#scheduler证书" class="sidebar-link">scheduler证书</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#admin证书" class="sidebar-link">admin证书</a></li></ul></li><li><a href="/pages/uvrvk3/#etcd-配置" class="sidebar-link">ETCD 配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#master01" class="sidebar-link">Master01</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#master02" class="sidebar-link">Master02</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#master03" class="sidebar-link">Master03</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#启动etcd" class="sidebar-link">启动ETCD</a></li></ul></li><li><a href="/pages/uvrvk3/#高可用配置" class="sidebar-link">高可用配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#keepalived01" class="sidebar-link">keepalived01</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#keepalived02" class="sidebar-link">keepalived02</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#健康检查配置" class="sidebar-link">健康检查配置</a></li></ul></li><li><a href="/pages/uvrvk3/#kubernetes组件配置" class="sidebar-link">Kubernetes组件配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#apiserver" class="sidebar-link">apiserver</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#controllermanager" class="sidebar-link">ControllerManager</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#scheduler" class="sidebar-link">Scheduler</a></li></ul></li><li><a href="/pages/uvrvk3/#tls-bootstrapping-配置" class="sidebar-link">TLS Bootstrapping 配置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk3/#node节点配置" class="sidebar-link">Node节点配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#分发证书" class="sidebar-link">分发证书</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#kubelet-配置" class="sidebar-link">kubelet 配置</a></li><li class="sidebar-sub-header"><a href="/pages/uvrvk3/#kube-proxy-配置" class="sidebar-link">kube-proxy 配置</a></li></ul></li><li><a href="/pages/uvrvk3/#安装-calico" class="sidebar-link">安装 Calico</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk3/#安装-coredns" class="sidebar-link">安装 CoreDNS</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk3/#安装-metrics-server" class="sidebar-link">安装 Metrics Server</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/uvrvk3/#集群验证" class="sidebar-link">集群验证</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><!----> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>船长</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-11-26</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-1cd794fe><a href="/categories/?category=Kubernetes" data-v-1cd794fe>Kubernetes </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          企业级高可用Kubernetes1.20.x集群(二进制)
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><p>二进制部署Kubernetes虽然手动部署比较复杂，部署期间还可以学习很多工作原理，也利于后期维护。在企业级环境中可以编写ansible playbook自动化安装二进制kubernetes集群更方便，更高效！
在生产环境中，建议使用小版本大于5的Kubernetes版本，比如1.20.5以后的才可用于生产环境。
</p> <p><img src="https://kubesre.com/img/kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8.jpg" alt=""></p> <h2 id="集群环境"><a href="#集群环境" class="header-anchor">#</a> 集群环境</h2> <table><thead><tr><th>hostname</th> <th>IP</th> <th>OS</th> <th>software</th></tr></thead> <tbody><tr><td>k8s-master01</td> <td>192.168.1.101</td> <td>CentOS Linux release 7.5</td> <td>etcd、apiserver、scheduler、-controller-manager、kube-proxy、kubelet</td></tr> <tr><td>k8s-master02</td> <td>192.168.1.102</td> <td>CentOS Linux release 7.5</td> <td>etcd、apiserver、scheduler、-controller-manager、kube-proxy、kubelet</td></tr> <tr><td>k8s-master03</td> <td>192.168.1.103</td> <td>CentOS Linux release 7.5</td> <td>etcd、apiserver、scheduler、-controller-manager、kube-proxy、kubelet</td></tr> <tr><td>k8s-node01</td> <td>192.168.1.104</td> <td>CentOS Linux release 7.5</td> <td>kube-proxy、kubelet</td></tr> <tr><td>k8s-node02</td> <td>192.168.1.105</td> <td>CentOS Linux release 7.5</td> <td>kube-proxy、kubelet</td></tr> <tr><td>haproxy01</td> <td>192.168.1.106</td> <td>CentOS Linux release 7.5</td> <td>haproxy、keepalived</td></tr> <tr><td>haproxy02</td> <td>192.168.1.107</td> <td>CentOS Linux release 7.5</td> <td>haproxy、keepalived</td></tr> <tr><td>VIP</td> <td>192.168.1.111</td> <td>CentOS Linux release 7.5</td> <td>IPVS</td></tr></tbody></table> <h2 id="基本环境配置"><a href="#基本环境配置" class="header-anchor">#</a> 基本环境配置</h2> <p><strong>配置所有节点hosts:</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts</span>
<span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
<span class="token number">192.168</span>.1.101 k8s-master01
<span class="token number">192.168</span>.1.102 k8s-master02
<span class="token number">192.168</span>.1.103 k8s-master03
<span class="token number">192.168</span>.1.104 k8s-node01
<span class="token number">192.168</span>.1.105 k8s-node02
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>CentOS 7安装yum源如下:</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">curl</span> -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="token function">sed</span> -i -e <span class="token string">'/mirrors.cloud.aliyuncs.com/d'</span> -e <span class="token string">'/mirrors.aliyuncs.com/d'</span> /etc/yum.repos.d/CentOS-Base.repo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>必备工具安装</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token function">wget</span> jq psmisc <span class="token function">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>所有节点关闭firewalld 、dnsmasq、selinux(CentOS7需要关闭NetworkManager，CentOS8不需要)</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl disable --now firewalld 
systemctl disable --now dnsmasq
systemctl disable --now NetworkManager

setenforce <span class="token number">0</span>
<span class="token function">sed</span> -i <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux
<span class="token function">sed</span> -i <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>所有节点关闭swap分区，fstab注释swap</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>swapoff -a <span class="token operator">&amp;&amp;</span> sysctl -w vm.swappiness<span class="token operator">=</span><span class="token number">0</span>
<span class="token function">sed</span> -ri <span class="token string">'/^[^#]*swap/s@^@#@'</span> /etc/fstab
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>所有节点同步时间</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">rpm</span> -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm
yum <span class="token function">install</span> ntpdate -y

<span class="token function">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
<span class="token builtin class-name">echo</span> <span class="token string">'Asia/Shanghai'</span> <span class="token operator">&gt;</span>/etc/timezone
ntpdate time2.aliyun.com
<span class="token comment"># 加入到crontab</span>
*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>所有节点配置limit：</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">ulimit</span> -SHn <span class="token number">65535</span>

<span class="token function">vim</span> /etc/security/limits.conf
<span class="token comment"># 末尾添加如下内容</span>
* soft nofile <span class="token number">655360</span>
* hard nofile <span class="token number">131072</span>
* soft nproc <span class="token number">655350</span>
* hard nproc <span class="token number">655350</span>
* soft memlock unlimited
* hard memlock unlimited　
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作，阿里云或者AWS上需要单独一台kubectl服务器。密钥配置如下：</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ssh-keygen -t rsa</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>Master01配置免密码登录其他节点</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>所有节点安装基本工具</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token function">wget</span> jq psmisc <span class="token function">vim</span> net-tools yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>所有节点安装ipvsadm：</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> ipvsadm ipset sysstat conntrack libseccomp -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack， 4.18以下使用nf_conntrack_ipv4即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
<span class="token function">vim</span> /etc/modules-load.d/ipvs.conf 
	<span class="token comment"># 加入以下内容</span>
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip

$ systemctl <span class="token builtin class-name">enable</span> --now systemd-modules-load.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><strong>检查是否加载：</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># lsmod | grep -e ip_vs -e nf_conntrack</span>
nf_conntrack_ipv4      <span class="token number">16384</span>  <span class="token number">23</span> 
nf_defrag_ipv4         <span class="token number">16384</span>  <span class="token number">1</span> nf_conntrack_ipv4
nf_conntrack          <span class="token number">135168</span>  <span class="token number">10</span> xt_conntrack,nf_conntrack_ipv6,nf_conntrack_ipv4,nf_nat,nf_nat_ipv6,ipt_MASQUERADE,nf_nat_ipv4,xt_nat,nf_conntrack_netlink,ip_vs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>开启一些k8s集群中必须的内核参数，所有节点配置k8s内核：</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf</span>
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF</span>
sysctl --system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">reboot</span>
lsmod <span class="token operator">|</span> <span class="token function">grep</span> --color<span class="token operator">=</span>auto -e ip_vs -e nf_conntrack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="基本组件安装"><a href="#基本组件安装" class="header-anchor">#</a> 基本组件安装</h2> <p>主要安装的是集群中用到的各种组件，比如Docker-ce、Kubernetes各组件等。</p> <h3 id="docker-安装"><a href="#docker-安装" class="header-anchor">#</a> Docker 安装</h3> <p><strong>所有节点安装Docker-ce 19.03</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> docker-ce-19.03.* -y

由于新版kubelet建议使用systemd，所以可以把docker的CgroupDriver改成systemd
<span class="token function">mkdir</span> /etc/docker
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]
}
EOF</span>

所有节点设置开机自启动Docker：
systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> --now docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="分发软件包"><a href="#分发软件包" class="header-anchor">#</a> 分发软件包</h3> <p>以下操作都在master01执行:</p> <p><strong>Master01下载kubernetes安装包</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://storage.googleapis.com/kubernetes-release/release/v1.20.13/kubernetes-server-linux-amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>下载etcd安装包</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>解压kubernetes安装文件</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>解压etcd安装文件</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  tar -zxvf etcd-v3.4.13-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.4.13-linux-amd64/etcd{,ctl}</span>
版本查看
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubelet --version</span>
Kubernetes v1.20.13
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># etcdctl version</span>
etcdctl version: <span class="token number">3.4</span>.13
API version: <span class="token number">3.4</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>将组件发送到其他节点</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">MasterNodes</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03'</span>
<span class="token assign-left variable">WorkNodes</span><span class="token operator">=</span><span class="token string">'k8s-node01 k8s-node02'</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$MasterNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$NODE</span><span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/etcd* <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$WorkNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span>     <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/ <span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>所有节点创建/opt/cni/bin目录</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /opt/cni/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="生成证书"><a href="#生成证书" class="header-anchor">#</a> 生成证书</h2> <p>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</p> <p><strong>Master01下载生成证书工具</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> <span class="token string">&quot;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&quot;</span> -O /usr/local/bin/cfssl
<span class="token function">wget</span> <span class="token string">&quot;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&quot;</span> -O /usr/local/bin/cfssljson
<span class="token function">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="etcd-证书"><a href="#etcd-证书" class="header-anchor">#</a> etcd 证书</h3> <p><strong>所有Master节点创建etcd证书目录</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> /etc/etcd/ssl -p
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>所有节点创建kubernetes相关目录</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /etc/kubernetes/pki
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>Master01节点生成etcd证书</strong></p> <p>生成证书的CSR文件：证书签名请求文件，配置了一些域名、公司、单位</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/pki</span>

<span class="token comment"># 生成etcd CA证书和CA证书的key</span>
cfssl gencert -initca etcd-ca-csr.json <span class="token operator">|</span> cfssljson -bare /etc/etcd/ssl/etcd-ca


cfssl gencert <span class="token punctuation">\</span>
   -ca<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class="token punctuation">\</span>
   -config<span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   -hostname<span class="token operator">=</span><span class="token number">127.0</span>.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.101,192.168.1.102,192.168.1.103 <span class="token punctuation">\</span>
   -profile<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   etcd-csr.json <span class="token operator">|</span> cfssljson -bare /etc/etcd/ssl/etcd
   
<span class="token comment"># 执行结果</span>
<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:00 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:00 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:00 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:01 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:01 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">250230878926052708909595617022917808304837732033</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>将证书复制到其他节点</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">MasterNodes</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03'</span>
<span class="token assign-left variable">WorkNodes</span><span class="token operator">=</span><span class="token string">'k8s-node01 k8s-node02'</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$MasterNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token string">&quot;mkdir -p /etc/etcd/ssl&quot;</span>
     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/<span class="token variable">${FILE}</span>
     <span class="token keyword">done</span>
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="apiserver证书"><a href="#apiserver证书" class="header-anchor">#</a> apiserver证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat ca-csr.json </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;ca&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;876000h&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare /etc/kubernetes/pki/ca

<span class="token comment"># 10.96.0.是k8s service的网段，如果说需要更改k8s service网段，那就需要更改10.96.0.1，</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat ca-config.json </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;signing&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;876000h&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;profiles&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;kubernetes&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;usages&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;signing&quot;</span>,
            <span class="token string">&quot;key encipherment&quot;</span>,
            <span class="token string">&quot;server auth&quot;</span>,
            <span class="token string">&quot;client auth&quot;</span>
        <span class="token punctuation">]</span>,
        <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;876000h&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat apiserver-csr.json </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kube-apiserver&quot;</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># 如果不是高可用集群，192.168.1.111为Master01的IP</span>
cfssl gencert -ca<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem   -config<span class="token operator">=</span>ca-config.json   -hostname<span class="token operator">=</span><span class="token number">10.96</span>.0.1,192.168.1.111,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.1.101,192.168.1.102,192.168.1.103   -profile<span class="token operator">=</span>kubernetes   apiserver-csr.json <span class="token operator">|</span> cfssljson -bare /etc/kubernetes/pki/apiserver



</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p><strong>生成apiserver的聚合证书</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat front-proxy-ca-csr.json</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
     <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat front-proxy-client-csr.json </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;front-proxy-client&quot;</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
     <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

cfssl gencert   -initca front-proxy-ca-csr.json <span class="token operator">|</span> cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 

cfssl gencert   -ca<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   -config<span class="token operator">=</span>ca-config.json   -profile<span class="token operator">=</span>kubernetes   front-proxy-client-csr.json <span class="token operator">|</span> cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="controller-manage证书"><a href="#controller-manage证书" class="header-anchor">#</a> controller-manage证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat manager-csr.json </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-controller-manager&quot;</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-controller-manager&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

cfssl gencert <span class="token punctuation">\</span>
   -ca<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   -config<span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   -profile<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   manager-csr.json <span class="token operator">|</span> cfssljson -bare /etc/kubernetes/pki/controller-manager

<span class="token comment"># 注意，如果不是高可用集群，192.168.1,111:6443改为master01的地址</span>
<span class="token comment"># set-cluster：设置一个集群项，</span>

kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     --server<span class="token operator">=</span>https://192.168.1.111:6443 <span class="token punctuation">\</span>
     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span class="token comment"># 设置一个环境项，一个上下文</span>
kubectl config set-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
    --cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
    --user<span class="token operator">=</span>system:kube-controller-manager <span class="token punctuation">\</span>
    --kubeconfig<span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig

<span class="token comment"># set-credentials 设置一个用户项</span>

kubectl config set-credentials system:kube-controller-manager <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig


<span class="token comment"># 使用某个环境当做默认环境</span>

kubectl config use-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="scheduler证书"><a href="#scheduler证书" class="header-anchor">#</a> scheduler证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat scheduler-csr.json </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-scheduler&quot;</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-scheduler&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

cfssl gencert <span class="token punctuation">\</span>
   -ca<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   -config<span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   -profile<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   scheduler-csr.json <span class="token operator">|</span> cfssljson -bare /etc/kubernetes/pki/scheduler
   
<span class="token comment"># 注意，如果不是高可用集群，192.168.1.111:6443改为master01的地址</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     --server<span class="token operator">=</span>https://192.168.1.111:6443 <span class="token punctuation">\</span>
     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/scheduler.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

kubectl config set-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     --cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
     --user<span class="token operator">=</span>system:kube-scheduler <span class="token punctuation">\</span>
     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig


kubectl config use-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="admin证书"><a href="#admin证书" class="header-anchor">#</a> admin证书</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat admin-csr.json </span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;admin&quot;</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

cfssl gencert <span class="token punctuation">\</span>
   -ca<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   -config<span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   -profile<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   admin-csr.json <span class="token operator">|</span> cfssljson -bare /etc/kubernetes/pki/admin
   
<span class="token comment"># 注意，如果不是高可用集群，192.168.1.111:6443改为master01的地址</span>
kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     --server<span class="token operator">=</span>https://192.168.1.111:6443     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
kubectl config set-credentials kubernetes-admin     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/admin.pem     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/admin-key.pem     --embed-certs<span class="token operator">=</span>true     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig


kubectl config set-context kubernetes-admin@kubernetes     --cluster<span class="token operator">=</span>kubernetes     --user<span class="token operator">=</span>kubernetes-admin     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig


kubectl config use-context kubernetes-admin@kubernetes     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><strong>创建ServiceAccount Key secret</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl genrsa -out /etc/kubernetes/pki/sa.key <span class="token number">2048</span>

返回结果
Generating RSA private key, <span class="token number">2048</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span>

openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>发送证书至其他节点</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /etc/kubernetes/pki <span class="token operator">|</span> <span class="token function">grep</span> -v etcd<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token function">scp</span> /etc/kubernetes/pki/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/pki/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>
<span class="token keyword">done</span><span class="token punctuation">;</span> 
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token function">scp</span> /etc/kubernetes/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>
<span class="token keyword">done</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># ll /etc/kubernetes/pki/</span>
total <span class="token number">92</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1025</span> Nov <span class="token number">26</span> <span class="token number">10</span>:52 admin.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:52 admin-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1444</span> Nov <span class="token number">26</span> <span class="token number">10</span>:52 admin.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1029</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 apiserver.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 apiserver-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1692</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 apiserver.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1025</span> Nov <span class="token number">26</span> <span class="token number">10</span>:47 ca.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:47 ca-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1411</span> Nov <span class="token number">26</span> <span class="token number">10</span>:47 ca.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1082</span> Nov <span class="token number">26</span> <span class="token number">10</span>:50 controller-manager.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> Nov <span class="token number">26</span> <span class="token number">10</span>:50 controller-manager-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1501</span> Nov <span class="token number">26</span> <span class="token number">10</span>:50 controller-manager.pem
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">891</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-ca.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-ca-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1143</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-ca.pem
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">903</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-client.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-client-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1188</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-client.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:53 sa.key
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">451</span> Nov <span class="token number">26</span> <span class="token number">10</span>:53 sa.pub
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1058</span> Nov <span class="token number">26</span> <span class="token number">10</span>:51 scheduler.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:51 scheduler-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1476</span> Nov <span class="token number">26</span> <span class="token number">10</span>:51 scheduler.pem
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># ls /etc/kubernetes/pki/ |wc -l</span>
<span class="token number">23</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="etcd-配置"><a href="#etcd-配置" class="header-anchor">#</a> ETCD 配置</h2> <p>etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</p> <h3 id="master01"><a href="#master01" class="header-anchor">#</a> Master01</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/etcd/etcd.config.yml
name: <span class="token string">'k8s-master01'</span>
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: <span class="token number">5000</span>
heartbeat-interval: <span class="token number">100</span>
election-timeout: <span class="token number">1000</span>
quota-backend-bytes: <span class="token number">0</span>
listen-peer-urls: <span class="token string">'https://192.168.1.101:2380'</span>
listen-client-urls: <span class="token string">'https://192.168.1.101:2379,http://127.0.0.1:2379'</span>
max-snapshots: <span class="token number">3</span>
max-wals: <span class="token number">5</span>
cors:
initial-advertise-peer-urls: <span class="token string">'https://192.168.1.101:2380'</span>
advertise-client-urls: <span class="token string">'https://192.168.1.101:2379'</span>
discovery:
discovery-fallback: <span class="token string">'proxy'</span>
discovery-proxy:
discovery-srv:
initial-cluster: <span class="token string">'k8s-master01=https://192.168.1.101:2380,k8s-master02=https://192.168.1.102:2380,k8s-master03=https://192.168.1.103:2380'</span>
initial-cluster-token: <span class="token string">'etcd-k8s-cluster'</span>
initial-cluster-state: <span class="token string">'new'</span>
strict-reconfig-check: <span class="token boolean">false</span>
enable-v2: <span class="token boolean">true</span>
enable-pprof: <span class="token boolean">true</span>
proxy: <span class="token string">'off'</span>
proxy-failure-wait: <span class="token number">5000</span>
proxy-refresh-interval: <span class="token number">30000</span>
proxy-dial-timeout: <span class="token number">1000</span>
proxy-write-timeout: <span class="token number">5000</span>
proxy-read-timeout: <span class="token number">0</span>
client-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
peer-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  peer-client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
debug: <span class="token boolean">false</span>
log-package-levels:
log-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
force-new-cluster: <span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="master02"><a href="#master02" class="header-anchor">#</a> Master02</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/etcd/etcd.config.yml
name: <span class="token string">'k8s-master02'</span>
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: <span class="token number">5000</span>
heartbeat-interval: <span class="token number">100</span>
election-timeout: <span class="token number">1000</span>
quota-backend-bytes: <span class="token number">0</span>
listen-peer-urls: <span class="token string">'https://192.168.1.102:2380'</span>
listen-client-urls: <span class="token string">'https://192.168.1.102:2379,http://127.0.0.1:2379'</span>
max-snapshots: <span class="token number">3</span>
max-wals: <span class="token number">5</span>
cors:
initial-advertise-peer-urls: <span class="token string">'https://192.168.1.102:2380'</span>
advertise-client-urls: <span class="token string">'https://192.168.1.102:2379'</span>
discovery:
discovery-fallback: <span class="token string">'proxy'</span>
discovery-proxy:
discovery-srv:
initial-cluster: <span class="token string">'k8s-master01=https://192.168.1.101:2380,k8s-master02=https://192.168.1.102:2380,k8s-master03=https://192.168.1.103:2380'</span>
initial-cluster-token: <span class="token string">'etcd-k8s-cluster'</span>
initial-cluster-state: <span class="token string">'new'</span>
strict-reconfig-check: <span class="token boolean">false</span>
enable-v2: <span class="token boolean">true</span>
enable-pprof: <span class="token boolean">true</span>
proxy: <span class="token string">'off'</span>
proxy-failure-wait: <span class="token number">5000</span>
proxy-refresh-interval: <span class="token number">30000</span>
proxy-dial-timeout: <span class="token number">1000</span>
proxy-write-timeout: <span class="token number">5000</span>
proxy-read-timeout: <span class="token number">0</span>
client-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
peer-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  peer-client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
debug: <span class="token boolean">false</span>
log-package-levels:
log-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
force-new-cluster: <span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="master03"><a href="#master03" class="header-anchor">#</a> Master03</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/etcd/etcd.config.yml
name: <span class="token string">'k8s-master03'</span>
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: <span class="token number">5000</span>
heartbeat-interval: <span class="token number">100</span>
election-timeout: <span class="token number">1000</span>
quota-backend-bytes: <span class="token number">0</span>
listen-peer-urls: <span class="token string">'https://192.168.1.103:2380'</span>
listen-client-urls: <span class="token string">'https://192.168.1.103:2379,http://127.0.0.1:2379'</span>
max-snapshots: <span class="token number">3</span>
max-wals: <span class="token number">5</span>
cors:
initial-advertise-peer-urls: <span class="token string">'https://192.168.1.103:2380'</span>
advertise-client-urls: <span class="token string">'https://192.168.1.103:2379'</span>
discovery:
discovery-fallback: <span class="token string">'proxy'</span>
discovery-proxy:
discovery-srv:
initial-cluster: <span class="token string">'k8s-master01=https://192.168.1.101:2380,k8s-master02=https://192.168.1.102:2380,k8s-master03=https://192.168.1.103:2380'</span>
initial-cluster-token: <span class="token string">'etcd-k8s-cluster'</span>
initial-cluster-state: <span class="token string">'new'</span>
strict-reconfig-check: <span class="token boolean">false</span>
enable-v2: <span class="token boolean">true</span>
enable-pprof: <span class="token boolean">true</span>
proxy: <span class="token string">'off'</span>
proxy-failure-wait: <span class="token number">5000</span>
proxy-refresh-interval: <span class="token number">30000</span>
proxy-dial-timeout: <span class="token number">1000</span>
proxy-write-timeout: <span class="token number">5000</span>
proxy-read-timeout: <span class="token number">0</span>
client-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
peer-transport-security:
  cert-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  peer-client-cert-auth: <span class="token boolean">true</span>
  trusted-ca-file: <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  auto-tls: <span class="token boolean">true</span>
debug: <span class="token boolean">false</span>
log-package-levels:
log-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
force-new-cluster: <span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="启动etcd"><a href="#启动etcd" class="header-anchor">#</a> 启动ETCD</h3> <p><strong>所有Master节点创建etcd service并启动</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/etcd.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Etcd Service
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://coreos.com/etcd/docs/latest/
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/etcd --config-file<span class="token operator">=</span>/etc/etcd/etcd.config.yml
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
<span class="token assign-left variable">Alias</span><span class="token operator">=</span>etcd3.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>所有Master节点创建etcd的证书目录</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> /etc/kubernetes/pki/etcd
<span class="token function">ln</span> -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> --now etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>查看etcd状态</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span>
etcdctl --endpoints<span class="token operator">=</span><span class="token string">&quot;192.168.1.101:2379,192.168.1.102:2379,192.168.1.103:2379&quot;</span> --cacert<span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem --cert<span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd.pem --key<span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span class="token operator">=</span>table
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="高可用配置"><a href="#高可用配置" class="header-anchor">#</a> 高可用配置</h2> <p><strong>所有haproxy节点安装keepalived和haproxy</strong>·</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token function">install</span> keepalived haproxy -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有haproxy配置HAProxy，配置一样</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/haproxy/haproxy.cfg 
global
  maxconn  <span class="token number">2000</span>
  ulimit-n  <span class="token number">16384</span>
  log  <span class="token number">127.0</span>.0.1 local0 err
  stats <span class="token function">timeout</span> 30s

defaults
  log global
  mode  http
  option  httplog
  <span class="token function">timeout</span> connect <span class="token number">5000</span>
  <span class="token function">timeout</span> client  <span class="token number">50000</span>
  <span class="token function">timeout</span> server  <span class="token number">50000</span>
  <span class="token function">timeout</span> http-request 15s
  <span class="token function">timeout</span> http-keep-alive 15s

frontend k8s-master
  <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:6443
  <span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1:6443
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s-master

backend k8s-master
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise <span class="token number">2</span> fall <span class="token number">2</span> slowstart 60s maxconn <span class="token number">250</span> maxqueue <span class="token number">256</span> weight <span class="token number">100</span>
  server k8s-master01    <span class="token number">192.168</span>.1.101:6443  check
  server k8s-master02    <span class="token number">192.168</span>.1.102:6443  check
  server k8s-master03    <span class="token number">192.168</span>.1.103:6443  check
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="keepalived01"><a href="#keepalived01" class="header-anchor">#</a> keepalived01</h3> <p><strong>所有Haproxy节点配置KeepAlived，配置不一样，注意区分  vim /etc/keepalived/keepalived.conf ，注意每个节点的IP和网卡（interface参数）</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived
global_defs <span class="token punctuation">{</span>
    router_id LVS_DEVEL
<span class="token punctuation">}</span>
vrrp_script chk_apiserver <span class="token punctuation">{</span>
    script <span class="token string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>
    interval <span class="token number">5</span> 
    weight -5
    fall <span class="token number">2</span>
    rise <span class="token number">1</span>
<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
    state MASTER
    interface ens33
    mcast_src_ip <span class="token number">192.168</span>.1.106
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">100</span>
    nopreempt
    advert_int <span class="token number">2</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.1.111
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>
      chk_apiserver 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="keepalived02"><a href="#keepalived02" class="header-anchor">#</a> keepalived02</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived
global_defs <span class="token punctuation">{</span>
    router_id LVS_DEVEL
<span class="token punctuation">}</span>
vrrp_script chk_apiserver <span class="token punctuation">{</span>
    script <span class="token string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>
    interval <span class="token number">5</span> 
    weight -5
    fall <span class="token number">2</span>
    rise <span class="token number">1</span>
 
<span class="token punctuation">}</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP
    interface ens33
    mcast_src_ip <span class="token number">192.168</span>.1.107
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">90</span>
    nopreempt
    advert_int <span class="token number">2</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.1.111
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>
      chk_apiserver 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="健康检查配置"><a href="#健康检查配置" class="header-anchor">#</a> 健康检查配置</h3> <p>所有haproxy节点</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> /etc/keepalived/check_apiserver.sh 

<span class="token comment">#!/bin/bash</span>

<span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">k</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">3</span><span class="token variable">)</span></span>
<span class="token keyword">do</span>
    <span class="token assign-left variable">check_code</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>pgrep haproxy<span class="token variable">)</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$check_code</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">expr</span> $err + <span class="token number">1</span><span class="token variable">)</span></span>
        <span class="token function">sleep</span> <span class="token number">1</span>
        <span class="token builtin class-name">continue</span>
    <span class="token keyword">else</span>
        <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token number">0</span>
        <span class="token builtin class-name">break</span>
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$err</span> <span class="token operator">!=</span> <span class="token string">&quot;0&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;systemctl stop keepalived&quot;</span>
    /usr/bin/systemctl stop keepalived
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>

<span class="token function">chmod</span> +x /etc/keepalived/check_apiserver.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>所有master节点启动haproxy和keepalived</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@haproxy01 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@haproxy02 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@haproxy01 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now haproxy</span>
<span class="token punctuation">[</span>roothaproxy02 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now keepalived</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="kubernetes组件配置"><a href="#kubernetes组件配置" class="header-anchor">#</a> Kubernetes组件配置</h2> <p><strong>所有节点创建相关目录</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="apiserver"><a href="#apiserver" class="header-anchor">#</a> apiserver</h3> <p><strong>注意使用的k8s service网段为10.96.0.0/12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改</strong></p> <h4 id="master01-配置"><a href="#master01-配置" class="header-anchor">#</a> Master01 配置</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span>

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\</span>
      --v<span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\</span>
      --logtostderr<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\</span>
      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\</span>
      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\</span>
      --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.111 <span class="token punctuation">\</span>
      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\</span>
      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\</span>
      --etcd-servers<span class="token operator">=</span>https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.102:2379 <span class="token punctuation">\</span>
      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\</span>
      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\</span>
      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\</span>
      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\</span>
      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\</span>
      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\</span>
      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\</span>
      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\</span>
      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\</span>
      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\</span>
      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\</span>
      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\</span>
      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\</span>
      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\</span>
      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\</span>
      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\</span>
      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="master01-配置-2"><a href="#master01-配置-2" class="header-anchor">#</a> Master01 配置</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master02 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span>

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\</span>
      --v<span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\</span>
      --logtostderr<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\</span>
      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\</span>
      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\</span>
      --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.111 <span class="token punctuation">\</span>
      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\</span>
      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\</span>
      --etcd-servers<span class="token operator">=</span>https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 <span class="token punctuation">\</span>
      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\</span>
      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\</span>
      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\</span>
      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\</span>
      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\</span>
      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\</span>
      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\</span>
      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\</span>
      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\</span>
      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\</span>
      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\</span>
      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\</span>
      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\</span>
      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\</span>
      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\</span>
      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\</span>
      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="master03-配置"><a href="#master03-配置" class="header-anchor">#</a> Master03 配置</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master03 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span>

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\</span>
      --v<span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\</span>
      --logtostderr<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\</span>
      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\</span>
      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\</span>
      --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.111 <span class="token punctuation">\</span>
      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\</span>
      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\</span>
      --etcd-servers<span class="token operator">=</span>https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 <span class="token punctuation">\</span>
      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\</span>
      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\</span>
      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\</span>
      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\</span>
      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\</span>
      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\</span>
      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\</span>
      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\</span>
      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\</span>
      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\</span>
      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\</span>
      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\</span>
      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\</span>
      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\</span>
      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\</span>
      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\</span>
      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\</span>
      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\</span>
      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="启动-apiserver"><a href="#启动-apiserver" class="header-anchor">#</a> 启动 apiserver</h4> <p><strong>所有Master节点开启kube-apiserver</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> --now kube-apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>检测kube-server状态</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status kube-apiserver</span>
● kube-apiserver.service - Kubernetes API Server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kube-apiserver.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Fri <span class="token number">2021</span>-11-26 <span class="token number">11</span>:41:28 CST<span class="token punctuation">;</span> 12h ago
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: <span class="token number">2439</span> <span class="token punctuation">(</span>kube-apiserver<span class="token punctuation">)</span>
    Tasks: <span class="token number">9</span>
   Memory: <span class="token number">335</span>.2M
   CGroup: /system.slice/kube-apiserver.service
           └─2439 /usr/local/bin/kube-apiserver --v<span class="token operator">=</span><span class="token number">2</span> --logtostderr<span class="token operator">=</span>true --allow-privileged<span class="token operator">=</span>true --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0 --secure-port<span class="token operator">=</span><span class="token number">6443</span> --insecure-port<span class="token operator">=</span><span class="token number">0</span> --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.101 --service<span class="token punctuation">..</span>.

Nov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.215694    <span class="token number">2439</span> clientconn.go:948<span class="token punctuation">]</span> ClientConn switching balancer to <span class="token string">&quot;pick_first&quot;</span>
Nov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.215982    <span class="token number">2439</span> balancer_conn_wrappers.go:78<span class="token punctuation">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc00b661800, <span class="token punctuation">{</span>CONNECTING <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span><span class="token punctuation">}</span>
Nov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.230245    <span class="token number">2439</span> balancer_conn_wrappers.go:78<span class="token punctuation">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc00b661800, <span class="token punctuation">{</span>READY <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span><span class="token punctuation">}</span>
Nov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.232556    <span class="token number">2439</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="controllermanager"><a href="#controllermanager" class="header-anchor">#</a> ControllerManager</h3> <p>所有Master节点配置kube-controller-manager service</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-controller-manager.service</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Controller Manager
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-controller-manager <span class="token punctuation">\</span>
      --v<span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span>
      --logtostderr<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --address<span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token punctuation">\</span>
      --root-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
      --cluster-signing-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
      --cluster-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
      --service-account-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key <span class="token punctuation">\</span>
      --kubeconfig<span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class="token punctuation">\</span>
      --leader-elect<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --use-service-account-credentials<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --node-monitor-grace-period<span class="token operator">=</span>40s <span class="token punctuation">\</span>
      --node-monitor-period<span class="token operator">=</span>5s <span class="token punctuation">\</span>
      --pod-eviction-timeout<span class="token operator">=</span>2m0s <span class="token punctuation">\</span>
      --controllers<span class="token operator">=</span>*,bootstrapsigner,tokencleaner <span class="token punctuation">\</span>
      --allocate-node-cidrs<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --cluster-cidr<span class="token operator">=</span><span class="token number">172.16</span>.0.0/12 <span class="token punctuation">\</span>
      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span class="token punctuation">\</span>
      --node-cidr-mask-size<span class="token operator">=</span><span class="token number">24</span>
      
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><strong>所有Master节点启动kube-controller-manager</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now kube-controller-manager</span>
Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /usr/lib/systemd/system/kube-controller-manager.service.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>查看启动状态</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status kube-controller-manager</span>
● kube-controller-manager.service - Kubernetes Controller Manager
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kube-controller-manager.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Fri <span class="token number">2021</span>-11-26 <span class="token number">11</span>:53:20 CST<span class="token punctuation">;</span> 11h ago
     Docs: https://github.com/kubernetes/kubernetes
 Main PID: <span class="token number">2591</span> <span class="token punctuation">(</span>kube-controller<span class="token punctuation">)</span>
    Tasks: <span class="token number">6</span>
   Memory: <span class="token number">25</span>.4M
   CGroup: /system.slice/kube-controller-manager.service
           └─2591 /usr/local/bin/kube-controller-manager --v<span class="token operator">=</span><span class="token number">2</span> --logtostderr<span class="token operator">=</span>true --address<span class="token operator">=</span><span class="token number">127.0</span>.0.1 --root-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem --cluster-signing-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem -<span class="token punctuation">..</span>.

Nov <span class="token number">26</span> <span class="token number">11</span>:53:21 k8s-master01 kube-controller-manager<span class="token punctuation">[</span><span class="token number">2591</span><span class="token punctuation">]</span>: W1126 <span class="token number">11</span>:53:21.767575    <span class="token number">2591</span> authorization.go:176<span class="token punctuation">]</span> No authorization-kubeconfig provided, so SubjectAccessReview of authorizatio<span class="token punctuation">..</span>. won't work.
Nov <span class="token number">26</span> <span class="token number">11</span>:53:21 k8s-master01 kube-controller-manager<span class="token punctuation">[</span><span class="token number">2591</span><span class="token punctuation">]</span>: I1126 <span class="token number">11</span>:53:21.767606    <span class="token number">2591</span> controllermanager.go:176<span class="token punctuation">]</span> Version: v1.20.13

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> Scheduler</h3> <p><strong>所有Master节点配置kube-scheduler service</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-scheduler.service </span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Scheduler
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-scheduler <span class="token punctuation">\</span>
      --v<span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\</span>
      --logtostderr<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --address<span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token punctuation">\</span>
      --leader-elect<span class="token operator">=</span>true <span class="token punctuation">\</span>
      --kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now kube-scheduler</span>
Created symlink /etc/systemd/system/multi-user.target.wants/kube-scheduler.service → /usr/lib/systemd/system/kube-scheduler.service.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="tls-bootstrapping-配置"><a href="#tls-bootstrapping-配置" class="header-anchor">#</a> TLS Bootstrapping 配置</h2> <p><strong>在Master01创建bootstrap</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/bootstrap
kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     --server<span class="token operator">=</span>https://192.168.1.111:6443     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-credentials tls-bootstrap-token-user     --token<span class="token operator">=</span>c8ad9c.2e4d610cf3e7426e --kubeconfig<span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-context tls-bootstrap-token-user@kubernetes     --cluster<span class="token operator">=</span>kubernetes     --user<span class="token operator">=</span>tls-bootstrap-token-user     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config use-context tls-bootstrap-token-user@kubernetes     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>注意：如果要修改bootstrap.secret.yaml的token-id和token-secret，需要保证下图红圈内的字符串一致的，并且位数是一样的。还要保证上个命令的黄色字体：c8ad9c.2e4d610cf3e7426e与你修改的字符串要一致</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># cat bootstrap.secret.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>token<span class="token punctuation">-</span>c8ad9c
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">type</span><span class="token punctuation">:</span> bootstrap.kubernetes.io/token
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;The default bootstrap token generated by 'kubelet '.&quot;</span>
  <span class="token key atrule">token-id</span><span class="token punctuation">:</span> c8ad9c
  <span class="token key atrule">token-secret</span><span class="token punctuation">:</span> 2e4d610cf3e7426e
  <span class="token key atrule">usage-bootstrap-authentication</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token key atrule">usage-bootstrap-signing</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token key atrule">auth-extra-groups</span><span class="token punctuation">:</span>  system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token<span class="token punctuation">,</span>system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>worker<span class="token punctuation">,</span>system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>ingress
 
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubelet<span class="token punctuation">-</span>bootstrap
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>node<span class="token punctuation">-</span>bootstrapper
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>autoapprove<span class="token punctuation">-</span>bootstrap
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>certificates.k8s.io<span class="token punctuation">:</span>certificatesigningrequests<span class="token punctuation">:</span>nodeclient
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>autoapprove<span class="token punctuation">-</span>certificate<span class="token punctuation">-</span>rotation
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>certificates.k8s.io<span class="token punctuation">:</span>certificatesigningrequests<span class="token punctuation">:</span>selfnodeclient
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>nodes
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">rbac.authorization.kubernetes.io/autoupdate</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/bootstrapping</span><span class="token punctuation">:</span> rbac<span class="token punctuation">-</span>defaults
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>to<span class="token punctuation">-</span>kubelet
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes/proxy
      <span class="token punctuation">-</span> nodes/stats
      <span class="token punctuation">-</span> nodes/log
      <span class="token punctuation">-</span> nodes/spec
      <span class="token punctuation">-</span> nodes/metrics
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>apiserver
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>to<span class="token punctuation">-</span>kubelet
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span>
<span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># kubectl create -f bootstrap.secret.yaml </span>
secret/bootstrap-token-c8ad9c created
clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created
clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="node节点配置"><a href="#node节点配置" class="header-anchor">#</a> Node节点配置</h2> <h3 id="分发证书"><a href="#分发证书" class="header-anchor">#</a> 分发证书</h3> <p><strong>Master01节点分发证书至Node节点</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /etc/kubernetes/

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token function">mkdir</span> -p /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl
     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca.pem etcd.pem etcd-key.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/
     <span class="token keyword">done</span>
     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">scp</span> /etc/kubernetes/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span>
 <span class="token keyword">done</span>
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="kubelet-配置"><a href="#kubelet-配置" class="header-anchor">#</a> kubelet 配置</h3> <p><strong>所有节点创建相关目录</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点配置kubelet service****</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># vim  /usr/lib/systemd/system/kubelet.service</span>

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet

<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">StartLimitInterval</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">10</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>所有节点配置kubelet service的配置文件</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/systemd/system/kubelet.service.d/10-kubelet.conf
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' &quot;</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet <span class="token variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="token variable">$KUBELET_CONFIG_ARGS</span> <span class="token variable">$KUBELET_SYSTEM_ARGS</span> <span class="token variable">$KUBELET_EXTRA_ARGS</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>创建kubelet的配置文件</strong></p> <blockquote><p>注意：如果更改了k8s的service网段，需要更改kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/kubelet-conf.yml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubelet.config.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeletConfiguration
<span class="token key atrule">address</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10250</span>
<span class="token key atrule">readOnlyPort</span><span class="token punctuation">:</span> <span class="token number">10255</span>
<span class="token key atrule">authentication</span><span class="token punctuation">:</span>
  <span class="token key atrule">anonymous</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">cacheTTL</span><span class="token punctuation">:</span> 2m0s
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">x509</span><span class="token punctuation">:</span>
    <span class="token key atrule">clientCAFile</span><span class="token punctuation">:</span> /etc/kubernetes/pki/ca.pem
<span class="token key atrule">authorization</span><span class="token punctuation">:</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> Webhook
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">cacheAuthorizedTTL</span><span class="token punctuation">:</span> 5m0s
    <span class="token key atrule">cacheUnauthorizedTTL</span><span class="token punctuation">:</span> 30s
<span class="token key atrule">cgroupDriver</span><span class="token punctuation">:</span> systemd
<span class="token key atrule">cgroupsPerQOS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">clusterDNS</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> 10.96.0.10
<span class="token key atrule">clusterDomain</span><span class="token punctuation">:</span> cluster.local
<span class="token key atrule">containerLogMaxFiles</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">containerLogMaxSize</span><span class="token punctuation">:</span> 10Mi
<span class="token key atrule">contentType</span><span class="token punctuation">:</span> application/vnd.kubernetes.protobuf
<span class="token key atrule">cpuCFSQuota</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">cpuManagerPolicy</span><span class="token punctuation">:</span> none
<span class="token key atrule">cpuManagerReconcilePeriod</span><span class="token punctuation">:</span> 10s
<span class="token key atrule">enableControllerAttachDetach</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">enableDebuggingHandlers</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">enforceNodeAllocatable</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> pods
<span class="token key atrule">eventBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">eventRecordQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">evictionHard</span><span class="token punctuation">:</span>
  <span class="token key atrule">imagefs.available</span><span class="token punctuation">:</span> 15%
  <span class="token key atrule">memory.available</span><span class="token punctuation">:</span> 100Mi
  <span class="token key atrule">nodefs.available</span><span class="token punctuation">:</span> 10%
  <span class="token key atrule">nodefs.inodesFree</span><span class="token punctuation">:</span> 5%
<span class="token key atrule">evictionPressureTransitionPeriod</span><span class="token punctuation">:</span> 5m0s
<span class="token key atrule">failSwapOn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">fileCheckFrequency</span><span class="token punctuation">:</span> 20s
<span class="token key atrule">hairpinMode</span><span class="token punctuation">:</span> promiscuous<span class="token punctuation">-</span>bridge
<span class="token key atrule">healthzBindAddress</span><span class="token punctuation">:</span> 127.0.0.1
<span class="token key atrule">healthzPort</span><span class="token punctuation">:</span> <span class="token number">10248</span>
<span class="token key atrule">httpCheckFrequency</span><span class="token punctuation">:</span> 20s
<span class="token key atrule">imageGCHighThresholdPercent</span><span class="token punctuation">:</span> <span class="token number">85</span>
<span class="token key atrule">imageGCLowThresholdPercent</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token key atrule">imageMinimumGCAge</span><span class="token punctuation">:</span> 2m0s
<span class="token key atrule">iptablesDropBit</span><span class="token punctuation">:</span> <span class="token number">15</span>
<span class="token key atrule">iptablesMasqueradeBit</span><span class="token punctuation">:</span> <span class="token number">14</span>
<span class="token key atrule">kubeAPIBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">kubeAPIQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">makeIPTablesUtilChains</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">maxOpenFiles</span><span class="token punctuation">:</span> <span class="token number">1000000</span>
<span class="token key atrule">maxPods</span><span class="token punctuation">:</span> <span class="token number">110</span>
<span class="token key atrule">nodeStatusUpdateFrequency</span><span class="token punctuation">:</span> 10s
<span class="token key atrule">oomScoreAdj</span><span class="token punctuation">:</span> <span class="token number">-999</span>
<span class="token key atrule">podPidsLimit</span><span class="token punctuation">:</span> <span class="token number">-1</span>
<span class="token key atrule">registryBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">registryPullQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">resolvConf</span><span class="token punctuation">:</span> /etc/resolv.conf
<span class="token key atrule">rotateCertificates</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">runtimeRequestTimeout</span><span class="token punctuation">:</span> 2m0s
<span class="token key atrule">serializeImagePulls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">staticPodPath</span><span class="token punctuation">:</span> /etc/kubernetes/manifests
<span class="token key atrule">streamingConnectionIdleTimeout</span><span class="token punctuation">:</span> 4h0m0s
<span class="token key atrule">syncFrequency</span><span class="token punctuation">:</span> 1m0s
<span class="token key atrule">volumeStatsAggPeriod</span><span class="token punctuation">:</span> 1m0s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><strong>启动所有节点kubelet</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> --now kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>此时系统日志/var/log/messages</p> <p>Unable to update cni config: no networks found in /etc/cni/net.d 显示只有如下信息为正常</p></blockquote> <h3 id="kube-proxy-配置"><a href="#kube-proxy-配置" class="header-anchor">#</a> kube-proxy 配置</h3> <p><strong>以下操作在Master01执行</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl -n kube-system create serviceaccount kube-proxy
kubectl create clusterrolebinding system:kube-proxy         --clusterrole system:node-proxier         --serviceaccount kube-system:kube-proxy
<span class="token assign-left variable">SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl -n kube-system get sa/kube-proxy <span class="token punctuation">\</span>
    --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.secrets[0].name}'</span><span class="token variable">)</span></span>
<span class="token assign-left variable">JWT_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl -n kube-system get secret/$SECRET <span class="token punctuation">\</span>
--output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.data.token}'</span> <span class="token operator">|</span> base64 -d<span class="token variable">)</span></span>
<span class="token assign-left variable">PKI_DIR</span><span class="token operator">=</span>/etc/kubernetes/pki
<span class="token assign-left variable">K8S_DIR</span><span class="token operator">=</span>/etc/kubernetes
kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     --server<span class="token operator">=</span>https://192.168.1.111:6443     --kubeconfig<span class="token operator">=</span><span class="token variable">${K8S_DIR}</span>/kube-proxy.kubeconfig
kubectl config set-credentials kubernetes     --token<span class="token operator">=</span><span class="token variable">${JWT_TOKEN}</span>     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
kubectl config set-context kubernetes     --cluster<span class="token operator">=</span>kubernetes     --user<span class="token operator">=</span>kubernetes     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
kubectl config use-context kubernetes     --kubeconfig<span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在master01将kube-proxy的systemd Service文件发送到其他节点</p> <p>如果更改了集群Pod的网段，需要更改kube-proxy/kube-proxy.conf的clusterCIDR: 172.16.0.0/12参数为pod的网段。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master01 k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">scp</span> <span class="token variable">${K8S_DIR}</span>/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
     <span class="token function">scp</span> kube-proxy/kube-proxy.conf <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf
     <span class="token function">scp</span> kube-proxy/kube-proxy.service <span class="token variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service
 <span class="token keyword">done</span>


<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
     <span class="token function">scp</span> kube-proxy/kube-proxy.conf <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf
     <span class="token function">scp</span> kube-proxy/kube-proxy.service <span class="token variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>所有节点启动kube-proxy</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now kube-proxy</span>
Created symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /usr/lib/systemd/system/kube-proxy.service.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="安装-calico"><a href="#安装-calico" class="header-anchor">#</a> 安装 Calico</h2> <p><strong>以下步骤只在master01执行</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>$ cat calico<span class="token punctuation">-</span>etcd.yaml
<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/calico-etcd-secrets.yaml</span>
<span class="token comment"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span>
<span class="token comment"># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token comment"># Populate the following with etcd TLS configuration if desired, but leave blank if</span>
  <span class="token comment"># not using TLS for etcd.</span>
  <span class="token comment"># The keys below should be uncommented and the values populated with the base64</span>
  <span class="token comment"># encoded contents of each file that would be associated with the TLS data.</span>
  <span class="token comment"># Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0</span>
  <span class="token comment"># etcd-key: null</span>
  <span class="token comment"># etcd-cert: null</span>
  <span class="token comment"># etcd-ca: null</span>
<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/calico-config.yaml</span>
<span class="token comment"># This ConfigMap is used to configure a self-hosted Calico installation.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token comment"># Configure this with the location of your etcd cluster.</span>
  <span class="token key atrule">etcd_endpoints</span><span class="token punctuation">:</span> <span class="token string">&quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;</span>
  <span class="token comment"># If you're using TLS enabled etcd uncomment the following.</span>
  <span class="token comment"># You must also populate the Secret below with these files.</span>
  <span class="token key atrule">etcd_ca</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>   <span class="token comment"># &quot;/calico-secrets/etcd-ca&quot;</span>
  <span class="token key atrule">etcd_cert</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># &quot;/calico-secrets/etcd-cert&quot;</span>
  <span class="token key atrule">etcd_key</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>  <span class="token comment"># &quot;/calico-secrets/etcd-key&quot;</span>
  <span class="token comment"># Typha is disabled.</span>
  <span class="token key atrule">typha_service_name</span><span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span>
  <span class="token comment"># Configure the backend to use.</span>
  <span class="token key atrule">calico_backend</span><span class="token punctuation">:</span> <span class="token string">&quot;bird&quot;</span>
  <span class="token comment"># Configure the MTU to use for workload interfaces and tunnels.</span>
  <span class="token comment"># - If Wireguard is enabled, set to your network MTU - 60</span>
  <span class="token comment"># - Otherwise, if VXLAN or BPF mode is enabled, set to your network MTU - 50</span>
  <span class="token comment"># - Otherwise, if IPIP is enabled, set to your network MTU - 20</span>
  <span class="token comment"># - Otherwise, if not using any encapsulation, set to your network MTU.</span>
  <span class="token key atrule">veth_mtu</span><span class="token punctuation">:</span> <span class="token string">&quot;1440&quot;</span>

  <span class="token comment"># The CNI network configuration to install on each node. The special</span>
  <span class="token comment"># values in this config will be automatically populated.</span>
  <span class="token key atrule">cni_network_config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s-pod-network&quot;</span><span class="token punctuation">,</span>
      <span class="token key atrule">&quot;cniVersion&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;0.3.1&quot;</span><span class="token punctuation">,</span>
      <span class="token key atrule">&quot;plugins&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;calico&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;log_level&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;etcd_endpoints&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_ENDPOINTS__&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;etcd_key_file&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_KEY_FILE__&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;etcd_cert_file&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_CERT_FILE__&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;etcd_ca_cert_file&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_CA_CERT_FILE__&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;mtu&quot;</span><span class="token punctuation">:</span> __CNI_MTU__<span class="token punctuation">,</span>
          <span class="token key atrule">&quot;ipam&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;calico-ipam&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;policy&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;kubernetes&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token key atrule">&quot;kubeconfig&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__KUBECONFIG_FILEPATH__&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;portmap&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;snat&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;capabilities&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">&quot;portMappings&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bandwidth&quot;</span><span class="token punctuation">,</span>
          <span class="token key atrule">&quot;capabilities&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">&quot;bandwidth&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/calico-kube-controllers-rbac.yaml</span>

<span class="token comment"># Include a clusterrole for the kube-controllers component,</span>
<span class="token comment"># and bind it to the calico-kube-controllers serviceaccount.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># Pods are monitored for changing labels.</span>
  <span class="token comment"># The node controller monitors Kubernetes nodes.</span>
  <span class="token comment"># Namespace and serviceaccount labels are used for policy.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> namespaces
      <span class="token punctuation">-</span> serviceaccounts
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> watch
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> get
  <span class="token comment"># Watch for changes to Kubernetes NetworkPolicies.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;networking.k8s.io&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> networkpolicies
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> watch
      <span class="token punctuation">-</span> list
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>

<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/calico-node-rbac.yaml</span>
<span class="token comment"># Include a clusterrole for the calico-node DaemonSet,</span>
<span class="token comment"># and bind it to the calico-node serviceaccount.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># The CNI plugin needs to get pods, nodes, and namespaces.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> namespaces
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> endpoints
      <span class="token punctuation">-</span> services
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token comment"># Used to discover service IPs for advertisement.</span>
      <span class="token punctuation">-</span> watch
      <span class="token punctuation">-</span> list
  <span class="token comment"># Pod CIDR auto-detection on kubeadm needs access to config maps.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> configmaps
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes/status
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token comment"># Needed for clearing NodeNetworkUnavailable flag.</span>
      <span class="token punctuation">-</span> patch

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/calico-node.yaml</span>
<span class="token comment"># This manifest installs the calico-node container, as well</span>
<span class="token comment"># as the CNI plugins and network config on</span>
<span class="token comment"># each master and worker node in a Kubernetes cluster.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token comment"># Make sure calico-node gets scheduled on all nodes.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token comment"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
      <span class="token comment"># Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a &quot;force</span>
      <span class="token comment"># deletion&quot;: https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods.</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
        <span class="token comment"># This container installs the CNI binaries</span>
        <span class="token comment"># and CNI network config file on each node.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/cni<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/install-cni.sh&quot;</span><span class="token punctuation">]</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token comment"># Name of the CNI config file to create.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_CONF_NAME
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;10-calico.conflist&quot;</span>
            <span class="token comment"># The CNI network config to install on each node.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_NETWORK_CONFIG
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> cni_network_config
            <span class="token comment"># The location of the etcd cluster.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints
            <span class="token comment"># CNI MTU Config variable</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_MTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment"># Prevents the container from sleeping forever.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SLEEP
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/opt/cni/bin
              <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>bin<span class="token punctuation">-</span>dir
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/etc/cni/net.d
              <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>net<span class="token punctuation">-</span>dir
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets
              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># Adds a Flex Volume Driver that creates a per-pod Unix Domain Socket to allow Dikastes</span>
        <span class="token comment"># to communicate with Felix over the Policy Sync API.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/pod2daemon<span class="token punctuation">-</span>flexvol<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>host
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/driver
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token comment"># Runs calico-node container on each Kubernetes node. This</span>
        <span class="token comment"># container programs network policy and routes on each</span>
        <span class="token comment"># host.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/node<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token comment"># The location of the etcd cluster.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints
            <span class="token comment"># Location of the CA certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CA_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_ca
            <span class="token comment"># Location of the client key for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_KEY_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_key
            <span class="token comment"># Location of the client certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_cert
            <span class="token comment"># Set noderef for node controller.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_K8S_NODE_REF
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName
            <span class="token comment"># Choose the backend to use.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_NETWORKING_BACKEND
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> calico_backend
            <span class="token comment"># Cluster type to identify the deployment type</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CLUSTER_TYPE
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s,bgp&quot;</span>
            <span class="token comment"># Auto-detect the BGP IP address.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> IP
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;autodetect&quot;</span>
            <span class="token comment"># Enable IPIP</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_IPIP
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;Always&quot;</span>
            <span class="token comment"># Enable or Disable VXLAN on the default IP pool.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_VXLAN
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;Never&quot;</span>
            <span class="token comment"># Set MTU for tunnel device used if ipip is enabled</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_IPINIPMTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment"># Set MTU for the VXLAN tunnel device.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_VXLANMTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment"># Set MTU for the Wireguard tunnel device.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_WIREGUARDMTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span>
            <span class="token comment"># chosen from this range. Changing this value after installation will have</span>
            <span class="token comment"># no effect. This should fall within `--cluster-cidr`.</span>
            <span class="token comment"># - name: CALICO_IPV4POOL_CIDR</span>
            <span class="token comment">#   value: &quot;192.168.0.0/16&quot;</span>
            <span class="token comment"># Disable file logging so `kubectl logs` works.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_DISABLE_FILE_LOGGING
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
            <span class="token comment"># Set Felix endpoint to host default action to ACCEPT.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_DEFAULTENDPOINTTOHOSTACTION
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;ACCEPT&quot;</span>
            <span class="token comment"># Disable IPv6 on Kubernetes.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_IPV6SUPPORT
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
            <span class="token comment"># Set Felix logging to &quot;info&quot;</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_LOGSEVERITYSCREEN
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;info&quot;</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_HEALTHENABLED
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 250m
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>live
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>live
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>ready
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>ready
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /lib/modules
              <span class="token key atrule">name</span><span class="token punctuation">:</span> lib<span class="token punctuation">-</span>modules
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run/xtables.lock
              <span class="token key atrule">name</span><span class="token punctuation">:</span> xtables<span class="token punctuation">-</span>lock
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/calico
              <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>run<span class="token punctuation">-</span>calico
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/calico
              <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>lib<span class="token punctuation">-</span>calico
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets
              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> policysync
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/nodeagent
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token comment"># Used by calico-node.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lib<span class="token punctuation">-</span>modules
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /lib/modules
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>run<span class="token punctuation">-</span>calico
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/calico
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>lib<span class="token punctuation">-</span>calico
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/calico
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xtables<span class="token punctuation">-</span>lock
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run/xtables.lock
            <span class="token key atrule">type</span><span class="token punctuation">:</span> FileOrCreate
        <span class="token comment"># Used to install CNI.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>bin<span class="token punctuation">-</span>dir
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/cni/bin
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>net<span class="token punctuation">-</span>dir
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token comment"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="token comment"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">secret</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0400</span>
        <span class="token comment"># Used to create per-pod Unix Domain Sockets</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> policysync
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/nodeagent
        <span class="token comment"># Used to install Flex Volume Driver</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>host
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/libexec/kubernetes/kubelet<span class="token punctuation">-</span>plugins/volume/exec/nodeagent~uds
<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/calico-kube-controllers.yaml</span>
<span class="token comment"># See https://github.com/projectcalico/kube-controllers</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># The controllers can only have a single active instance.</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token comment"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
          <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical
      <span class="token comment"># The controllers must run in the host network namespace so that</span>
      <span class="token comment"># it isn't governed by policy that would prevent it from working.</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/kube<span class="token punctuation">-</span>controllers<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token comment"># The location of the etcd cluster.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints
            <span class="token comment"># Location of the CA certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CA_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_ca
            <span class="token comment"># Location of the client key for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_KEY_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_key
            <span class="token comment"># Location of the client certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_cert
            <span class="token comment"># Choose which controllers to run.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ENABLED_CONTROLLERS
              <span class="token key atrule">value</span><span class="token punctuation">:</span> policy<span class="token punctuation">,</span>namespace<span class="token punctuation">,</span>serviceaccount<span class="token punctuation">,</span>workloadendpoint<span class="token punctuation">,</span>node
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token comment"># Mount in the etcd TLS secrets.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets
              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /usr/bin/check<span class="token punctuation">-</span>status
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>r
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token comment"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="token comment"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">secret</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0400</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/calico-typha.yaml</span>

<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/configure-canal.yaml</span>

<span class="token punctuation">---</span>
<span class="token comment"># Source: calico/templates/kdd-crds.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br></div></div><p><strong>修改calico-etcd.yaml的以下位置</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sed</span> -i <span class="token string">'s#etcd_endpoints: &quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;#etcd_endpoints: &quot;https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379&quot;#g'</span> calico-etcd.yaml

<span class="token assign-left variable">ETCD_CA</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd-ca.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">'\n'</span><span class="token variable">`</span></span>
<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">'\n'</span><span class="token variable">`</span></span>
<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd-key.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">'\n'</span><span class="token variable">`</span></span>

<span class="token function">sed</span> -i <span class="token string">&quot;s@# etcd-key: null@etcd-key: <span class="token variable">${ETCD_KEY}</span>@g; s@# etcd-cert: null@etcd-cert: <span class="token variable">${ETCD_CERT}</span>@g; s@# etcd-ca: null@etcd-ca: <span class="token variable">${ETCD_CA}</span>@g&quot;</span> calico-etcd.yaml


<span class="token function">sed</span> -i <span class="token string">'s#etcd_ca: &quot;&quot;#etcd_ca: &quot;/calico-secrets/etcd-ca&quot;#g; s#etcd_cert: &quot;&quot;#etcd_cert: &quot;/calico-secrets/etcd-cert&quot;#g; s#etcd_key: &quot;&quot; #etcd_key: &quot;/calico-secrets/etcd-key&quot; #g'</span> calico-etcd.yaml

<span class="token comment"># 更改此处为自己的pod网段</span>
<span class="token assign-left variable">POD_SUBNET</span><span class="token operator">=</span><span class="token string">&quot;172.16.0.0/12&quot;</span>

<span class="token function">sed</span> -i <span class="token string">'s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: &quot;192.168.0.0/16&quot;@  value: '</span>&quot;<span class="token variable">${POD_SUBNET}</span>&quot;<span class="token string">'@g'</span> calico-etcd.yaml

kubectl apply -f calico-etcd.yaml

<span class="token comment"># 查看容器状态</span>
<span class="token punctuation">[</span>root@k8s-master01 calico<span class="token punctuation">]</span><span class="token comment"># kubectl  get po -n kube-system</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="安装-coredns"><a href="#安装-coredns" class="header-anchor">#</a> 安装 CoreDNS</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/coredns/deployment.git
<span class="token builtin class-name">cd</span> deployment/kubernetes
<span class="token comment"># ./deploy.sh -s -i 10.96.0.10 | kubectl apply -f -</span>
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
查看状态
 <span class="token comment"># kubectl get po -n kube-system -l k8s-app=kube-dns</span>
NAME                       READY   STATUS    RESTARTS   AGE
coredns-85b4878f78-h29kh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="安装-metrics-server"><a href="#安装-metrics-server" class="header-anchor">#</a> 安装 Metrics Server</h2> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>cat metrics<span class="token punctuation">-</span>server.yml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-admin</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-view</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>aggregated<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> metrics.k8s.io
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> nodes/stats
      <span class="token punctuation">-</span> namespaces
      <span class="token punctuation">-</span> configmaps
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>reader
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> extension<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>reader
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> https
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>dir=/tmp
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secure<span class="token punctuation">-</span>port=4443
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metric<span class="token punctuation">-</span>resolution=30s
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>tls
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>preferred<span class="token punctuation">-</span>address<span class="token punctuation">-</span>types=InternalIP<span class="token punctuation">,</span>ExternalIP<span class="token punctuation">,</span>Hostname
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/front<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ca.pem <span class="token comment"># change to front-proxy-ca.crt for kubeadm</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>username<span class="token punctuation">-</span>headers=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>User
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>group<span class="token punctuation">-</span>headers=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>Group
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>extra<span class="token punctuation">-</span>headers<span class="token punctuation">-</span>prefix=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>Extra<span class="token punctuation">-</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>v0.4.1
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /livez
              <span class="token key atrule">port</span><span class="token punctuation">:</span> https
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">4443</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> https
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /readyz
              <span class="token key atrule">port</span><span class="token punctuation">:</span> https
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
              <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>ssl
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/pki
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>ssl
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/pki
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiregistration.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> APIService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> v1beta1.metrics.k8s.io
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> metrics.k8s.io
  <span class="token key atrule">groupPriorityMinimum</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token key atrule">insecureSkipTLSVerify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1beta1
  <span class="token key atrule">versionPriority</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl  create -f metrics-server.yml
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created

<span class="token comment"># 等待metrics server启动然后查看状态</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  top node</span>
NAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%   
k8s-master01   231m         <span class="token number">5</span>%     1620Mi          <span class="token number">42</span>%       
k8s-master02   274m         <span class="token number">6</span>%     1203Mi          <span class="token number">31</span>%       
k8s-master03   202m         <span class="token number">5</span>%     1251Mi          <span class="token number">32</span>%       
k8s-node01     69m          <span class="token number">1</span>%     667Mi           <span class="token number">17</span>%       
k8s-node02     73m          <span class="token number">1</span>%     650Mi           <span class="token number">16</span>%
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="集群验证"><a href="#集群验证" class="header-anchor">#</a> 集群验证</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME           STATUS   ROLES    AGE     VERSION
k8s-master01   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   9h      v1.20.13
k8s-master02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   9h      v1.20.13
k8s-master03   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   9h      v1.20.13
k8s-node01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   6h22m   v1.20.13
k8s-node02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   6h23m   v1.20.13

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cs</span>
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>  

<span class="token comment"># 如上查看集群状态一切正常 </span>

<span class="token comment"># 接下来运行个Pod验证下</span>
cat<span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> kubectl apply -f -</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: busybox:1.28
    command:
      - sleep
      - &quot;3600&quot;
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME      READY   STATUS    RESTARTS   AGE
busybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it busybox sh</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
/ <span class="token comment"># ping www.baidu.com</span>
PING www.baidu.com <span class="token punctuation">(</span><span class="token number">180.101</span>.49.11<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">180.101</span>.49.11: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">49</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">12.058</span> ms
^C
--- www.baidu.com <span class="token function">ping</span> statistics ---
<span class="token number">2</span> packets transmitted, <span class="token number">1</span> packets received, <span class="token number">50</span>% packet loss
round-trip min/avg/max <span class="token operator">=</span> <span class="token number">12.058</span>/12.058/12.058 ms
/ <span class="token comment"># ping busybox</span>
PING busybox <span class="token punctuation">(</span><span class="token number">172.17</span>.125.1<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.125.1: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.050</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.125.1: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.062</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.125.1: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.050</span> ms
^C
--- busybox <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> packets received, <span class="token number">0</span>% packet loss
round-trip min/avg/max <span class="token operator">=</span> <span class="token number">0.050</span>/0.054/0.062 ms

<span class="token comment"># 运行Pod验证一切正常</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/cf1998/kubernetes/edit/master/docs/_posts/Kubernetes/企业级高可用Kubernetes1.20集群(二进制).md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Kubernetes" title="标签">#Kubernetes</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/k8s002/"><div>平滑升级Kubernetes集群(二进制)</div></a> <span>11-28</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/k8s001/"><div>Kubernetes 零宕机滚动更新</div></a> <span>11-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/kubes1/"><div>Kubernetes 高可用集群</div></a> <span>11-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:995345781@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/cf1998" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2021
    <span>CloudNative Operations</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-9354336437522810"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.f9e56d5e.js" defer></script><script src="/assets/js/2.f3cfc96e.js" defer></script><script src="/assets/js/18.8277b4ef.js" defer></script>
  </body>
</html>