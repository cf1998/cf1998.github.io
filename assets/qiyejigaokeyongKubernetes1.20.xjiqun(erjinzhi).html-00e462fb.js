import { _ as _export_sfc, o as openBlock, c as createElementBlock, b as createBaseVNode, d as createTextVNode, a as createStaticVNode } from "./app-b80752dd.js";
const _sfc_main = {};
const _hoisted_1 = /* @__PURE__ */ createBaseVNode(
  "h2",
  {
    id: "背景",
    tabindex: "-1"
  },
  [
    /* @__PURE__ */ createBaseVNode("a", {
      class: "header-anchor",
      href: "#背景",
      "aria-hidden": "true"
    }, "#"),
    /* @__PURE__ */ createTextVNode(" 背景")
  ],
  -1
  /* HOISTED */
);
const _hoisted_2 = /* @__PURE__ */ createBaseVNode(
  "div",
  { class: "custom-container info" },
  [
    /* @__PURE__ */ createBaseVNode("svg", {
      xmlns: "http://www.w3.org/2000/svg",
      "xmlns:xlink": "http://www.w3.org/1999/xlink",
      viewBox: "0 0 24 24"
    }, [
      /* @__PURE__ */ createBaseVNode("g", {
        fill: "none",
        stroke: "currentColor",
        "stroke-width": "2",
        "stroke-linecap": "round",
        "stroke-linejoin": "round"
      }, [
        /* @__PURE__ */ createBaseVNode("circle", {
          cx: "12",
          cy: "12",
          r: "9"
        }),
        /* @__PURE__ */ createBaseVNode("path", { d: "M12 8h.01" }),
        /* @__PURE__ */ createBaseVNode("path", { d: "M11 12h1v4h1" })
      ])
    ]),
    /* @__PURE__ */ createBaseVNode("p", { class: "custom-container-title" }, "INFO"),
    /* @__PURE__ */ createBaseVNode("p", null, "二进制部署Kubernetes虽然手动部署比较复杂，部署期间还可以学习很多工作原理，也利于后期维护。在企业级环境中可以编写ansible playbook自动化安装二进制kubernetes集群更方便，更高效！ 在生产环境中，建议使用小版本大于5的Kubernetes版本，比如1.20.5以后的才可用于生产环境。")
  ],
  -1
  /* HOISTED */
);
const _hoisted_3 = /* @__PURE__ */ createStaticVNode('<p><img src="https://img.kubesre.com/img/kubernetes高可用.jpg" alt=""></p><h2 id="集群环境" tabindex="-1"><a class="header-anchor" href="#集群环境" aria-hidden="true">#</a> 集群环境</h2><table><thead><tr><th>hostname</th><th>IP</th><th>OS</th><th>software</th></tr></thead><tbody><tr><td>k8s-master01</td><td>192.168.1.101</td><td>CentOS Linux release 7.5</td><td>etcd、apiserver、scheduler、-controller-manager、kube-proxy、kubelet</td></tr><tr><td>k8s-master02</td><td>192.168.1.102</td><td>CentOS Linux release 7.5</td><td>etcd、apiserver、scheduler、-controller-manager、kube-proxy、kubelet</td></tr><tr><td>k8s-master03</td><td>192.168.1.103</td><td>CentOS Linux release 7.5</td><td>etcd、apiserver、scheduler、-controller-manager、kube-proxy、kubelet</td></tr><tr><td>k8s-node01</td><td>192.168.1.104</td><td>CentOS Linux release 7.5</td><td>kube-proxy、kubelet</td></tr><tr><td>k8s-node02</td><td>192.168.1.105</td><td>CentOS Linux release 7.5</td><td>kube-proxy、kubelet</td></tr><tr><td>haproxy01</td><td>192.168.1.106</td><td>CentOS Linux release 7.5</td><td>haproxy、keepalived</td></tr><tr><td>haproxy02</td><td>192.168.1.107</td><td>CentOS Linux release 7.5</td><td>haproxy、keepalived</td></tr><tr><td>VIP</td><td>192.168.1.111</td><td>CentOS Linux release 7.5</td><td>IPVS</td></tr></tbody></table><h2 id="基本环境配置" tabindex="-1"><a class="header-anchor" href="#基本环境配置" aria-hidden="true">#</a> 基本环境配置</h2><p><strong>配置所有节点hosts:</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts</span>\n<span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n<span class="token number">192.168</span>.1.101 k8s-master01\n<span class="token number">192.168</span>.1.102 k8s-master02\n<span class="token number">192.168</span>.1.103 k8s-master03\n<span class="token number">192.168</span>.1.104 k8s-node01\n<span class="token number">192.168</span>.1.105 k8s-node02\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CentOS 7安装yum源如下:</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-o</span> /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo\nyum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;/mirrors.cloud.aliyuncs.com/d&#39;</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;/mirrors.aliyuncs.com/d&#39;</span> /etc/yum.repos.d/CentOS-Base.repo\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>必备工具安装</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token function">wget</span> jq psmisc <span class="token function">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> <span class="token parameter variable">-y</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>所有节点关闭firewalld 、dnsmasq、selinux(CentOS7需要关闭NetworkManager，CentOS8不需要)</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl disable <span class="token parameter variable">--now</span> firewalld \nsystemctl disable <span class="token parameter variable">--now</span> dnsmasq\nsystemctl disable <span class="token parameter variable">--now</span> NetworkManager\n\nsetenforce <span class="token number">0</span>\n<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/sysconfig/selinux\n<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/selinux/config\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点关闭swap分区，fstab注释swap</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">vm.swappiness</span><span class="token operator">=</span><span class="token number">0</span>\n<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">&#39;/^[^#]*swap/s@^@#@&#39;</span> /etc/fstab\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点同步时间</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm\nyum <span class="token function">install</span> ntpdate <span class="token parameter variable">-y</span>\n\n<span class="token function">ln</span> <span class="token parameter variable">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n<span class="token builtin class-name">echo</span> <span class="token string">&#39;Asia/Shanghai&#39;</span> <span class="token operator">&gt;</span>/etc/timezone\nntpdate time2.aliyun.com\n<span class="token comment"># 加入到crontab</span>\n*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点配置limit：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">65535</span>\n\n<span class="token function">vim</span> /etc/security/limits.conf\n<span class="token comment"># 末尾添加如下内容</span>\n* soft nofile <span class="token number">655360</span>\n* hard nofile <span class="token number">131072</span>\n* soft nproc <span class="token number">655350</span>\n* hard nproc <span class="token number">655350</span>\n* soft memlock unlimited\n* hard memlock unlimited　\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作，阿里云或者AWS上需要单独一台kubectl服务器。密钥配置如下：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ssh-keygen -t rsa</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>Master01配置免密码登录其他节点</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>所有节点安装基本工具</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token function">wget</span> jq psmisc <span class="token function">vim</span> net-tools yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> <span class="token parameter variable">-y</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>所有节点安装ipvsadm：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class="token parameter variable">-y</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>所有节点配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack， 4.18以下使用nf_conntrack_ipv4即可：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>modprobe -- ip_vs\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nmodprobe -- ip_vs_sh\nmodprobe -- nf_conntrack\n<span class="token function">vim</span> /etc/modules-load.d/ipvs.conf \n	<span class="token comment"># 加入以下内容</span>\nip_vs\nip_vs_lc\nip_vs_wlc\nip_vs_rr\nip_vs_wrr\nip_vs_lblc\nip_vs_lblcr\nip_vs_dh\nip_vs_sh\nip_vs_fo\nip_vs_nq\nip_vs_sed\nip_vs_ftp\nip_vs_sh\nnf_conntrack\nip_tables\nip_set\nxt_set\nipt_set\nipt_rpfilter\nipt_REJECT\nipip\n\n$ systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> systemd-modules-load.service\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>检查是否加载：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># lsmod | grep -e ip_vs -e nf_conntrack</span>\nnf_conntrack_ipv4      <span class="token number">16384</span>  <span class="token number">23</span> \nnf_defrag_ipv4         <span class="token number">16384</span>  <span class="token number">1</span> nf_conntrack_ipv4\nnf_conntrack          <span class="token number">135168</span>  <span class="token number">10</span> xt_conntrack,nf_conntrack_ipv6,nf_conntrack_ipv4,nf_nat,nf_nat_ipv6,ipt_MASQUERADE,nf_nat_ipv4,xt_nat,nf_conntrack_netlink,ip_vs\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>开启一些k8s集群中必须的内核参数，所有节点配置k8s内核：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf</span>\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nfs.may_detach_mounts = 1\nvm.overcommit_memory=1\nvm.panic_on_oom=0\nfs.inotify.max_user_watches=89100\nfs.file-max=52706963\nfs.nr_open=52706963\nnet.netfilter.nf_conntrack_max=2310720\n\nnet.ipv4.tcp_keepalive_time = 600\nnet.ipv4.tcp_keepalive_probes = 3\nnet.ipv4.tcp_keepalive_intvl =15\nnet.ipv4.tcp_max_tw_buckets = 36000\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_max_orphans = 327680\nnet.ipv4.tcp_orphan_retries = 3\nnet.ipv4.tcp_syncookies = 1\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.ip_conntrack_max = 65536\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.tcp_timestamps = 0\nnet.core.somaxconn = 16384\nEOF</span>\n<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">reboot</span>\nlsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="基本组件安装" tabindex="-1"><a class="header-anchor" href="#基本组件安装" aria-hidden="true">#</a> 基本组件安装</h2><p>主要安装的是集群中用到的各种组件，比如Docker-ce、Kubernetes各组件等。</p><h3 id="docker-安装" tabindex="-1"><a class="header-anchor" href="#docker-安装" aria-hidden="true">#</a> Docker 安装</h3><p><strong>所有节点安装Docker-ce 19.03</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> docker-ce-19.03.* <span class="token parameter variable">-y</span>\n\n由于新版kubelet建议使用systemd，所以可以把docker的CgroupDriver改成systemd\n<span class="token function">mkdir</span> /etc/docker\n<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF\n{\n  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]\n}\nEOF</span>\n\n所有节点设置开机自启动Docker：\nsystemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> <span class="token function">docker</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分发软件包" tabindex="-1"><a class="header-anchor" href="#分发软件包" aria-hidden="true">#</a> 分发软件包</h3><p>以下操作都在master01执行:</p><p><strong>Master01下载kubernetes安装包</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://storage.googleapis.com/kubernetes-release/release/v1.20.13/kubernetes-server-linux-amd64.tar.gz</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>下载etcd安装包</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>解压kubernetes安装文件</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>解压etcd安装文件</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  tar -zxvf etcd-v3.4.13-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.4.13-linux-amd64/etcd{,ctl}</span>\n版本查看\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubelet --version</span>\nKubernetes v1.20.13\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># etcdctl version</span>\netcdctl version: <span class="token number">3.4</span>.13\nAPI version: <span class="token number">3.4</span> \n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>将组件发送到其他节点</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">MasterNodes</span><span class="token operator">=</span><span class="token string">&#39;k8s-master02 k8s-master03&#39;</span>\n<span class="token assign-left variable">WorkNodes</span><span class="token operator">=</span><span class="token string">&#39;k8s-node01 k8s-node02&#39;</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$MasterNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$NODE</span><span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/etcd* <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token keyword">done</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$WorkNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span>     <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/ <span class="token punctuation">;</span> <span class="token keyword">done</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点创建/opt/cni/bin目录</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/cni/bin\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="生成证书" tabindex="-1"><a class="header-anchor" href="#生成证书" aria-hidden="true">#</a> 生成证书</h2><p>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</p><p><strong>Master01下载生成证书工具</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> <span class="token string">&quot;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&quot;</span> <span class="token parameter variable">-O</span> /usr/local/bin/cfssl\n<span class="token function">wget</span> <span class="token string">&quot;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&quot;</span> <span class="token parameter variable">-O</span> /usr/local/bin/cfssljson\n<span class="token function">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="etcd-证书" tabindex="-1"><a class="header-anchor" href="#etcd-证书" aria-hidden="true">#</a> etcd 证书</h3><p><strong>所有Master节点创建etcd证书目录</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> /etc/etcd/ssl <span class="token parameter variable">-p</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>所有节点创建kubernetes相关目录</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>Master01节点生成etcd证书</strong></p><p>生成证书的CSR文件：证书签名请求文件，配置了一些域名、公司、单位</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cd /root/k8s-ha-install/pki</span>\n\n<span class="token comment"># 生成etcd CA证书和CA证书的key</span>\n\n<span class="token function">cat</span> etcd-ca-csr.json\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>,\n  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,\n      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd&quot;</span>,\n      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Etcd Security&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>,\n  <span class="token string">&quot;ca&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;876000h&quot;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token function">cat</span> etcd-csr.json\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>,\n  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,\n      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd&quot;</span>,\n      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Etcd Security&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n\n\ncfssl gencert <span class="token parameter variable">-initca</span> etcd-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd-ca\n\n\ncfssl gencert <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem <span class="token punctuation">\\</span>\n   -ca-key<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.101,192.168.1.102,192.168.1.103 <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\\</span>\n   etcd-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd\n   \n<span class="token comment"># 执行结果</span>\n<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:00 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request\n<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:00 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR\n<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:00 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048\n<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:01 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR\n<span class="token number">2021</span>/11/26 <span class="token number">22</span>:48:01 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">250230878926052708909595617022917808304837732033</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>将证书复制到其他节点</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">MasterNodes</span><span class="token operator">=</span><span class="token string">&#39;k8s-master02 k8s-master03&#39;</span>\n<span class="token assign-left variable">WorkNodes</span><span class="token operator">=</span><span class="token string">&#39;k8s-node01 k8s-node02&#39;</span>\n\n<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$MasterNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span>\n     <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token string">&quot;mkdir -p /etc/etcd/ssl&quot;</span>\n     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>\n       <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/<span class="token variable">${FILE}</span>\n     <span class="token keyword">done</span>\n <span class="token keyword">done</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="apiserver证书" tabindex="-1"><a class="header-anchor" href="#apiserver证书" aria-hidden="true">#</a> apiserver证书</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat ca-csr.json </span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>,\n  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,\n      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes&quot;</span>,\n      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>,\n  <span class="token string">&quot;ca&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;876000h&quot;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\ncfssl gencert <span class="token parameter variable">-initca</span> ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/ca\n\n<span class="token comment"># 10.96.0.是k8s service的网段，如果说需要更改k8s service网段，那就需要更改10.96.0.1，</span>\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat ca-config.json </span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;signing&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n      <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;876000h&quot;</span>\n    <span class="token punctuation">}</span>,\n    <span class="token string">&quot;profiles&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n      <span class="token string">&quot;kubernetes&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n        <span class="token string">&quot;usages&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n            <span class="token string">&quot;signing&quot;</span>,\n            <span class="token string">&quot;key encipherment&quot;</span>,\n            <span class="token string">&quot;server auth&quot;</span>,\n            <span class="token string">&quot;client auth&quot;</span>\n        <span class="token punctuation">]</span>,\n        <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;876000h&quot;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat apiserver-csr.json </span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kube-apiserver&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>,\n  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,\n      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes&quot;</span>,\n      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 如果不是高可用集群，192.168.1.111为Master01的IP</span>\ncfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">10.96</span>.0.1,192.168.1.111,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.1.101,192.168.1.102,192.168.1.103   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   apiserver-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/apiserver\n\n\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成apiserver的聚合证书</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat front-proxy-ca-csr.json</span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n     <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n     <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat front-proxy-client-csr.json </span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;front-proxy-client&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n     <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n     <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\ncfssl gencert   <span class="token parameter variable">-initca</span> front-proxy-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-ca \n\ncfssl gencert   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   front-proxy-client-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-client\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="controller-manage证书" tabindex="-1"><a class="header-anchor" href="#controller-manage证书" aria-hidden="true">#</a> controller-manage证书</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat manager-csr.json </span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-controller-manager&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>,\n  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,\n      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-controller-manager&quot;</span>,\n      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n\ncfssl gencert <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\\</span>\n   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\\</span>\n   manager-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/controller-manager\n\n<span class="token comment"># 注意，如果不是高可用集群，192.168.1,111:6443改为master01的地址</span>\n<span class="token comment"># set-cluster：设置一个集群项，</span>\n\nkubectl config set-cluster kubernetes <span class="token punctuation">\\</span>\n     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\\</span>\n     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.1.111:6443 <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig\n\n<span class="token comment"># 设置一个环境项，一个上下文</span>\nkubectl config set-context system:kube-controller-manager@kubernetes <span class="token punctuation">\\</span>\n    <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\\</span>\n    <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-controller-manager <span class="token punctuation">\\</span>\n    <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig\n\n<span class="token comment"># set-credentials 设置一个用户项</span>\n\nkubectl config set-credentials system:kube-controller-manager <span class="token punctuation">\\</span>\n     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager.pem <span class="token punctuation">\\</span>\n     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class="token punctuation">\\</span>\n     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig\n\n\n<span class="token comment"># 使用某个环境当做默认环境</span>\n\nkubectl config use-context system:kube-controller-manager@kubernetes <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="scheduler证书" tabindex="-1"><a class="header-anchor" href="#scheduler证书" aria-hidden="true">#</a> scheduler证书</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat scheduler-csr.json </span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-scheduler&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>,\n  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,\n      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-scheduler&quot;</span>,\n      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n\ncfssl gencert <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\\</span>\n   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\\</span>\n   scheduler-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/scheduler\n   \n<span class="token comment"># 注意，如果不是高可用集群，192.168.1.111:6443改为master01的地址</span>\nkubectl config set-cluster kubernetes <span class="token punctuation">\\</span>\n     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\\</span>\n     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.1.111:6443 <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig\n\nkubectl config set-credentials system:kube-scheduler <span class="token punctuation">\\</span>\n     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/scheduler.pem <span class="token punctuation">\\</span>\n     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class="token punctuation">\\</span>\n     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig\n\nkubectl config set-context system:kube-scheduler@kubernetes <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-scheduler <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig\n\n\nkubectl config use-context system:kube-scheduler@kubernetes <span class="token punctuation">\\</span>\n     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="admin证书" tabindex="-1"><a class="header-anchor" href="#admin证书" aria-hidden="true">#</a> admin证书</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cat admin-csr.json </span>\n<span class="token punctuation">{</span>\n  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;admin&quot;</span>,\n  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,\n    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>\n  <span class="token punctuation">}</span>,\n  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,\n      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,\n      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,\n      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Kubernetes-manual&quot;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n\ncfssl gencert <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\\</span>\n   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\\</span>\n   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\\</span>\n   admin-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/admin\n   \n<span class="token comment"># 注意，如果不是高可用集群，192.168.1.111:6443改为master01的地址</span>\nkubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.1.111:6443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig\nkubectl config set-credentials kubernetes-admin     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/admin.pem     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/admin-key.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig\n\n\nkubectl config set-context kubernetes-admin@kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes-admin     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig\n\n\nkubectl config use-context kubernetes-admin@kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建ServiceAccount Key secret</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>openssl genrsa <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.key <span class="token number">2048</span>\n\n返回结果\nGenerating RSA private key, <span class="token number">2048</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>\n<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++\n<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++\ne is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span>\n\nopenssl rsa <span class="token parameter variable">-in</span> /etc/kubernetes/pki/sa.key <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.pub\n \n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>发送证书至其他节点</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span> \n<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /etc/kubernetes/pki <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> etcd<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> \n<span class="token function">scp</span> /etc/kubernetes/pki/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/pki/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>\n<span class="token keyword">done</span><span class="token punctuation">;</span> \n<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span> \n<span class="token function">scp</span> /etc/kubernetes/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>\n<span class="token keyword">done</span><span class="token punctuation">;</span>\n<span class="token keyword">done</span>\n<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># ll /etc/kubernetes/pki/</span>\ntotal <span class="token number">92</span>\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1025</span> Nov <span class="token number">26</span> <span class="token number">10</span>:52 admin.csr\n-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:52 admin-key.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1444</span> Nov <span class="token number">26</span> <span class="token number">10</span>:52 admin.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1029</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 apiserver.csr\n-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 apiserver-key.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1692</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 apiserver.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1025</span> Nov <span class="token number">26</span> <span class="token number">10</span>:47 ca.csr\n-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:47 ca-key.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1411</span> Nov <span class="token number">26</span> <span class="token number">10</span>:47 ca.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1082</span> Nov <span class="token number">26</span> <span class="token number">10</span>:50 controller-manager.csr\n-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> Nov <span class="token number">26</span> <span class="token number">10</span>:50 controller-manager-key.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1501</span> Nov <span class="token number">26</span> <span class="token number">10</span>:50 controller-manager.pem\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">891</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-ca.csr\n-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-ca-key.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1143</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-ca.pem\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">903</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-client.csr\n-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-client-key.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1188</span> Nov <span class="token number">26</span> <span class="token number">10</span>:49 front-proxy-client.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:53 sa.key\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">451</span> Nov <span class="token number">26</span> <span class="token number">10</span>:53 sa.pub\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1058</span> Nov <span class="token number">26</span> <span class="token number">10</span>:51 scheduler.csr\n-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> Nov <span class="token number">26</span> <span class="token number">10</span>:51 scheduler-key.pem\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1476</span> Nov <span class="token number">26</span> <span class="token number">10</span>:51 scheduler.pem\n<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># ls /etc/kubernetes/pki/ |wc -l</span>\n<span class="token number">23</span>\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="etcd-配置" tabindex="-1"><a class="header-anchor" href="#etcd-配置" aria-hidden="true">#</a> ETCD 配置</h2><p>etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</p><h3 id="master01" tabindex="-1"><a class="header-anchor" href="#master01" aria-hidden="true">#</a> Master01</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /etc/etcd/etcd.config.yml\nname: <span class="token string">&#39;k8s-master01&#39;</span>\ndata-dir: /var/lib/etcd\nwal-dir: /var/lib/etcd/wal\nsnapshot-count: <span class="token number">5000</span>\nheartbeat-interval: <span class="token number">100</span>\nelection-timeout: <span class="token number">1000</span>\nquota-backend-bytes: <span class="token number">0</span>\nlisten-peer-urls: <span class="token string">&#39;https://192.168.1.101:2380&#39;</span>\nlisten-client-urls: <span class="token string">&#39;https://192.168.1.101:2379,http://127.0.0.1:2379&#39;</span>\nmax-snapshots: <span class="token number">3</span>\nmax-wals: <span class="token number">5</span>\ncors:\ninitial-advertise-peer-urls: <span class="token string">&#39;https://192.168.1.101:2380&#39;</span>\nadvertise-client-urls: <span class="token string">&#39;https://192.168.1.101:2379&#39;</span>\ndiscovery:\ndiscovery-fallback: <span class="token string">&#39;proxy&#39;</span>\ndiscovery-proxy:\ndiscovery-srv:\ninitial-cluster: <span class="token string">&#39;k8s-master01=https://192.168.1.101:2380,k8s-master02=https://192.168.1.102:2380,k8s-master03=https://192.168.1.103:2380&#39;</span>\ninitial-cluster-token: <span class="token string">&#39;etcd-k8s-cluster&#39;</span>\ninitial-cluster-state: <span class="token string">&#39;new&#39;</span>\nstrict-reconfig-check: <span class="token boolean">false</span>\nenable-v2: <span class="token boolean">true</span>\nenable-pprof: <span class="token boolean">true</span>\nproxy: <span class="token string">&#39;off&#39;</span>\nproxy-failure-wait: <span class="token number">5000</span>\nproxy-refresh-interval: <span class="token number">30000</span>\nproxy-dial-timeout: <span class="token number">1000</span>\nproxy-write-timeout: <span class="token number">5000</span>\nproxy-read-timeout: <span class="token number">0</span>\nclient-transport-security:\n  cert-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>\n  key-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>\n  client-cert-auth: <span class="token boolean">true</span>\n  trusted-ca-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>\n  auto-tls: <span class="token boolean">true</span>\npeer-transport-security:\n  cert-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>\n  key-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>\n  peer-client-cert-auth: <span class="token boolean">true</span>\n  trusted-ca-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>\n  auto-tls: <span class="token boolean">true</span>\ndebug: <span class="token boolean">false</span>\nlog-package-levels:\nlog-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>\nforce-new-cluster: <span class="token boolean">false</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="master02" tabindex="-1"><a class="header-anchor" href="#master02" aria-hidden="true">#</a> Master02</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /etc/etcd/etcd.config.yml\nname: <span class="token string">&#39;k8s-master02&#39;</span>\ndata-dir: /var/lib/etcd\nwal-dir: /var/lib/etcd/wal\nsnapshot-count: <span class="token number">5000</span>\nheartbeat-interval: <span class="token number">100</span>\nelection-timeout: <span class="token number">1000</span>\nquota-backend-bytes: <span class="token number">0</span>\nlisten-peer-urls: <span class="token string">&#39;https://192.168.1.102:2380&#39;</span>\nlisten-client-urls: <span class="token string">&#39;https://192.168.1.102:2379,http://127.0.0.1:2379&#39;</span>\nmax-snapshots: <span class="token number">3</span>\nmax-wals: <span class="token number">5</span>\ncors:\ninitial-advertise-peer-urls: <span class="token string">&#39;https://192.168.1.102:2380&#39;</span>\nadvertise-client-urls: <span class="token string">&#39;https://192.168.1.102:2379&#39;</span>\ndiscovery:\ndiscovery-fallback: <span class="token string">&#39;proxy&#39;</span>\ndiscovery-proxy:\ndiscovery-srv:\ninitial-cluster: <span class="token string">&#39;k8s-master01=https://192.168.1.101:2380,k8s-master02=https://192.168.1.102:2380,k8s-master03=https://192.168.1.103:2380&#39;</span>\ninitial-cluster-token: <span class="token string">&#39;etcd-k8s-cluster&#39;</span>\ninitial-cluster-state: <span class="token string">&#39;new&#39;</span>\nstrict-reconfig-check: <span class="token boolean">false</span>\nenable-v2: <span class="token boolean">true</span>\nenable-pprof: <span class="token boolean">true</span>\nproxy: <span class="token string">&#39;off&#39;</span>\nproxy-failure-wait: <span class="token number">5000</span>\nproxy-refresh-interval: <span class="token number">30000</span>\nproxy-dial-timeout: <span class="token number">1000</span>\nproxy-write-timeout: <span class="token number">5000</span>\nproxy-read-timeout: <span class="token number">0</span>\nclient-transport-security:\n  cert-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>\n  key-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>\n  client-cert-auth: <span class="token boolean">true</span>\n  trusted-ca-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>\n  auto-tls: <span class="token boolean">true</span>\npeer-transport-security:\n  cert-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>\n  key-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>\n  peer-client-cert-auth: <span class="token boolean">true</span>\n  trusted-ca-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>\n  auto-tls: <span class="token boolean">true</span>\ndebug: <span class="token boolean">false</span>\nlog-package-levels:\nlog-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>\nforce-new-cluster: <span class="token boolean">false</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="master03" tabindex="-1"><a class="header-anchor" href="#master03" aria-hidden="true">#</a> Master03</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /etc/etcd/etcd.config.yml\nname: <span class="token string">&#39;k8s-master03&#39;</span>\ndata-dir: /var/lib/etcd\nwal-dir: /var/lib/etcd/wal\nsnapshot-count: <span class="token number">5000</span>\nheartbeat-interval: <span class="token number">100</span>\nelection-timeout: <span class="token number">1000</span>\nquota-backend-bytes: <span class="token number">0</span>\nlisten-peer-urls: <span class="token string">&#39;https://192.168.1.103:2380&#39;</span>\nlisten-client-urls: <span class="token string">&#39;https://192.168.1.103:2379,http://127.0.0.1:2379&#39;</span>\nmax-snapshots: <span class="token number">3</span>\nmax-wals: <span class="token number">5</span>\ncors:\ninitial-advertise-peer-urls: <span class="token string">&#39;https://192.168.1.103:2380&#39;</span>\nadvertise-client-urls: <span class="token string">&#39;https://192.168.1.103:2379&#39;</span>\ndiscovery:\ndiscovery-fallback: <span class="token string">&#39;proxy&#39;</span>\ndiscovery-proxy:\ndiscovery-srv:\ninitial-cluster: <span class="token string">&#39;k8s-master01=https://192.168.1.101:2380,k8s-master02=https://192.168.1.102:2380,k8s-master03=https://192.168.1.103:2380&#39;</span>\ninitial-cluster-token: <span class="token string">&#39;etcd-k8s-cluster&#39;</span>\ninitial-cluster-state: <span class="token string">&#39;new&#39;</span>\nstrict-reconfig-check: <span class="token boolean">false</span>\nenable-v2: <span class="token boolean">true</span>\nenable-pprof: <span class="token boolean">true</span>\nproxy: <span class="token string">&#39;off&#39;</span>\nproxy-failure-wait: <span class="token number">5000</span>\nproxy-refresh-interval: <span class="token number">30000</span>\nproxy-dial-timeout: <span class="token number">1000</span>\nproxy-write-timeout: <span class="token number">5000</span>\nproxy-read-timeout: <span class="token number">0</span>\nclient-transport-security:\n  cert-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>\n  key-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>\n  client-cert-auth: <span class="token boolean">true</span>\n  trusted-ca-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>\n  auto-tls: <span class="token boolean">true</span>\npeer-transport-security:\n  cert-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>\n  key-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>\n  peer-client-cert-auth: <span class="token boolean">true</span>\n  trusted-ca-file: <span class="token string">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>\n  auto-tls: <span class="token boolean">true</span>\ndebug: <span class="token boolean">false</span>\nlog-package-levels:\nlog-outputs: <span class="token punctuation">[</span>default<span class="token punctuation">]</span>\nforce-new-cluster: <span class="token boolean">false</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="启动etcd" tabindex="-1"><a class="header-anchor" href="#启动etcd" aria-hidden="true">#</a> 启动ETCD</h3><p><strong>所有Master节点创建etcd service并启动</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /usr/lib/systemd/system/etcd.service\n<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>\n<span class="token assign-left variable">Description</span><span class="token operator">=</span>Etcd Service\n<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://coreos.com/etcd/docs/latest/\n<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target\n\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/etcd --config-file<span class="token operator">=</span>/etc/etcd/etcd.config.yml\n<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure\n<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">10</span>\n<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>\n\n<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>\n<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target\n<span class="token assign-left variable">Alias</span><span class="token operator">=</span>etcd3.service\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有Master节点创建etcd的证书目录</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> /etc/kubernetes/pki/etcd\n<span class="token function">ln</span> <span class="token parameter variable">-s</span> /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/\nsystemctl daemon-reload\nsystemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> etcd\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查看etcd状态</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span>\netcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;192.168.1.101:2379,192.168.1.102:2379,192.168.1.103:2379&quot;</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem <span class="token parameter variable">--cert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd.pem <span class="token parameter variable">--key</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span class="token operator">=</span>table\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="高可用配置" tabindex="-1"><a class="header-anchor" href="#高可用配置" aria-hidden="true">#</a> 高可用配置</h2><p><strong>所有haproxy节点安装keepalived和haproxy</strong>·</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> keepalived haproxy <span class="token parameter variable">-y</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>所有haproxy配置HAProxy，配置一样</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /etc/haproxy/haproxy.cfg \nglobal\n  maxconn  <span class="token number">2000</span>\n  ulimit-n  <span class="token number">16384</span>\n  log  <span class="token number">127.0</span>.0.1 local0 err\n  stats <span class="token function">timeout</span> 30s\n\ndefaults\n  log global\n  mode  http\n  option  httplog\n  <span class="token function">timeout</span> connect <span class="token number">5000</span>\n  <span class="token function">timeout</span> client  <span class="token number">50000</span>\n  <span class="token function">timeout</span> server  <span class="token number">50000</span>\n  <span class="token function">timeout</span> http-request 15s\n  <span class="token function">timeout</span> http-keep-alive 15s\n\nfrontend k8s-master\n  <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:6443\n  <span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1:6443\n  mode tcp\n  option tcplog\n  tcp-request inspect-delay 5s\n  default_backend k8s-master\n\nbackend k8s-master\n  mode tcp\n  option tcplog\n  option tcp-check\n  balance roundrobin\n  default-server inter 10s downinter 5s rise <span class="token number">2</span> fall <span class="token number">2</span> slowstart 60s maxconn <span class="token number">250</span> maxqueue <span class="token number">256</span> weight <span class="token number">100</span>\n  server k8s-master01    <span class="token number">192.168</span>.1.101:6443  check\n  server k8s-master02    <span class="token number">192.168</span>.1.102:6443  check\n  server k8s-master03    <span class="token number">192.168</span>.1.103:6443  check\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="keepalived01" tabindex="-1"><a class="header-anchor" href="#keepalived01" aria-hidden="true">#</a> keepalived01</h3><p><strong>所有Haproxy节点配置KeepAlived，配置不一样，注意区分 vim /etc/keepalived/keepalived.conf ，注意每个节点的IP和网卡（interface参数）</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived\nglobal_defs <span class="token punctuation">{</span>\n    router_id LVS_DEVEL\n<span class="token punctuation">}</span>\nvrrp_script chk_apiserver <span class="token punctuation">{</span>\n    script <span class="token string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>\n    interval <span class="token number">5</span> \n    weight <span class="token parameter variable">-5</span>\n    fall <span class="token number">2</span>\n    rise <span class="token number">1</span>\n<span class="token punctuation">}</span>\nvrrp_instance VI_1 <span class="token punctuation">{</span>\n    state MASTER\n    interface ens33\n    mcast_src_ip <span class="token number">192.168</span>.1.106\n    virtual_router_id <span class="token number">51</span>\n    priority <span class="token number">100</span>\n    nopreempt\n    advert_int <span class="token number">2</span>\n    authentication <span class="token punctuation">{</span>\n        auth_type PASS\n        auth_pass K8SHA_KA_AUTH\n    <span class="token punctuation">}</span>\n    virtual_ipaddress <span class="token punctuation">{</span>\n        <span class="token number">192.168</span>.1.111\n    <span class="token punctuation">}</span>\n    track_script <span class="token punctuation">{</span>\n      chk_apiserver \n<span class="token punctuation">}</span> <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="keepalived02" tabindex="-1"><a class="header-anchor" href="#keepalived02" aria-hidden="true">#</a> keepalived02</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived\nglobal_defs <span class="token punctuation">{</span>\n    router_id LVS_DEVEL\n<span class="token punctuation">}</span>\nvrrp_script chk_apiserver <span class="token punctuation">{</span>\n    script <span class="token string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>\n    interval <span class="token number">5</span> \n    weight <span class="token parameter variable">-5</span>\n    fall <span class="token number">2</span>\n    rise <span class="token number">1</span>\n \n<span class="token punctuation">}</span>\nvrrp_instance VI_1 <span class="token punctuation">{</span>\n    state BACKUP\n    interface ens33\n    mcast_src_ip <span class="token number">192.168</span>.1.107\n    virtual_router_id <span class="token number">51</span>\n    priority <span class="token number">90</span>\n    nopreempt\n    advert_int <span class="token number">2</span>\n    authentication <span class="token punctuation">{</span>\n        auth_type PASS\n        auth_pass K8SHA_KA_AUTH\n    <span class="token punctuation">}</span>\n    virtual_ipaddress <span class="token punctuation">{</span>\n        <span class="token number">192.168</span>.1.111\n    <span class="token punctuation">}</span>\n    track_script <span class="token punctuation">{</span>\n      chk_apiserver \n<span class="token punctuation">}</span> <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="健康检查配置" tabindex="-1"><a class="header-anchor" href="#健康检查配置" aria-hidden="true">#</a> 健康检查配置</h3><p>所有haproxy节点</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cat</span> /etc/keepalived/check_apiserver.sh \n\n<span class="token comment">#!/bin/bash</span>\n\n<span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token number">0</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">k</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">3</span><span class="token variable">)</span></span>\n<span class="token keyword">do</span>\n    <span class="token assign-left variable">check_code</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>pgrep haproxy<span class="token variable">)</span></span>\n    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$check_code</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">expr</span> $err + <span class="token number">1</span><span class="token variable">)</span></span>\n        <span class="token function">sleep</span> <span class="token number">1</span>\n        <span class="token builtin class-name">continue</span>\n    <span class="token keyword">else</span>\n        <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token builtin class-name">break</span>\n    <span class="token keyword">fi</span>\n<span class="token keyword">done</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$err</span> <span class="token operator">!=</span> <span class="token string">&quot;0&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n    <span class="token builtin class-name">echo</span> <span class="token string">&quot;systemctl stop keepalived&quot;</span>\n    /usr/bin/systemctl stop keepalived\n    <span class="token builtin class-name">exit</span> <span class="token number">1</span>\n<span class="token keyword">else</span>\n    <span class="token builtin class-name">exit</span> <span class="token number">0</span>\n<span class="token keyword">fi</span>\n\n<span class="token function">chmod</span> +x /etc/keepalived/check_apiserver.sh\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有master节点启动haproxy和keepalived</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@haproxy01 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>\n<span class="token punctuation">[</span>root@haproxy02 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>\n<span class="token punctuation">[</span>root@haproxy01 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now haproxy</span>\n<span class="token punctuation">[</span>roothaproxy02 keepalived<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now keepalived</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kubernetes组件配置" tabindex="-1"><a class="header-anchor" href="#kubernetes组件配置" aria-hidden="true">#</a> Kubernetes组件配置</h2><p><strong>所有节点创建相关目录</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="apiserver" tabindex="-1"><a class="header-anchor" href="#apiserver" aria-hidden="true">#</a> apiserver</h3><p><strong>注意使用的k8s service网段为10.96.0.0/12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改</strong></p><h4 id="master01-配置" tabindex="-1"><a class="header-anchor" href="#master01-配置" aria-hidden="true">#</a> Master01 配置</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span>\n\n<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>\n<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server\n<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes\n<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target\n\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\\</span>\n      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\\</span>\n      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\\</span>\n      --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.111 <span class="token punctuation">\\</span>\n      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\\</span>\n      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\\</span>\n      --etcd-servers<span class="token operator">=</span>https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.102:2379 <span class="token punctuation">\\</span>\n      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\\</span>\n      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\\</span>\n      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\\</span>\n      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\\</span>\n      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\\</span>\n      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\\</span>\n      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\\</span>\n      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\\</span>\n      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\\</span>\n      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\\</span>\n      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\\</span>\n      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\\</span>\n      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\\</span>\n      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\\</span>\n      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\\</span>\n      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\\</span>\n      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\\</span>\n      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\\</span>\n      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\\</span>\n      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\\</span>\n      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User\n      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>\n\n<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure\n<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s\n<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>\n\n<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>\n<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="master01-配置-1" tabindex="-1"><a class="header-anchor" href="#master01-配置-1" aria-hidden="true">#</a> Master01 配置</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master02 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span>\n\n<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>\n<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server\n<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes\n<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target\n\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\\</span>\n      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\\</span>\n      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\\</span>\n      --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.111 <span class="token punctuation">\\</span>\n      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\\</span>\n      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\\</span>\n      --etcd-servers<span class="token operator">=</span>https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 <span class="token punctuation">\\</span>\n      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\\</span>\n      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\\</span>\n      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\\</span>\n      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\\</span>\n      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\\</span>\n      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\\</span>\n      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\\</span>\n      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\\</span>\n      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\\</span>\n      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\\</span>\n      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\\</span>\n      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\\</span>\n      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\\</span>\n      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\\</span>\n      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\\</span>\n      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\\</span>\n      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\\</span>\n      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\\</span>\n      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\\</span>\n      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\\</span>\n      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User\n      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>\n\n<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure\n<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s\n<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>\n\n<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>\n<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="master03-配置" tabindex="-1"><a class="header-anchor" href="#master03-配置" aria-hidden="true">#</a> Master03 配置</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master03 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span>\n\n<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>\n<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server\n<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes\n<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target\n\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-apiserver <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>  <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --allow-privileged<span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0  <span class="token punctuation">\\</span>\n      --secure-port<span class="token operator">=</span><span class="token number">6443</span>  <span class="token punctuation">\\</span>\n      --insecure-port<span class="token operator">=</span><span class="token number">0</span>  <span class="token punctuation">\\</span>\n      --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.111 <span class="token punctuation">\\</span>\n      --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12  <span class="token punctuation">\\</span>\n      --service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767  <span class="token punctuation">\\</span>\n      --etcd-servers<span class="token operator">=</span>https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 <span class="token punctuation">\\</span>\n      --etcd-cafile<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class="token punctuation">\\</span>\n      --etcd-certfile<span class="token operator">=</span>/etc/etcd/ssl/etcd.pem  <span class="token punctuation">\\</span>\n      --etcd-keyfile<span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem  <span class="token punctuation">\\</span>\n      --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem  <span class="token punctuation">\\</span>\n      --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\\</span>\n      --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\\</span>\n      --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.pem  <span class="token punctuation">\\</span>\n      --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class="token punctuation">\\</span>\n      --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub  <span class="token punctuation">\\</span>\n      --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key  <span class="token punctuation">\\</span>\n      --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local <span class="token punctuation">\\</span>\n      --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname  <span class="token punctuation">\\</span>\n      --enable-admission-plugins<span class="token operator">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token punctuation">\\</span>\n      --authorization-mode<span class="token operator">=</span>Node,RBAC  <span class="token punctuation">\\</span>\n      --enable-bootstrap-token-auth<span class="token operator">=</span>true  <span class="token punctuation">\\</span>\n      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token punctuation">\\</span>\n      --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class="token punctuation">\\</span>\n      --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token punctuation">\\</span>\n      --requestheader-allowed-names<span class="token operator">=</span>aggregator  <span class="token punctuation">\\</span>\n      --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group  <span class="token punctuation">\\</span>\n      --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-  <span class="token punctuation">\\</span>\n      --requestheader-username-headers<span class="token operator">=</span>X-Remote-User\n      <span class="token comment"># --token-auth-file=/etc/kubernetes/token.csv</span>\n\n<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure\n<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s\n<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65535</span>\n\n<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>\n<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="启动-apiserver" tabindex="-1"><a class="header-anchor" href="#启动-apiserver" aria-hidden="true">#</a> 启动 apiserver</h4><p><strong>所有Master节点开启kube-apiserver</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-apiserver\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>检测kube-server状态</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status kube-apiserver</span>\n● kube-apiserver.service - Kubernetes API Server\n   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kube-apiserver.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>\n   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Fri <span class="token number">2021</span>-11-26 <span class="token number">11</span>:41:28 CST<span class="token punctuation">;</span> 12h ago\n     Docs: https://github.com/kubernetes/kubernetes\n Main PID: <span class="token number">2439</span> <span class="token punctuation">(</span>kube-apiserver<span class="token punctuation">)</span>\n    Tasks: <span class="token number">9</span>\n   Memory: <span class="token number">335</span>.2M\n   CGroup: /system.slice/kube-apiserver.service\n           └─2439 /usr/local/bin/kube-apiserver <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true --allow-privileged<span class="token operator">=</span>true --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0 --secure-port<span class="token operator">=</span><span class="token number">6443</span> --insecure-port<span class="token operator">=</span><span class="token number">0</span> --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.1.101 --service<span class="token punctuation">..</span>.\n\nNov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.215694    <span class="token number">2439</span> clientconn.go:948<span class="token punctuation">]</span> ClientConn switching balancer to <span class="token string">&quot;pick_first&quot;</span>\nNov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.215982    <span class="token number">2439</span> balancer_conn_wrappers.go:78<span class="token punctuation">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc00b661800, <span class="token punctuation">{</span>CONNECTING <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span><span class="token punctuation">}</span>\nNov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.230245    <span class="token number">2439</span> balancer_conn_wrappers.go:78<span class="token punctuation">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc00b661800, <span class="token punctuation">{</span>READY <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span><span class="token punctuation">}</span>\nNov <span class="token number">26</span> <span class="token number">23</span>:45:14 k8s-master01 kube-apiserver<span class="token punctuation">[</span><span class="token number">2439</span><span class="token punctuation">]</span>: I1126 <span class="token number">23</span>:45:14.232556    <span class="token number">2439</span> \n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="controllermanager" tabindex="-1"><a class="header-anchor" href="#controllermanager" aria-hidden="true">#</a> ControllerManager</h3><p>所有Master节点配置kube-controller-manager service</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-controller-manager.service</span>\n<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>\n<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Controller Manager\n<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes\n<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target\n\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-controller-manager <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--address</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token punctuation">\\</span>\n      --root-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\\</span>\n      --cluster-signing-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\\</span>\n      --cluster-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\\</span>\n      --service-account-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class="token punctuation">\\</span>\n      --leader-elect<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n      --use-service-account-credentials<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n      --node-monitor-grace-period<span class="token operator">=</span>40s <span class="token punctuation">\\</span>\n      --node-monitor-period<span class="token operator">=</span>5s <span class="token punctuation">\\</span>\n      --pod-eviction-timeout<span class="token operator">=</span>2m0s <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--controllers</span><span class="token operator">=</span>*,bootstrapsigner,tokencleaner <span class="token punctuation">\\</span>\n      --allocate-node-cidrs<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n      --cluster-cidr<span class="token operator">=</span><span class="token number">172.16</span>.0.0/12 <span class="token punctuation">\\</span>\n      --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span class="token punctuation">\\</span>\n      --node-cidr-mask-size<span class="token operator">=</span><span class="token number">24</span>\n      \n<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always\n<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s\n\n<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>\n<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有Master节点启动kube-controller-manager</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>\n\n<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now kube-controller-manager</span>\nCreated symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /usr/lib/systemd/system/kube-controller-manager.service.\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查看启动状态</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status kube-controller-manager</span>\n● kube-controller-manager.service - Kubernetes Controller Manager\n   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kube-controller-manager.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>\n   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Fri <span class="token number">2021</span>-11-26 <span class="token number">11</span>:53:20 CST<span class="token punctuation">;</span> 11h ago\n     Docs: https://github.com/kubernetes/kubernetes\n Main PID: <span class="token number">2591</span> <span class="token punctuation">(</span>kube-controller<span class="token punctuation">)</span>\n    Tasks: <span class="token number">6</span>\n   Memory: <span class="token number">25</span>.4M\n   CGroup: /system.slice/kube-controller-manager.service\n           └─2591 /usr/local/bin/kube-controller-manager <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true <span class="token parameter variable">--address</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 --root-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem --cluster-signing-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem -<span class="token punctuation">..</span>.\n\nNov <span class="token number">26</span> <span class="token number">11</span>:53:21 k8s-master01 kube-controller-manager<span class="token punctuation">[</span><span class="token number">2591</span><span class="token punctuation">]</span>: W1126 <span class="token number">11</span>:53:21.767575    <span class="token number">2591</span> authorization.go:176<span class="token punctuation">]</span> No authorization-kubeconfig provided, so SubjectAccessReview of authorizatio<span class="token punctuation">..</span>. won&#39;t work.\nNov <span class="token number">26</span> <span class="token number">11</span>:53:21 k8s-master01 kube-controller-manager<span class="token punctuation">[</span><span class="token number">2591</span><span class="token punctuation">]</span>: I1126 <span class="token number">11</span>:53:21.767606    <span class="token number">2591</span> controllermanager.go:176<span class="token punctuation">]</span> Version: v1.20.13\n\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="scheduler" tabindex="-1"><a class="header-anchor" href="#scheduler" aria-hidden="true">#</a> Scheduler</h3><p><strong>所有Master节点配置kube-scheduler service</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/kube-scheduler.service </span>\n<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>\n<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Scheduler\n<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes\n<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target\n\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kube-scheduler <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--logtostderr</span><span class="token operator">=</span>true <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--address</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token punctuation">\\</span>\n      --leader-elect<span class="token operator">=</span>true <span class="token punctuation">\\</span>\n      <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig\n\n<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always\n<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>10s\n\n<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>\n<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target\n<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>\n<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now kube-scheduler</span>\nCreated symlink /etc/systemd/system/multi-user.target.wants/kube-scheduler.service → /usr/lib/systemd/system/kube-scheduler.service.\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="tls-bootstrapping-配置" tabindex="-1"><a class="header-anchor" href="#tls-bootstrapping-配置" aria-hidden="true">#</a> TLS Bootstrapping 配置</h2><p><strong>在Master01创建bootstrap</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/bootstrap\nkubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.1.111:6443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig\nkubectl config set-credentials tls-bootstrap-token-user     <span class="token parameter variable">--token</span><span class="token operator">=</span>c8ad9c.2e4d610cf3e7426e <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig\nkubectl config set-context tls-bootstrap-token-user@kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>tls-bootstrap-token-user     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig\nkubectl config use-context tls-bootstrap-token-user@kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意：如果要修改bootstrap.secret.yaml的token-id和token-secret，需要保证下图红圈内的字符串一致的，并且位数是一样的。还要保证上个命令的黄色字体：c8ad9c.2e4d610cf3e7426e与你修改的字符串要一致</p></blockquote><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># cat bootstrap.secret.yaml </span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>token<span class="token punctuation">-</span>c8ad9c\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token key atrule">type</span><span class="token punctuation">:</span> bootstrap.kubernetes.io/token\n<span class="token key atrule">stringData</span><span class="token punctuation">:</span>\n  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;The default bootstrap token generated by &#39;kubelet &#39;.&quot;</span>\n  <span class="token key atrule">token-id</span><span class="token punctuation">:</span> c8ad9c\n  <span class="token key atrule">token-secret</span><span class="token punctuation">:</span> 2e4d610cf3e7426e\n  <span class="token key atrule">usage-bootstrap-authentication</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n  <span class="token key atrule">usage-bootstrap-signing</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n  <span class="token key atrule">auth-extra-groups</span><span class="token punctuation">:</span>  system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token<span class="token punctuation">,</span>system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>worker<span class="token punctuation">,</span>system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>ingress\n \n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubelet<span class="token punctuation">-</span>bootstrap\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>node<span class="token punctuation">-</span>bootstrapper\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>autoapprove<span class="token punctuation">-</span>bootstrap\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>certificates.k8s.io<span class="token punctuation">:</span>certificatesigningrequests<span class="token punctuation">:</span>nodeclient\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>autoapprove<span class="token punctuation">-</span>certificate<span class="token punctuation">-</span>rotation\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>certificates.k8s.io<span class="token punctuation">:</span>certificatesigningrequests<span class="token punctuation">:</span>selfnodeclient\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>nodes\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>\n    <span class="token key atrule">rbac.authorization.kubernetes.io/autoupdate</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">kubernetes.io/bootstrapping</span><span class="token punctuation">:</span> rbac<span class="token punctuation">-</span>defaults\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>to<span class="token punctuation">-</span>kubelet\n<span class="token key atrule">rules</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> nodes/proxy\n      <span class="token punctuation">-</span> nodes/stats\n      <span class="token punctuation">-</span> nodes/log\n      <span class="token punctuation">-</span> nodes/spec\n      <span class="token punctuation">-</span> nodes/metrics\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>apiserver\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>to<span class="token punctuation">-</span>kubelet\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n    <span class="token key atrule">kind</span><span class="token punctuation">:</span> User\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span>\n<span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># kubectl create -f bootstrap.secret.yaml </span>\nsecret/bootstrap-token-c8ad9c created\nclusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created\nclusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created\nclusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created\nclusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created\nclusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="node节点配置" tabindex="-1"><a class="header-anchor" href="#node节点配置" aria-hidden="true">#</a> Node节点配置</h2><h3 id="分发证书" tabindex="-1"><a class="header-anchor" href="#分发证书" aria-hidden="true">#</a> 分发证书</h3><p><strong>Master01节点分发证书至Node节点</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /etc/kubernetes/\n\n<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>\n     <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl\n     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca.pem etcd.pem etcd-key.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>\n       <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/\n     <span class="token keyword">done</span>\n     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span>\n       <span class="token function">scp</span> /etc/kubernetes/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span>\n <span class="token keyword">done</span>\n <span class="token keyword">done</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="kubelet-配置" tabindex="-1"><a class="header-anchor" href="#kubelet-配置" aria-hidden="true">#</a> kubelet 配置</h3><p><strong>所有节点创建相关目录</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>所有节点配置kubelet service****</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># vim  /usr/lib/systemd/system/kubelet.service</span>\n\n<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>\n<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet\n<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes\n<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service\n<span class="token assign-left variable">Requires</span><span class="token operator">=</span>docker.service\n\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet\n\n<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always\n<span class="token assign-left variable">StartLimitInterval</span><span class="token operator">=</span><span class="token number">0</span>\n<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">10</span>\n\n<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>\n<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点配置kubelet service的配置文件</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /etc/systemd/system/kubelet.service.d/10-kubelet.conf\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;</span>\n<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span>\n<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span>\n<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node=&#39;&#39; &quot;</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>\n<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet <span class="token variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="token variable">$KUBELET_CONFIG_ARGS</span> <span class="token variable">$KUBELET_SYSTEM_ARGS</span> <span class="token variable">$KUBELET_EXTRA_ARGS</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建kubelet的配置文件</strong></p><blockquote><p>注意：如果更改了k8s的service网段，需要更改kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10</p></blockquote><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/kubelet-conf.yml</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubelet.config.k8s.io/v1beta1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeletConfiguration\n<span class="token key atrule">address</span><span class="token punctuation">:</span> 0.0.0.0\n<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10250</span>\n<span class="token key atrule">readOnlyPort</span><span class="token punctuation">:</span> <span class="token number">10255</span>\n<span class="token key atrule">authentication</span><span class="token punctuation">:</span>\n  <span class="token key atrule">anonymous</span><span class="token punctuation">:</span>\n    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>\n    <span class="token key atrule">cacheTTL</span><span class="token punctuation">:</span> 2m0s\n    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n  <span class="token key atrule">x509</span><span class="token punctuation">:</span>\n    <span class="token key atrule">clientCAFile</span><span class="token punctuation">:</span> /etc/kubernetes/pki/ca.pem\n<span class="token key atrule">authorization</span><span class="token punctuation">:</span>\n  <span class="token key atrule">mode</span><span class="token punctuation">:</span> Webhook\n  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>\n    <span class="token key atrule">cacheAuthorizedTTL</span><span class="token punctuation">:</span> 5m0s\n    <span class="token key atrule">cacheUnauthorizedTTL</span><span class="token punctuation">:</span> 30s\n<span class="token key atrule">cgroupDriver</span><span class="token punctuation">:</span> systemd\n<span class="token key atrule">cgroupsPerQOS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">clusterDNS</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> 10.96.0.10\n<span class="token key atrule">clusterDomain</span><span class="token punctuation">:</span> cluster.local\n<span class="token key atrule">containerLogMaxFiles</span><span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token key atrule">containerLogMaxSize</span><span class="token punctuation">:</span> 10Mi\n<span class="token key atrule">contentType</span><span class="token punctuation">:</span> application/vnd.kubernetes.protobuf\n<span class="token key atrule">cpuCFSQuota</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">cpuManagerPolicy</span><span class="token punctuation">:</span> none\n<span class="token key atrule">cpuManagerReconcilePeriod</span><span class="token punctuation">:</span> 10s\n<span class="token key atrule">enableControllerAttachDetach</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">enableDebuggingHandlers</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">enforceNodeAllocatable</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> pods\n<span class="token key atrule">eventBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>\n<span class="token key atrule">eventRecordQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token key atrule">evictionHard</span><span class="token punctuation">:</span>\n  <span class="token key atrule">imagefs.available</span><span class="token punctuation">:</span> 15%\n  <span class="token key atrule">memory.available</span><span class="token punctuation">:</span> 100Mi\n  <span class="token key atrule">nodefs.available</span><span class="token punctuation">:</span> 10%\n  <span class="token key atrule">nodefs.inodesFree</span><span class="token punctuation">:</span> 5%\n<span class="token key atrule">evictionPressureTransitionPeriod</span><span class="token punctuation">:</span> 5m0s\n<span class="token key atrule">failSwapOn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">fileCheckFrequency</span><span class="token punctuation">:</span> 20s\n<span class="token key atrule">hairpinMode</span><span class="token punctuation">:</span> promiscuous<span class="token punctuation">-</span>bridge\n<span class="token key atrule">healthzBindAddress</span><span class="token punctuation">:</span> 127.0.0.1\n<span class="token key atrule">healthzPort</span><span class="token punctuation">:</span> <span class="token number">10248</span>\n<span class="token key atrule">httpCheckFrequency</span><span class="token punctuation">:</span> 20s\n<span class="token key atrule">imageGCHighThresholdPercent</span><span class="token punctuation">:</span> <span class="token number">85</span>\n<span class="token key atrule">imageGCLowThresholdPercent</span><span class="token punctuation">:</span> <span class="token number">80</span>\n<span class="token key atrule">imageMinimumGCAge</span><span class="token punctuation">:</span> 2m0s\n<span class="token key atrule">iptablesDropBit</span><span class="token punctuation">:</span> <span class="token number">15</span>\n<span class="token key atrule">iptablesMasqueradeBit</span><span class="token punctuation">:</span> <span class="token number">14</span>\n<span class="token key atrule">kubeAPIBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>\n<span class="token key atrule">kubeAPIQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token key atrule">makeIPTablesUtilChains</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">maxOpenFiles</span><span class="token punctuation">:</span> <span class="token number">1000000</span>\n<span class="token key atrule">maxPods</span><span class="token punctuation">:</span> <span class="token number">110</span>\n<span class="token key atrule">nodeStatusUpdateFrequency</span><span class="token punctuation">:</span> 10s\n<span class="token key atrule">oomScoreAdj</span><span class="token punctuation">:</span> <span class="token number">-999</span>\n<span class="token key atrule">podPidsLimit</span><span class="token punctuation">:</span> <span class="token number">-1</span>\n<span class="token key atrule">registryBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>\n<span class="token key atrule">registryPullQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token key atrule">resolvConf</span><span class="token punctuation">:</span> /etc/resolv.conf\n<span class="token key atrule">rotateCertificates</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">runtimeRequestTimeout</span><span class="token punctuation">:</span> 2m0s\n<span class="token key atrule">serializeImagePulls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n<span class="token key atrule">staticPodPath</span><span class="token punctuation">:</span> /etc/kubernetes/manifests\n<span class="token key atrule">streamingConnectionIdleTimeout</span><span class="token punctuation">:</span> 4h0m0s\n<span class="token key atrule">syncFrequency</span><span class="token punctuation">:</span> 1m0s\n<span class="token key atrule">volumeStatsAggPeriod</span><span class="token punctuation">:</span> 1m0s\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>启动所有节点kubelet</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl daemon-reload\nsystemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>此时系统日志/var/log/messages</p><p>Unable to update cni config: no networks found in /etc/cni/net.d 显示只有如下信息为正常</p></blockquote><h3 id="kube-proxy-配置" tabindex="-1"><a class="header-anchor" href="#kube-proxy-配置" aria-hidden="true">#</a> kube-proxy 配置</h3><p><strong>以下操作在Master01执行</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl <span class="token parameter variable">-n</span> kube-system create serviceaccount kube-proxy\nkubectl create clusterrolebinding system:kube-proxy         <span class="token parameter variable">--clusterrole</span> system:node-proxier         <span class="token parameter variable">--serviceaccount</span> kube-system:kube-proxy\n<span class="token assign-left variable">SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get sa/kube-proxy <span class="token punctuation">\\</span>\n    <span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">&#39;{.secrets[0].name}&#39;</span><span class="token variable">)</span></span>\n<span class="token assign-left variable">JWT_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get secret/$SECRET <span class="token punctuation">\\</span>\n<span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">&#39;{.data.token}&#39;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span><span class="token variable">)</span></span>\n<span class="token assign-left variable">PKI_DIR</span><span class="token operator">=</span>/etc/kubernetes/pki\n<span class="token assign-left variable">K8S_DIR</span><span class="token operator">=</span>/etc/kubernetes\nkubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.1.111:6443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span><span class="token variable">${K8S_DIR}</span>/kube-proxy.kubeconfig\nkubectl config set-credentials kubernetes     <span class="token parameter variable">--token</span><span class="token operator">=</span><span class="token variable">${JWT_TOKEN}</span>     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig\nkubectl config set-context kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig\nkubectl config use-context kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在master01将kube-proxy的systemd Service文件发送到其他节点</p><p>如果更改了集群Pod的网段，需要更改kube-proxy/kube-proxy.conf的clusterCIDR: 172.16.0.0/12参数为pod的网段。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master01 k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span>\n     <span class="token function">scp</span> <span class="token variable">${K8S_DIR}</span>/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig\n     <span class="token function">scp</span> kube-proxy/kube-proxy.conf <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf\n     <span class="token function">scp</span> kube-proxy/kube-proxy.service <span class="token variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service\n <span class="token keyword">done</span>\n\n\n<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>\n     <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig\n     <span class="token function">scp</span> kube-proxy/kube-proxy.conf <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf\n     <span class="token function">scp</span> kube-proxy/kube-proxy.service <span class="token variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service\n <span class="token keyword">done</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>所有节点启动kube-proxy</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>\n<span class="token punctuation">[</span>root@k8s-master01 k8s-ha-install<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now kube-proxy</span>\nCreated symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /usr/lib/systemd/system/kube-proxy.service.\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安装-calico" tabindex="-1"><a class="header-anchor" href="#安装-calico" aria-hidden="true">#</a> 安装 Calico</h2><p><strong>以下步骤只在master01执行</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>$ cat calico<span class="token punctuation">-</span>etcd.yaml\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/calico-etcd-secrets.yaml</span>\n<span class="token comment"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span>\n<span class="token comment"># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret\n<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token key atrule">data</span><span class="token punctuation">:</span>\n  <span class="token comment"># Populate the following with etcd TLS configuration if desired, but leave blank if</span>\n  <span class="token comment"># not using TLS for etcd.</span>\n  <span class="token comment"># The keys below should be uncommented and the values populated with the base64</span>\n  <span class="token comment"># encoded contents of each file that would be associated with the TLS data.</span>\n  <span class="token comment"># Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0</span>\n  <span class="token comment"># etcd-key: null</span>\n  <span class="token comment"># etcd-cert: null</span>\n  <span class="token comment"># etcd-ca: null</span>\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/calico-config.yaml</span>\n<span class="token comment"># This ConfigMap is used to configure a self-hosted Calico installation.</span>\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token key atrule">data</span><span class="token punctuation">:</span>\n  <span class="token comment"># Configure this with the location of your etcd cluster.</span>\n  <span class="token key atrule">etcd_endpoints</span><span class="token punctuation">:</span> <span class="token string">&quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;</span>\n  <span class="token comment"># If you&#39;re using TLS enabled etcd uncomment the following.</span>\n  <span class="token comment"># You must also populate the Secret below with these files.</span>\n  <span class="token key atrule">etcd_ca</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>   <span class="token comment"># &quot;/calico-secrets/etcd-ca&quot;</span>\n  <span class="token key atrule">etcd_cert</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># &quot;/calico-secrets/etcd-cert&quot;</span>\n  <span class="token key atrule">etcd_key</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>  <span class="token comment"># &quot;/calico-secrets/etcd-key&quot;</span>\n  <span class="token comment"># Typha is disabled.</span>\n  <span class="token key atrule">typha_service_name</span><span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span>\n  <span class="token comment"># Configure the backend to use.</span>\n  <span class="token key atrule">calico_backend</span><span class="token punctuation">:</span> <span class="token string">&quot;bird&quot;</span>\n  <span class="token comment"># Configure the MTU to use for workload interfaces and tunnels.</span>\n  <span class="token comment"># - If Wireguard is enabled, set to your network MTU - 60</span>\n  <span class="token comment"># - Otherwise, if VXLAN or BPF mode is enabled, set to your network MTU - 50</span>\n  <span class="token comment"># - Otherwise, if IPIP is enabled, set to your network MTU - 20</span>\n  <span class="token comment"># - Otherwise, if not using any encapsulation, set to your network MTU.</span>\n  <span class="token key atrule">veth_mtu</span><span class="token punctuation">:</span> <span class="token string">&quot;1440&quot;</span>\n\n  <span class="token comment"># The CNI network configuration to install on each node. The special</span>\n  <span class="token comment"># values in this config will be automatically populated.</span>\n  <span class="token key atrule">cni_network_config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>\n    <span class="token punctuation">{</span>\n      <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s-pod-network&quot;</span><span class="token punctuation">,</span>\n      <span class="token key atrule">&quot;cniVersion&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;0.3.1&quot;</span><span class="token punctuation">,</span>\n      <span class="token key atrule">&quot;plugins&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n          <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;calico&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;log_level&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;etcd_endpoints&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_ENDPOINTS__&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;etcd_key_file&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_KEY_FILE__&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;etcd_cert_file&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_CERT_FILE__&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;etcd_ca_cert_file&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__ETCD_CA_CERT_FILE__&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;mtu&quot;</span><span class="token punctuation">:</span> __CNI_MTU__<span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;ipam&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;calico-ipam&quot;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;policy&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s&quot;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;kubernetes&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              <span class="token key atrule">&quot;kubeconfig&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;__KUBECONFIG_FILEPATH__&quot;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;portmap&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;snat&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;capabilities&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">&quot;portMappings&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          <span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bandwidth&quot;</span><span class="token punctuation">,</span>\n          <span class="token key atrule">&quot;capabilities&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">&quot;bandwidth&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/calico-kube-controllers-rbac.yaml</span>\n\n<span class="token comment"># Include a clusterrole for the kube-controllers component,</span>\n<span class="token comment"># and bind it to the calico-kube-controllers serviceaccount.</span>\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n<span class="token key atrule">rules</span><span class="token punctuation">:</span>\n  <span class="token comment"># Pods are monitored for changing labels.</span>\n  <span class="token comment"># The node controller monitors Kubernetes nodes.</span>\n  <span class="token comment"># Namespace and serviceaccount labels are used for policy.</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> pods\n      <span class="token punctuation">-</span> nodes\n      <span class="token punctuation">-</span> namespaces\n      <span class="token punctuation">-</span> serviceaccounts\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> watch\n      <span class="token punctuation">-</span> list\n      <span class="token punctuation">-</span> get\n  <span class="token comment"># Watch for changes to Kubernetes NetworkPolicies.</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;networking.k8s.io&quot;</span><span class="token punctuation">]</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> networkpolicies\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> watch\n      <span class="token punctuation">-</span> list\n<span class="token punctuation">---</span>\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token punctuation">---</span>\n\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/calico-node-rbac.yaml</span>\n<span class="token comment"># Include a clusterrole for the calico-node DaemonSet,</span>\n<span class="token comment"># and bind it to the calico-node serviceaccount.</span>\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n<span class="token key atrule">rules</span><span class="token punctuation">:</span>\n  <span class="token comment"># The CNI plugin needs to get pods, nodes, and namespaces.</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> pods\n      <span class="token punctuation">-</span> nodes\n      <span class="token punctuation">-</span> namespaces\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> get\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> endpoints\n      <span class="token punctuation">-</span> services\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token comment"># Used to discover service IPs for advertisement.</span>\n      <span class="token punctuation">-</span> watch\n      <span class="token punctuation">-</span> list\n  <span class="token comment"># Pod CIDR auto-detection on kubeadm needs access to config maps.</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> configmaps\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> get\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> nodes/status\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token comment"># Needed for clearing NodeNetworkUnavailable flag.</span>\n      <span class="token punctuation">-</span> patch\n\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/calico-node.yaml</span>\n<span class="token comment"># This manifest installs the calico-node container, as well</span>\n<span class="token comment"># as the CNI plugins and network config on</span>\n<span class="token comment"># each master and worker node in a Kubernetes cluster.</span>\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>\n      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>\n    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate\n    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>\n      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>\n  <span class="token key atrule">template</span><span class="token punctuation">:</span>\n    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n      <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n    <span class="token key atrule">spec</span><span class="token punctuation">:</span>\n      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>\n        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux\n      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>\n        <span class="token comment"># Make sure calico-node gets scheduled on all nodes.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule\n          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists\n        <span class="token comment"># Mark the pod as a critical add-on for rescheduling.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly\n          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists\n        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute\n          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists\n      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n      <span class="token comment"># Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a &quot;force</span>\n      <span class="token comment"># deletion&quot;: https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods.</span>\n      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>\n      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical\n      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>\n        <span class="token comment"># This container installs the CNI binaries</span>\n        <span class="token comment"># and CNI network config file on each node.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni\n          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/cni<span class="token punctuation">:</span>v3.15.3\n          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/install-cni.sh&quot;</span><span class="token punctuation">]</span>\n          <span class="token key atrule">env</span><span class="token punctuation">:</span>\n            <span class="token comment"># Name of the CNI config file to create.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_CONF_NAME\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;10-calico.conflist&quot;</span>\n            <span class="token comment"># The CNI network config to install on each node.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_NETWORK_CONFIG\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> cni_network_config\n            <span class="token comment"># The location of the etcd cluster.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints\n            <span class="token comment"># CNI MTU Config variable</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_MTU\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu\n            <span class="token comment"># Prevents the container from sleeping forever.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SLEEP\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>\n          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/opt/cni/bin\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>bin<span class="token punctuation">-</span>dir\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/etc/cni/net.d\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>net<span class="token punctuation">-</span>dir\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs\n          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>\n            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n        <span class="token comment"># Adds a Flex Volume Driver that creates a per-pod Unix Domain Socket to allow Dikastes</span>\n        <span class="token comment"># to communicate with Felix over the Policy Sync API.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver\n          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/pod2daemon<span class="token punctuation">-</span>flexvol<span class="token punctuation">:</span>v3.15.3\n          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>host\n            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/driver\n          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>\n            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n      <span class="token key atrule">containers</span><span class="token punctuation">:</span>\n        <span class="token comment"># Runs calico-node container on each Kubernetes node. This</span>\n        <span class="token comment"># container programs network policy and routes on each</span>\n        <span class="token comment"># host.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/node<span class="token punctuation">:</span>v3.15.3\n          <span class="token key atrule">env</span><span class="token punctuation">:</span>\n            <span class="token comment"># The location of the etcd cluster.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints\n            <span class="token comment"># Location of the CA certificate for etcd.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CA_CERT_FILE\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_ca\n            <span class="token comment"># Location of the client key for etcd.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_KEY_FILE\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_key\n            <span class="token comment"># Location of the client certificate for etcd.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CERT_FILE\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_cert\n            <span class="token comment"># Set noderef for node controller.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_K8S_NODE_REF\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName\n            <span class="token comment"># Choose the backend to use.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_NETWORKING_BACKEND\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> calico_backend\n            <span class="token comment"># Cluster type to identify the deployment type</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CLUSTER_TYPE\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s,bgp&quot;</span>\n            <span class="token comment"># Auto-detect the BGP IP address.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> IP\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;autodetect&quot;</span>\n            <span class="token comment"># Enable IPIP</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_IPIP\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;Always&quot;</span>\n            <span class="token comment"># Enable or Disable VXLAN on the default IP pool.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_VXLAN\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;Never&quot;</span>\n            <span class="token comment"># Set MTU for tunnel device used if ipip is enabled</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_IPINIPMTU\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu\n            <span class="token comment"># Set MTU for the VXLAN tunnel device.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_VXLANMTU\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu\n            <span class="token comment"># Set MTU for the Wireguard tunnel device.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_WIREGUARDMTU\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu\n            <span class="token comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span>\n            <span class="token comment"># chosen from this range. Changing this value after installation will have</span>\n            <span class="token comment"># no effect. This should fall within `--cluster-cidr`.</span>\n            <span class="token comment"># - name: CALICO_IPV4POOL_CIDR</span>\n            <span class="token comment">#   value: &quot;192.168.0.0/16&quot;</span>\n            <span class="token comment"># Disable file logging so `kubectl logs` works.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_DISABLE_FILE_LOGGING\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n            <span class="token comment"># Set Felix endpoint to host default action to ACCEPT.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_DEFAULTENDPOINTTOHOSTACTION\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;ACCEPT&quot;</span>\n            <span class="token comment"># Disable IPv6 on Kubernetes.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_IPV6SUPPORT\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>\n            <span class="token comment"># Set Felix logging to &quot;info&quot;</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_LOGSEVERITYSCREEN\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;info&quot;</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_HEALTHENABLED\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>\n            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n          <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n            <span class="token key atrule">requests</span><span class="token punctuation">:</span>\n              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 250m\n          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>\n            <span class="token key atrule">exec</span><span class="token punctuation">:</span>\n              <span class="token key atrule">command</span><span class="token punctuation">:</span>\n              <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node\n              <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>live\n              <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>live\n            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>\n          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>\n            <span class="token key atrule">exec</span><span class="token punctuation">:</span>\n              <span class="token key atrule">command</span><span class="token punctuation">:</span>\n              <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node\n              <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>ready\n              <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>ready\n            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /lib/modules\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> lib<span class="token punctuation">-</span>modules\n              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run/xtables.lock\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> xtables<span class="token punctuation">-</span>lock\n              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/calico\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>run<span class="token punctuation">-</span>calico\n              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/calico\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>lib<span class="token punctuation">-</span>calico\n              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> policysync\n              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/nodeagent\n      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n        <span class="token comment"># Used by calico-node.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lib<span class="token punctuation">-</span>modules\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /lib/modules\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>run<span class="token punctuation">-</span>calico\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/calico\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>lib<span class="token punctuation">-</span>calico\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/calico\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xtables<span class="token punctuation">-</span>lock\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run/xtables.lock\n            <span class="token key atrule">type</span><span class="token punctuation">:</span> FileOrCreate\n        <span class="token comment"># Used to install CNI.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>bin<span class="token punctuation">-</span>dir\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/cni/bin\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>net<span class="token punctuation">-</span>dir\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d\n        <span class="token comment"># Mount in the etcd TLS secrets with mode 400.</span>\n        <span class="token comment"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs\n          <span class="token key atrule">secret</span><span class="token punctuation">:</span>\n            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets\n            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0400</span>\n        <span class="token comment"># Used to create per-pod Unix Domain Sockets</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> policysync\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/nodeagent\n        <span class="token comment"># Used to install Flex Volume Driver</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>host\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/libexec/kubernetes/kubelet<span class="token punctuation">-</span>plugins/volume/exec/nodeagent~uds\n<span class="token punctuation">---</span>\n\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/calico-kube-controllers.yaml</span>\n<span class="token comment"># See https://github.com/projectcalico/kube-controllers</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token comment"># The controllers can only have a single active instance.</span>\n  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>\n      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>\n    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate\n  <span class="token key atrule">template</span><span class="token punctuation">:</span>\n    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n      <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n      <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n    <span class="token key atrule">spec</span><span class="token punctuation">:</span>\n      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>\n        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux\n      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>\n        <span class="token comment"># Mark the pod as a critical add-on for rescheduling.</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly\n          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists\n        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master\n          <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule\n      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical\n      <span class="token comment"># The controllers must run in the host network namespace so that</span>\n      <span class="token comment"># it isn&#39;t governed by policy that would prevent it from working.</span>\n      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n      <span class="token key atrule">containers</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/kube<span class="token punctuation">-</span>controllers<span class="token punctuation">:</span>v3.15.3\n          <span class="token key atrule">env</span><span class="token punctuation">:</span>\n            <span class="token comment"># The location of the etcd cluster.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints\n            <span class="token comment"># Location of the CA certificate for etcd.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CA_CERT_FILE\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_ca\n            <span class="token comment"># Location of the client key for etcd.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_KEY_FILE\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_key\n            <span class="token comment"># Location of the client certificate for etcd.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CERT_FILE\n              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>\n                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>\n                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config\n                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_cert\n            <span class="token comment"># Choose which controllers to run.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ENABLED_CONTROLLERS\n              <span class="token key atrule">value</span><span class="token punctuation">:</span> policy<span class="token punctuation">,</span>namespace<span class="token punctuation">,</span>serviceaccount<span class="token punctuation">,</span>workloadendpoint<span class="token punctuation">,</span>node\n          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>\n            <span class="token comment"># Mount in the etcd TLS secrets.</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs\n          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>\n            <span class="token key atrule">exec</span><span class="token punctuation">:</span>\n              <span class="token key atrule">command</span><span class="token punctuation">:</span>\n              <span class="token punctuation">-</span> /usr/bin/check<span class="token punctuation">-</span>status\n              <span class="token punctuation">-</span> <span class="token punctuation">-</span>r\n      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n        <span class="token comment"># Mount in the etcd TLS secrets with mode 400.</span>\n        <span class="token comment"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs\n          <span class="token key atrule">secret</span><span class="token punctuation">:</span>\n            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets\n            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0400</span>\n\n<span class="token punctuation">---</span>\n\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/calico-typha.yaml</span>\n\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/configure-canal.yaml</span>\n\n<span class="token punctuation">---</span>\n<span class="token comment"># Source: calico/templates/kdd-crds.yaml</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>修改calico-etcd.yaml的以下位置</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s#etcd_endpoints: &quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;#etcd_endpoints: &quot;https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379&quot;#g&#39;</span> calico-etcd.yaml\n\n<span class="token assign-left variable">ETCD_CA</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd-ca.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;\\n&#39;</span><span class="token variable">`</span></span>\n<span class="token assign-left variable">ETCD_CERT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;\\n&#39;</span><span class="token variable">`</span></span>\n<span class="token assign-left variable">ETCD_KEY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/kubernetes/pki/etcd/etcd-key.pem <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;\\n&#39;</span><span class="token variable">`</span></span>\n\n<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s@# etcd-key: null@etcd-key: <span class="token variable">${ETCD_KEY}</span>@g; s@# etcd-cert: null@etcd-cert: <span class="token variable">${ETCD_CERT}</span>@g; s@# etcd-ca: null@etcd-ca: <span class="token variable">${ETCD_CA}</span>@g&quot;</span> calico-etcd.yaml\n\n\n<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s#etcd_ca: &quot;&quot;#etcd_ca: &quot;/calico-secrets/etcd-ca&quot;#g; s#etcd_cert: &quot;&quot;#etcd_cert: &quot;/calico-secrets/etcd-cert&quot;#g; s#etcd_key: &quot;&quot; #etcd_key: &quot;/calico-secrets/etcd-key&quot; #g&#39;</span> calico-etcd.yaml\n\n<span class="token comment"># 更改此处为自己的pod网段</span>\n<span class="token assign-left variable">POD_SUBNET</span><span class="token operator">=</span><span class="token string">&quot;172.16.0.0/12&quot;</span>\n\n<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s@# - name: CALICO_IPV4POOL_CIDR@- name: CALICO_IPV4POOL_CIDR@g; s@#   value: &quot;192.168.0.0/16&quot;@  value: &#39;</span>&quot;<span class="token variable">${POD_SUBNET}</span>&quot;<span class="token string">&#39;@g&#39;</span> calico-etcd.yaml\n\nkubectl apply <span class="token parameter variable">-f</span> calico-etcd.yaml\n\n<span class="token comment"># 查看容器状态</span>\n<span class="token punctuation">[</span>root@k8s-master01 calico<span class="token punctuation">]</span><span class="token comment"># kubectl  get po -n kube-system</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安装-coredns" tabindex="-1"><a class="header-anchor" href="#安装-coredns" aria-hidden="true">#</a> 安装 CoreDNS</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/coredns/deployment.git\n<span class="token builtin class-name">cd</span> deployment/kubernetes\n<span class="token comment"># ./deploy.sh -s -i 10.96.0.10 | kubectl apply -f -</span>\nserviceaccount/coredns created\nclusterrole.rbac.authorization.k8s.io/system:coredns created\nclusterrolebinding.rbac.authorization.k8s.io/system:coredns created\nconfigmap/coredns created\ndeployment.apps/coredns created\nservice/kube-dns created\n查看状态\n <span class="token comment"># kubectl get po -n kube-system -l k8s-app=kube-dns</span>\nNAME                       READY   STATUS    RESTARTS   AGE\ncoredns-85b4878f78-h29kh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8h\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安装-metrics-server" tabindex="-1"><a class="header-anchor" href="#安装-metrics-server" aria-hidden="true">#</a> 安装 Metrics Server</h2><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>cat metrics<span class="token punctuation">-</span>server.yml\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-admin</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-view</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>aggregated<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>reader\n<span class="token key atrule">rules</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> metrics.k8s.io\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> pods\n      <span class="token punctuation">-</span> nodes\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> get\n      <span class="token punctuation">-</span> list\n      <span class="token punctuation">-</span> watch\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server\n<span class="token key atrule">rules</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>\n    <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> pods\n      <span class="token punctuation">-</span> nodes\n      <span class="token punctuation">-</span> nodes/stats\n      <span class="token punctuation">-</span> namespaces\n      <span class="token punctuation">-</span> configmaps\n    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> get\n      <span class="token punctuation">-</span> list\n      <span class="token punctuation">-</span> watch\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>reader\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> extension<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>reader\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server\n<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>\n  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io\n  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server\n<span class="token key atrule">subjects</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https\n      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>\n      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP\n      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> https\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>\n      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>\n    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>\n      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token key atrule">template</span><span class="token punctuation">:</span>\n    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n      <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n    <span class="token key atrule">spec</span><span class="token punctuation">:</span>\n      <span class="token key atrule">containers</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>dir=/tmp\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secure<span class="token punctuation">-</span>port=4443\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metric<span class="token punctuation">-</span>resolution=30s\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>tls\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>preferred<span class="token punctuation">-</span>address<span class="token punctuation">-</span>types=InternalIP<span class="token punctuation">,</span>ExternalIP<span class="token punctuation">,</span>Hostname\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/front<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ca.pem <span class="token comment"># change to front-proxy-ca.crt for kubeadm</span>\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>username<span class="token punctuation">-</span>headers=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>User\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>group<span class="token punctuation">-</span>headers=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>Group\n            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>extra<span class="token punctuation">-</span>headers<span class="token punctuation">-</span>prefix=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>Extra<span class="token punctuation">-</span>\n          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>v0.4.1\n          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent\n          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>\n            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>\n            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>\n              <span class="token key atrule">path</span><span class="token punctuation">:</span> /livez\n              <span class="token key atrule">port</span><span class="token punctuation">:</span> https\n              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS\n            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n          <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n          <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">4443</span>\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> https\n              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP\n          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>\n            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>\n            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>\n              <span class="token key atrule">path</span><span class="token punctuation">:</span> /readyz\n              <span class="token key atrule">port</span><span class="token punctuation">:</span> https\n              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS\n            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>\n            <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n            <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>\n          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp\n              <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir\n            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>ssl\n              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/pki\n      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>\n        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux\n      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical\n      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n          <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>ssl\n          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/pki\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiregistration.k8s.io/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> APIService\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> v1beta1.metrics.k8s.io\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">group</span><span class="token punctuation">:</span> metrics.k8s.io\n  <span class="token key atrule">groupPriorityMinimum</span><span class="token punctuation">:</span> <span class="token number">100</span>\n  <span class="token key atrule">insecureSkipTLSVerify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n  <span class="token key atrule">service</span><span class="token punctuation">:</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server\n    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system\n  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1beta1\n  <span class="token key atrule">versionPriority</span><span class="token punctuation">:</span> <span class="token number">100</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl  create <span class="token parameter variable">-f</span> metrics-server.yml\nserviceaccount/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\nservice/metrics-server created\ndeployment.apps/metrics-server created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\n\n<span class="token comment"># 等待metrics server启动然后查看状态</span>\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  top node</span>\nNAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%   \nk8s-master01   231m         <span class="token number">5</span>%     1620Mi          <span class="token number">42</span>%       \nk8s-master02   274m         <span class="token number">6</span>%     1203Mi          <span class="token number">31</span>%       \nk8s-master03   202m         <span class="token number">5</span>%     1251Mi          <span class="token number">32</span>%       \nk8s-node01     69m          <span class="token number">1</span>%     667Mi           <span class="token number">17</span>%       \nk8s-node02     73m          <span class="token number">1</span>%     650Mi           <span class="token number">16</span>%\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="集群验证" tabindex="-1"><a class="header-anchor" href="#集群验证" aria-hidden="true">#</a> 集群验证</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>\nNAME           STATUS   ROLES    AGE     VERSION\nk8s-master01   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   9h      v1.20.13\nk8s-master02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   9h      v1.20.13\nk8s-master03   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   9h      v1.20.13\nk8s-node01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   6h22m   v1.20.13\nk8s-node02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   6h23m   v1.20.13\n\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cs</span>\nWarning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+\nNAME                 STATUS    MESSAGE             ERROR\nscheduler            Healthy   ok                  \ncontroller-manager   Healthy   ok                  \netcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   \netcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   \netcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>  \n\n<span class="token comment"># 如上查看集群状态一切正常 </span>\n\n<span class="token comment"># 接下来运行个Pod验证下</span>\ncat<span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -</span>\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox\n  namespace: default\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    command:\n      - sleep\n      - &quot;3600&quot;\n    imagePullPolicy: IfNotPresent\n  restartPolicy: Always\nEOF</span>\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>\nNAME      READY   STATUS    RESTARTS   AGE\nbusybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s\n<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it busybox sh</span>\nkubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.\n/ <span class="token comment"># ping www.baidu.com</span>\nPING www.baidu.com <span class="token punctuation">(</span><span class="token number">180.101</span>.49.11<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">180.101</span>.49.11: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">49</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">12.058</span> ms\n^C\n--- www.baidu.com <span class="token function">ping</span> statistics ---\n<span class="token number">2</span> packets transmitted, <span class="token number">1</span> packets received, <span class="token number">50</span>% packet loss\nround-trip min/avg/max <span class="token operator">=</span> <span class="token number">12.058</span>/12.058/12.058 ms\n/ <span class="token comment"># ping busybox</span>\nPING busybox <span class="token punctuation">(</span><span class="token number">172.17</span>.125.1<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">172.17</span>.125.1: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.050</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.17</span>.125.1: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.062</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.17</span>.125.1: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.050</span> ms\n^C\n--- busybox <span class="token function">ping</span> statistics ---\n<span class="token number">3</span> packets transmitted, <span class="token number">3</span> packets received, <span class="token number">0</span>% packet loss\nround-trip min/avg/max <span class="token operator">=</span> <span class="token number">0.050</span>/0.054/0.062 ms\n\n<span class="token comment"># 运行Pod验证一切正常</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>', 180);
const _hoisted_183 = [
  _hoisted_1,
  _hoisted_2,
  _hoisted_3
];
function _sfc_render(_ctx, _cache) {
  return openBlock(), createElementBlock("div", null, _hoisted_183);
}
const qiyejigaokeyongKubernetes1_20_xjiqun_erjinzhi__html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "qiyejigaokeyongKubernetes1.20.xjiqun(erjinzhi).html.vue"]]);
export {
  qiyejigaokeyongKubernetes1_20_xjiqun_erjinzhi__html as default
};
