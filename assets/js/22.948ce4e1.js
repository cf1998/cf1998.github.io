(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{449:function(s,a,t){"use strict";t.r(a);var n=t(16),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"手动实现备份与恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#手动实现备份与恢复"}},[s._v("#")]),s._v(" "),t("strong",[s._v("手动实现备份与恢复")])]),s._v(" "),t("p",[s._v("ClickHouse 允许使用 ALTER TABLE ... FREEZE PARTITION ... 查询以创建表分区的本地副本。 这是利用硬链接(hardlink)到 /var/lib/clickhouse/shadow/ 文件夹中实现的，所以它通常不会\n因为旧数据而占用额外的磁盘空间。 创建的文件副本不由 ClickHouse 服务器处理，所以不需要任何额外的外部系统就有一个简单的备份。防止硬件问题，最好将它们远程复制到另一个位置，然后删除本地副本。\n")]),s._v(" "),t("h3",{attrs:{id:"创建测试数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建测试数据"}},[s._v("#")]),s._v(" 创建测试数据")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("clickhouse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" :"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("IF")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXISTS")]),s._v(" user_local\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" Int32"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" String\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" MergeTree\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PARTITION")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" id\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" id\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ORDER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" id\n\nQuery id: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("f911865"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f883"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("46")]),s._v("e2"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8721")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("ba4f62d6286\n\nOk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Elapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.007")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" \n\nclickhouse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" :"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" user_local "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'tom'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'jack'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" user_local "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v("\n\nQuery id: f32e2378"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("d76"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4865")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a65c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18398")]),s._v("eff5bc6\n\nOk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Elapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.004")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" \n\nclickhouse"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" :"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" user_local"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" user_local\n\nQuery id: faafe57b"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("fe"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("ad3"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("b2c2"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("84293193")]),s._v("a5dd\n\n┌─id─┬─name─┐\n│  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" │ jack │\n└────┴──────┘\n┌─id─┬─name─┐\n│  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" │ tom  │\n└────┴──────┘\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Elapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.004")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" \n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br")])]),t("h3",{attrs:{id:"创建备份路径"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建备份路径"}},[s._v("#")]),s._v(" 创建备份路径")]),s._v(" "),t("p",[s._v("创建用于存放备份数据的目录 shadow")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/lib/clickhouse/shadow/\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R clickhouse.clickhouse /var/lib/clickhouse/shadow/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"执行备份命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行备份命令"}},[s._v("#")]),s._v(" "),t("strong",[s._v("执行备份命令")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'alter table user_local freeze'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" clickhouse-client -h clickhouse-1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"将备份数据保存到其他路径"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#将备份数据保存到其他路径"}},[s._v("#")]),s._v(" "),t("strong",[s._v("将备份数据保存到其他路径")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#创建备份存储路径")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/lib/clickhouse/backup/ "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#拷贝数据到备份路径")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -r /var/lib/clickhouse/shadow/ /var/lib/clickhouse/backup/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%F"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#为下次备份准备，删除 shadow 下的数据")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /var/lib/clickhouse/shadow/*\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R clickhouse.clickhouse /var/lib/clickhouse/backup/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%F"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n$ ll /var/lib/clickhouse/backup/\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndrwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" clickhouse clickhouse "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36")]),s._v(" Oct "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":06 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-27\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h3",{attrs:{id:"恢复数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#恢复数据"}},[s._v("#")]),s._v(" 恢复数据")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 模拟删除备份过的表")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'drop table user_local'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" clickhouse-client -h clickhouse-1\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建恢复表结构")]),s._v("\n\nCREATE TABLE IF NOT EXISTS user_local\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" Int32,\n    "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" String\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nENGINE "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" MergeTree\nPARTITION BY "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\nPRIMARY KEY "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\nORDER BY "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n\nQuery id: 9c527b4c-edc7-4a20-9541-1778a2cc08d2\n\nOk.\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将备份复制到 detached 目录")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -rl /var/lib/clickhouse/backup/2021-10-27/1/store/631/631ffb48-6e2b-4db0-a31f-fb486e2badb0/* /var/lib/clickhouse/data/default/user_local/detached/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看partition")]),s._v("\nclickhouse-1 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Select partition,name, database, table,path from system.parts where table "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user_local'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nQuery id: f6e7ea0f-3ec7-40de-90b7-6f5204790de0\n\n┌─partition─┬─name────┬─database─┬─table──────┬─path────────────────────────────────────────────────────────────────────────┐\n│ "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         │ 1_1_1_0 │ default  │ user_local │ /var/lib/clickhouse/store/fc2/fc2510ad-fe9e-4718-bc25-10adfe9e2718/1_1_1_0/ │\n│ "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         │ 2_2_2_0 │ default  │ user_local │ /var/lib/clickhouse/store/fc2/fc2510ad-fe9e-4718-bc25-10adfe9e2718/2_2_2_0/ │\n└───────────┴─────────┴──────────┴────────────┴─────────────────────────────────────────────────────────────────────────────┘\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" rows "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" set. Elapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.004")]),s._v(" sec. \n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行 attach")]),s._v("\nclickhouse-1 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" alter table user_local attach partition "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nclickhouse-1 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" alter table user_local attach partition "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看数据")]),s._v("\n\nclickhouse-1 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from user_local"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nQuery id: 7d64a272-c89b-4fd7-a327-a1f257815d9a\n\n┌─id─┬─name─┐\n│  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" │ jack │\n└────┴──────┘\n┌─id─┬─name─┐\n│  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" │ tom  │\n└────┴──────┘\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" rows "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" set. Elapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.003")]),s._v(" sec. \n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br")])]),t("p",[s._v("ClickHouse 使用文件系统硬链接来实现即时备份，而不会导致 ClickHouse 服务停机（或")]),s._v(" "),t("p",[s._v("锁定）。这些硬链接可以进一步用于有效的备份存储。在支持硬链接的文件系统（例如本地")]),s._v(" "),t("p",[s._v("文件系统或 NFS）上，将 cp 与-l 标志一起使用（或将 rsync 与–hard-links 和–numeric-ids 标志")]),s._v(" "),t("p",[s._v("一起使用）以避免复制数据")]),s._v(" "),t("h2",{attrs:{id:"clickhouse-backup-备份工具"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#clickhouse-backup-备份工具"}},[s._v("#")]),s._v(" **clickhouse-backup **备份工具")]),s._v(" "),t("p",[s._v("使用 Clickhouse 的备份工具 clickhouse-backup 帮我们自动化实现。")]),s._v(" "),t("p",[s._v("工具地址：https://github.com/AlexAkulov/clickhouse-backup/")]),s._v(" "),t("h3",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget https://github.com/AlexAkulov/clickhouse-backup/releases/download/1.2.0/clickhouse-backup-1.2.0-1.x86_64.rpm")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ivh clickhouse-backup-1.2.0-1.x86_64.rpm ")]),s._v("\nPreparing"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("################################# [100%]")]),s._v("\nUpdating / installing"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":clickhouse-backup-1.2.0-1        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("################################# [100%]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"创建备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建备份"}},[s._v("#")]),s._v(" "),t("strong",[s._v("创建备份")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看可用命令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# clickhouse-backup help")]),s._v("\nNAME:\n   clickhouse-backup - Tool "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" easy backup of ClickHouse with cloud support\n\nUSAGE:\n   clickhouse-backup "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("command"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-t, --tables"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("backup_name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\nVERSION:\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".0\n\nDESCRIPTION:\n   Run as "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v(" or "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'clickhouse'")]),s._v(" user\n\nCOMMANDS:\n   tables          Print list of tables\n   create          Create new backup\n   create_remote   Create and upload\n   upload          Upload backup to remote storage\n   list            Print list of backups\n   download        Download backup from remote storage\n   restore         Create schema and restore data from backup\n   restore_remote  Download and restore\n   delete          Delete specific backup\n   default-config  Print default config\n   server          Run API server\n   help, h         Shows a list of commands or "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("help")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" one "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v("\n\nGLOBAL OPTIONS:\n   --config FILE, -c FILE  Config FILE name. "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/clickhouse-backup/config.yml"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CLICKHOUSE_BACKUP_CONFIG")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n   --help, -h              show "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("help")]),s._v("\n   --version, -v           print the version\n   \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示要备份的表")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# clickhouse-backup tables")]),s._v("\ndefault.st_order_mt       293B  default  \ndefault.st_order_mt_all2  0B    default  \ndefault.user_local        323B  default  \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建备份")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sudo clickhouse-backup create")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("/10/27 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":47:15  info "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("                      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("backup")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-27T09-47-15 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("create "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default.st_order_mt\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("/10/27 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":47:15  info "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("                      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("backup")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-27T09-47-15 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("create "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default.st_order_mt_all2\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("/10/27 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":47:15  info "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("                      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("backup")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-27T09-47-15 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("create "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default.user_local\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("/10/27 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":47:15  info "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("                      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("backup")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-27T09-47-15 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("90ms "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("create\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看现有的本地备份")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# clickhouse-backup list")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-27                 ???       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("/10/2021 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":06:32   "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("      \n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("help")]),s._v("                       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".96KiB   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("/10/2021 09:46:46   "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("      \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default.user_local   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".96KiB   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("/10/2021 09:47:03   "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("      \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-27T09-47-15        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".96KiB   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("/10/2021 09:47:15   "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("  \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br")])]),t("p",[s._v("备份存储在中/var/lib/clickhouse/backup/BACKUPNAME。备份名称默认为时间戳，但是 可以选择使用–name 标志指定备份名称。备份包含两个目录：一个“metadata”目录，其中包 含重新创建架构所需的 DDL SQL 语句；以及一个“shadow”目录，其中包含作为 ALTER TABLE ...  FREEZE 操作结果的数据")]),s._v(" "),t("h3",{attrs:{id:"从备份恢复数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#从备份恢复数据"}},[s._v("#")]),s._v(" "),t("strong",[s._v("从备份恢复数据")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 模拟删除备份过的表")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 'drop table user_local' | clickhouse-client -h clickhouse-1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从备份还原")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@clickhouse-1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# clickhouse-backup restore 2021-10-27T09-47-15 --table default.user_local;")]),s._v("\n\n--schema 参数：只还原表结构。\n--data 参数：只还原数据。\n--table 参数：备份（或还原）特定表。也可以使用一个正则表达式，例如，针对特定的数据库：--table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("dbname.*。\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 确认数据是否恢复")]),s._v("\n\nclickhouse-1 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from user_local"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nSELECT *\nFROM user_local\n\nQuery id: f4fa929c-4a85-48a5-b540-7278a1ef0e3f\n\n┌─id─┬─name─┐\n│  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" │ jack │\n└────┴──────┘\n┌─id─┬─name─┐\n│  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" │ tom  │\n└────┴──────┘\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" rows "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" set. Elapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.004")]),s._v(" sec. \n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("h2",{attrs:{id:"补充"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#补充"}},[s._v("#")]),s._v(" 补充")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("API 文档：https : //github.com/AlexAkulov/clickhouse-backup#api")])]),s._v(" "),t("li",[t("p",[s._v("注意事项：切勿更改文件夹/var/lib/clickhouse/backup 的权限，可能会导致数据损坏。")])]),s._v(" "),t("li",[t("p",[s._v("远程备份")])])]),s._v(" "),t("p",[s._v("1）较新版本才支持，需要设置 config 里的 s3 相关配置")]),s._v(" "),t("p",[s._v("2）上传到远程存储：sudo clickhouse-backup upload xxxx")]),s._v(" "),t("p",[s._v("3）从远程存储下载：sudo clickhouse-backup download xxxx")]),s._v(" "),t("p",[s._v("4）保存周期： backups_to_keep_local，本地保存周期，单位天")]),s._v(" "),t("p",[s._v("​                         backups_to_keep_remote，远程存储保存周期，单位天")]),s._v(" "),t("p",[s._v("​                         0 均表示不删除")])])}),[],!1,null,null,null);a.default=e.exports}}]);