(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{449:function(s,t,e){"use strict";e.r(t);var a=e(16),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("在Kubernetes架构中，Etcd作为Kubernetes的元数据存储，在创建一个Pod时，Etcd背后是如何工作，接下来会通过具体的案例进行一步一步机进行分析！\n")]),s._v(" "),e("h2",{attrs:{id:"etcd-存储概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#etcd-存储概念"}},[s._v("#")]),s._v(" Etcd 存储概念")]),s._v(" "),e("h3",{attrs:{id:"kubernetes-资源存储格式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-资源存储格式"}},[s._v("#")]),s._v(" kubernetes 资源存储格式")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("/registry/deployments/default/nginx-deployment\n/registry/events/default/nginx-deployment-66b6c48dd5-gl7zl.16c35febf6e3c38c\n/registry/events/default/nginx-deployment-66b6c48dd5-gl7zl.16c35fec1db96fed\n/registry/events/default/nginx-deployment-66b6c48dd5-gl7zl.16c35fec1fdba240\n/registry/events/default/nginx-deployment-66b6c48dd5-gl7zl.16c35fec249adf98\n/registry/events/default/nginx-deployment-66b6c48dd5-k55k7.16c35edbfa8784f8\n/registry/events/default/nginx-deployment-66b6c48dd5-w9br6.16c35eeb78bfa621\n/registry/events/default/nginx-deployment-66b6c48dd5-w9br6.16c35eeba0a4694f\n/registry/events/default/nginx-deployment-66b6c48dd5-w9br6.16c35eeba259230a\n/registry/events/default/nginx-deployment-66b6c48dd5-w9br6.16c35eeba7251388\n/registry/events/default/nginx-deployment-66b6c48dd5-w9br6.16c35fda25f0af06\n/registry/events/default/nginx-deployment-66b6c48dd5.16c35eeb788d245f\n/registry/events/default/nginx-deployment-66b6c48dd5.16c35febf6bb59a0\n/registry/events/default/nginx-deployment.16c35eeb77fc2ef0\n/registry/events/default/nginx-deployment.16c35febf56d6b96\n/registry/pods/default/nginx-deployment-66b6c48dd5-gl7zl\n/registry/replicasets/default/nginx-deployment-66b6c48dd5\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("p",[s._v('Kubernetes 资源在 etcd 中的存储格式由 prefix + "/" + 资源类型 + "/" + namespace + "/" + 具体资源名组成')]),s._v(" "),e("h3",{attrs:{id:"存储模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#存储模块"}},[s._v("#")]),s._v(" 存储模块")]),s._v(" "),e("p",[s._v("kube-apiserver 启动的时候，会将每个资源的 APIGroup、Version、Resource Handler 注册到路由上。当请求经过认证、限速、授权、准入控制模块检查后，请求就会被转发到对应的资源逻辑进行处理。")]),s._v(" "),e("p",[s._v("同时，kube-apiserver 实现了类似数据库 ORM 机制的通用资源存储机制，提供了对一个资源创建、更新、删除前后的 hook 能力，将其封装成策略接口。当你新增一个资源时，你只需要编写相应的创建、更新、删除等策略即可，不需要写任何 etcd 的 API。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://kubesre.com/img/etcd/etcd3.webp",alt:""}})]),s._v(" "),e("p",[s._v("从图中你可以看到，创建一个资源主要由 BeforeCreate、Storage.Create 以及 AfterCreate 三大步骤组成 ;")]),s._v(" "),e("p",[s._v("当收到创建 nginx Deployment 请求后，通用存储模块首先会回调各个资源自定义实现的 BeforeCreate 策略，为资源写入 etcd 做一些初始化工作。下面是 Deployment 资源的创建策略实现，它会进行将 deployment.Generation 设置为 1 等操作。")]),s._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// PrepareForCreate clears fields that are not allowed to be set by end users on creation.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deploymentStrategy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("PrepareForCreate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" obj runtime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Object"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   deployment "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" obj"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("apps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Deployment"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   deployment"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Status "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" apps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DeploymentStatus"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n   deployment"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Generation "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n   pod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("DropDisabledTemplateFields")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("deployment"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Spec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Template"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("执行完 BeforeCreate 策略后，它就会执行 Storage.Create 接口，也就是由它真正开始调用底层存储模块 etcd3，将 nginx Deployment 资源对象写入 etcd。")]),s._v(" "),e("h3",{attrs:{id:"资源安全创建及更新"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#资源安全创建及更新"}},[s._v("#")]),s._v(" 资源安全创建及更新")]),s._v(" "),e("p",[s._v("etcd 提供了 Put 和 Txn 接口给业务添加 key-value 数据，但是 Put 接口在并发场景下若收到 key 相同的资源创建，就会导致被覆盖。")]),s._v(" "),e("p",[s._v("因此 Kubernetes 很显然无法直接通过 etcd Put 接口来写入数据。")]),s._v(" "),e("p",[s._v("etcd 事务接口 Txn，它正是为了多 key 原子更新、并发操作安全性等而诞生的，它提供了丰富的冲突检查机制。")]),s._v(" "),e("p",[s._v("Kubernetes 集群使用的正是事务 Txn 接口来防止并发创建、更新被覆盖等问题。当执行完 BeforeCreate 策略后，这时 kube-apiserver 就会调用 Storage 的模块的 Create 接口写入资源。1.6 版本后的 Kubernete 集群默认使用的存储是 etcd3，它的创建接口简要实现如下：")]),s._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Create implements storage.Interface.Create.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("store"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("Create")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" obj"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" out runtime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Object"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ttl "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint64")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n   key "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("Join")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pathPrefix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n   opts"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ttlOpts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("int64")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ttl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" err\n   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n   newData"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("transformer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("TransformToStorage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("authenticatedDataString")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" storage"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewInternalError")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("Error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n   startTime "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("Now")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   txnResp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("KV"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("Txn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("If")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("notFound")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("Then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      clientv3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("OpPut")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("newData"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" opts"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Commit\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("从上面的代码片段中，我们可以得出首先它会按照我们介绍的 Kubernetes 资源存储格式拼接 key。")]),s._v(" "),e("p",[s._v("然后若 TTL 非 0，它会根据 TTL 从 leaseManager 获取可复用的 Lease ID。Kubernetes 集群默认若不同 key（如 Kubernetes 的 Event 资源对象）的 TTL 差异在 1 分钟内，可复用同一个 Lease ID，避免大量 Lease 影响 etcd 性能和稳定性。")]),s._v(" "),e("p",[s._v("其次若开启了数据加密，在写入 etcd 前数据还将按加密算法进行转换工作。最后就是使用 etcd 的 Txn 接口，向 etcd 发起一个创建 deployment 资源的 Txn 请求。")]),s._v(" "),e("h3",{attrs:{id:"resource-version"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resource-version"}},[s._v("#")]),s._v(" Resource Version")]),s._v(" "),e("p",[s._v("Resource Version 是 Kubernetes API 中非常重要的一个概念，顾名思义，它是一个 Kubernetes 资源的内部版本字符串，client 可通过它来判断资源是否发生了变化。同时，你可以在 Get、List、Watch 接口中，通过指定 Resource Version 值来满足你对数据一致性、高性能等诉求。")]),s._v(" "),e("ul",[e("li",[s._v("未指定 ResourceVersion，默认空字符串。kube-apiserver 收到一个此类型的读请求后，它会向 etcd 发出共识读 / 线性读请求获取 etcd 集群最新的数据。")]),s._v(" "),e("li",[s._v('ResourceVersion="0"，赋值字符串 0。kube-apiserver 收到此类请求时，它可能会返回任意资源版本号的数据，但是优先返回较新版本。一般情况下它直接从 kube-apiserver 缓存中获取数据返回给 client，有可能读到过期的数据，适用于对数据一致性要求不高的场景。')]),s._v(" "),e("li",[s._v("ResourceVersion 为一个非 0 的字符串。kube-apiserver 收到此类请求时，它会保证 Cache 中的最新 ResourceVersion 大于等于你传入的 ResourceVersion，然后从 Cache 中查找你请求的资源对象 key，返回数据给 client。基本原理是 kube-apiserver 为各个核心资源（如 Pod）维护了一个 Cache，通过 etcd 的 Watch 机制来实时更新 Cache。当你的 Get 请求中携带了非 0 的 ResourceVersion，它会等待缓存中最新 ResourceVersion 大于等于你 Get 请求中的 ResoureVersion，若满足条件则从 Cache 中查询数据，返回给 client。若不满足条件，它最多等待 3 秒，若超过 3 秒，Cache 中的最新 ResourceVersion 还小于 Get 请求中的 ResourceVersion，就会返回 ResourceVersionTooLarge 错误给 client。")])]),s._v(" "),e("h2",{attrs:{id:"etcd交互分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#etcd交互分析"}},[s._v("#")]),s._v(" Etcd交互分析")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://kubesre.com/img/etcd/etcd4.png",alt:""}})]),s._v(" "),e("p",[e("strong",[s._v("Kubernetes组件概述")])]),s._v(" "),e("ul",[e("li",[s._v("kube-apiserver，负责对外提供集群各类资源的增删改查及 Watch 接口，它是 Kubernetes 集群中各组件数据交互和通信的枢纽。kube-apiserver 在设计上可水平扩展，高可用 Kubernetes 集群中一般多副本部署。当收到一个创建 Pod 写请求时，它的基本流程是对请求进行认证、限速、授权、准入机制等检查后，写入到 etcd 即可。")]),s._v(" "),e("li",[s._v("kube-scheduler 是调度器组件，负责集群 Pod 的调度。基本原理是通过监听 kube-apiserver 获取待调度的 Pod，然后基于一系列筛选和评优算法，为 Pod 分配最佳的 Node 节点。")]),s._v(" "),e("li",[s._v("kube-controller-manager 包含一系列的控制器组件，比如 Deployment、StatefulSet 等控制器。控制器的核心思想是监听、比较资源实际状态与期望状态是否一致，若不一致则进行协调工作使其最终一致。")]),s._v(" "),e("li",[s._v("etcd 组件，Kubernetes 的元数据存储。")]),s._v(" "),e("li",[s._v("kubelet，部署在每个节点上的 Agent 的组件，负责 Pod 的创建运行。基本原理是通过监听 APIServer 获取分配到其节点上的 Pod，然后根据 Pod 的规格详情，调用运行时组件创建 pause 和业务容器等。")])]),s._v(" "),e("p",[s._v("首先我们通过 kubectl create -f nginx.yml 命令创建 Deployment 资源，发送请求到kube-apiserver。")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deployment\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.14.2\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n\n$ kubectl create "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f nginx.yml\ndeployment.apps/nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deployment created\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[s._v("kube-apiserver会接收到创建 nginx deployment 资源的请求日志，并通过 Txn 接口成功将数据写入到 etcd 后，kubectl create -f nginx.yml 命令就执行完毕，返回给 client 了")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etcd 收到创建 nginx deployment 资源的请求日志：")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.320328 D "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" etcdserver/api/v3rpc: start "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.319917473 +0000 UTC "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("m")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("+416.447615057, "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" spent "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("386.445")]),s._v("µs, remote "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:45596, response "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etcdserverpb.KV/Txn, request count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", request size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1769")]),s._v(", response count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", response size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(", request content "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" compare:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("target:MOD key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/deployments/default/nginx-deployment"')]),s._v(" mod_revision:0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" success:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("request_put:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/deployments/default/nginx-deployment"')]),s._v(" value_size:1715 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" failure:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("strong",[s._v("解释：")])]),s._v(" "),e("ul",[e("li",[s._v("请求的模块和接口，KV/Txn；")]),s._v(" "),e("li",[s._v('key 路径，/registry/deployments/default/nginx-deployment，由 prefix + "/" + 资源类型 + "/" + namespace + "/" + 具体资源名组成；')]),s._v(" "),e("li",[s._v("安全的并发创建检查机制，mod_revision 为 0 时，也就是此 key 不存在时，才允许执行 put 更新操作。")])]),s._v(" "),e("p",[s._v("kube-controller-manager通过Watch机制，快速感知到新建Depolyement 资源后，进入一致性协调逻辑，创建 ReplicaSet 控制器。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etcd 收到创建 ReplicaSet 资源的请求日志：")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.331340 D "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" etcdserver/api/v3rpc: start "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.330695394 +0000 UTC "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("m")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("+416.458392972, "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" spent "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("584.196")]),s._v("µs, remote "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:45564, response "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etcdserverpb.KV/Txn, request count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", request size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1806")]),s._v(", response count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", response size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(", request content "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" compare:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("target:MOD key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/replicasets/default/nginx-deployment-66b6c48dd5"')]),s._v(" mod_revision:0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" success:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("request_put:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/replicasets/default/nginx-deployment-66b6c48dd5"')]),s._v(" value_size:1741\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("kube-controller-manager并会通过通过Watch机制感知到新的ReplicaSet 资源创建后，发起请求创建 Pod，确保实际运行 Pod 数与期望一致。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.353609 D "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" etcdserver/api/v3rpc: start "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.353112742 +0000 UTC "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("m")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("+416.480810323, "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" spent "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("474.04")]),s._v("µs, remote "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:45628, response "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etcdserverpb.KV/Txn, request count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", request size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1637")]),s._v(", response count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", response size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(", request content "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" compare:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("target:MOD key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/pods/default/nginx-deployment-66b6c48dd5-gl7zl"')]),s._v(" mod_revision:0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" success:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("request_put:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/pods/default/nginx-deployment-66b6c48dd5-gl7zl"')]),s._v(" value_size:1573 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("在这过程中产生了 若干 Event，下面是 etcd 收到新增 Events 资源的请求，你可以看到 Event 事件 key 关联了 Lease；")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.356776 D "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" etcdserver/api/v3rpc: start "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-12-23 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":49:16.356368351 +0000 UTC "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("m")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("+416.484065931, "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" spent "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("388.188")]),s._v("µs, remote "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:45590, response "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etcdserverpb.KV/Txn, request count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", request size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("776")]),s._v(", response count "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", response size "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v(", request content "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" compare:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("target:MOD key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/events/default/nginx-deployment-66b6c48dd5.16c35febf6bb59a0"')]),s._v(" mod_revision:0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" success:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("request_put:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("key:"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/registry/events/default/nginx-deployment-66b6c48dd5.16c35febf6bb59a0"')]),s._v(" value_size:689 lease:955464502472756512 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" failure:"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这时 kube-scheduler 监听到待调度的 Pod，于是为其分配 Node，通过 kube-apiserver 的 Bind 接口，将调度后的节点 IP 绑定到 Pod 资源上。kubelet 通过同样的 Watch 机制感知到新建的 Pod 后，发起 Pod 创建流程即可。")])])}),[],!1,null,null,null);t.default=n.exports}}]);