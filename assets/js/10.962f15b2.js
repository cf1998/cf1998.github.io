(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{439:function(s,t,a){"use strict";a.r(t);var n=a(16),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("从旧版本到新版本进行滚动更新，只是简单的通过输出显示来判断那些Pod是存活并准备就绪的，那么这个滚动更新的行为看上去肯定就是有效的，但是往往实际情况就是从旧版本到新版本的切换的过程并不总是十分顺畅，应用程序很有可能会丢弃某些客户端的请求，那接下来一起解决下流量丢失的问题吧？\n")]),s._v(" "),a("h2",{attrs:{id:"pod-探针"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pod-探针"}},[s._v("#")]),s._v(" Pod 探针")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("livenessProbe：")]),s._v("  指示容器是否正在运行。如果存活态探测失败，则 kubelet 会杀死容器， 并且容器将根据其重启策略决定未来。如果容器不提供存活探针， 则默认状态为 "),a("code",[s._v("Success")]),s._v("。")]),s._v(" "),a("li",[a("strong",[s._v("readinessProbe：")]),s._v(" 指示容器是否准备好为请求提供服务。如果就绪态探测失败， 端点控制器将从与 Pod 匹配的所有服务的端点列表中删除该 Pod 的 IP 地址。 初始延迟之前的就绪态的状态值默认为 "),a("code",[s._v("Failure")]),s._v("。 如果容器不提供就绪态探针，则默认状态为 "),a("code",[s._v("Success")]),s._v("。")]),s._v(" "),a("li",[a("strong",[s._v("startupProbe:")]),s._v(" 指示容器中的应用是否已经启动。如果提供了启动探针，则所有其他探针都会被 禁用，直到此探针成功为止。如果启动探测失败，"),a("code",[s._v("kubelet")]),s._v(" 将杀死容器，而容器依其 重启策略进行重启。 如果容器没有提供启动探测，则默认状态为 "),a("code",[s._v("Success")]),s._v("。")])]),s._v(" "),a("h3",{attrs:{id:"探测方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#探测方式"}},[s._v("#")]),s._v(" 探测方式")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("ExecAction：在容器内执行一个命令，如果返回值为0，则认为容器健康。")])]),s._v(" "),a("li",[a("p",[s._v("TCPSocketAction：通过TCP连接检查容器内的端口是否是通的，如果是通的就认为容器健康。")])]),s._v(" "),a("li",[a("p",[s._v("HTTPGetAction：通过应用程序暴露的API地址来检查程序是否是正常的，如果状态码为200~400之间，则认为容器健康。")])])]),s._v(" "),a("h3",{attrs:{id:"探测结果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#探测结果"}},[s._v("#")]),s._v(" 探测结果")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("Success")]),s._v("（成功）：容器通过了诊断。")]),s._v(" "),a("li",[a("code",[s._v("Failure")]),s._v("（失败）：容器未通过诊断。")]),s._v(" "),a("li",[a("code",[s._v("Unknown")]),s._v("（未知）：诊断失败，因此不会采取任何行动。")])]),s._v(" "),a("h3",{attrs:{id:"探针使用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#探针使用场景"}},[s._v("#")]),s._v(" 探针使用场景")]),s._v(" "),a("p",[a("strong",[s._v("何时该使用存活探针？")])]),s._v(" "),a("p",[s._v("如果容器中的进程能够在遇到问题或不健康的情况下自行奔溃，则不一定需要存活探针，"),a("code",[s._v("kubelet")]),s._v(" 将根据 Pod 的"),a("code",[s._v("restartPolicy")]),s._v(" 自动执行修复操作。")]),s._v(" "),a("p",[s._v("如果你希望容器在探测失败时被杀死并重新启动，那么请指定一个存活态探针， 并指定"),a("code",[s._v("restartPolicy")]),s._v(' 为 "'),a("code",[s._v("Always")]),s._v('" 或 "'),a("code",[s._v("OnFailure")]),s._v('"。')]),s._v(" "),a("p",[a("strong",[s._v("何时该使用就绪探针？")])]),s._v(" "),a("p",[s._v("如果要仅在探测成功时才开始向Pod发送流量请求，请指定就绪探针。在这种情况下，就绪探针可能与存活探针相同，但是规约中的就绪态探针的存在意味着 Pod 将在启动阶段不接收任何数据，并且只有在探针探测成功后才开始接收数据。")]),s._v(" "),a("p",[s._v("如果你希望容器能够自行进入维护状态，也可以指定一个就绪态探针，检查某个特定于 就绪态的因此不同于存活态探测的端点。")]),s._v(" "),a("p",[s._v("如果你的应用程序对后端服务有严格的依赖性，你可以同时实现存活态和就绪态探针。 当应用程序本身是健康的，存活态探针检测通过后，就绪态探针会额外检查每个所需的后端服务是否可用。 这可以帮助你避免将流量导向只能返回错误信息的 Pod。")]),s._v(" "),a("blockquote",[a("p",[s._v("如果你只是想在 Pod 被删除时能够排空请求，则不一定需要使用就绪态探针； 在删除 Pod 时，Pod 会自动将自身置于未就绪状态，无论就绪态探针是否存在。 等待 Pod 中的容器停止期间，Pod 会一直处于未就绪状态。")])]),s._v(" "),a("p",[a("strong",[s._v("何时该使用启动探针？")])]),s._v(" "),a("p",[s._v("对于所包含的容器需要较长时间才能启动就绪的 Pod 而言，启动探针是有用的。 你不再需要配置一个较长的存活态探测时间间隔，只需要设置另一个独立的配置选定， 对启动期间的容器执行探测，从而允许使用远远超出存活态时间间隔所允许的时长。")]),s._v(" "),a("p",[s._v("如果你的容器启动时间通常超出 "),a("code",[s._v("initialDelaySeconds + failureThreshold × periodSeconds")]),s._v(" 总值，你应该设置一个启动探测，对存活态探针所使用的同一端点执行检查。 "),a("code",[s._v("periodSeconds")]),s._v(" 的默认值是 10 秒。你应该将其 "),a("code",[s._v("failureThreshold")]),s._v(" 设置得足够高， 以便容器有充足的时间完成启动，并且避免更改存活态探针所使用的默认值。 这一设置有助于减少死锁状况的发生。")]),s._v(" "),a("h3",{attrs:{id:"探针参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#探针参数说明"}},[s._v("#")]),s._v(" 探针参数说明")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("initialDelaySeconds: 60    # 初始化时间")])]),s._v(" "),a("li",[a("p",[s._v("timeoutSeconds: 5   # 超时时间")])]),s._v(" "),a("li",[a("p",[s._v("periodSeconds: 10    # 检测间隔")])]),s._v(" "),a("li",[a("p",[s._v("successThreshold: 1 # 检查成功为1次表示就绪")])]),s._v(" "),a("li",[a("p",[s._v("failureThreshold: 5 # 检测失败2次表示未就绪")])])]),s._v(" "),a("p",[a("strong",[s._v("检查时间计算：")])]),s._v(" "),a("p",[s._v("每次检查的间隔是10秒，最长超时时间是5秒，也就是单次检查应该是10 + 5 = 15秒（periodSeconds + timeoutSeconds），并不是10 * 5")]),s._v(" "),a("p",[s._v("所以最长的重启时间为（10 + 5）* 5")]),s._v(" "),a("p",[s._v("（periodSeconds + timeoutSeconds） * failureThreshold")]),s._v(" "),a("p",[s._v("此时又分为了两种情况：")]),s._v(" "),a("p",[a("strong",[s._v("1.")]),s._v(" "),a("strong",[s._v("首次启动时")]),s._v("：最长重启时间需要加上initialDelaySeconds，因为需要等待initialDelaySeconds秒后才会执行健康检查。最长重启时间：（periodSeconds + timeoutSeconds） * failureThreshold + initialDelaySeconds")]),s._v(" "),a("p",[a("strong",[s._v("2.")]),s._v(" "),a("strong",[s._v("程序启动完成后")]),s._v("：此时不需要计入initialDelaySeconds，最长重启时间：（periodSeconds + timeoutSeconds） * failureThreshold")]),s._v(" "),a("h2",{attrs:{id:"滚动更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#滚动更新"}},[s._v("#")]),s._v(" 滚动更新")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，API的版本号")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，类型Pod")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，元数据")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，符合RFC 1035规范的Pod名称")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，Pod所在的命名空间，不指定默认为default，可以使用-n 指定namespace ")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，标签选择器，一般用于过滤和区分Pod")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" frontend "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以写多个")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，注释列表，可以写多个")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，用于定义容器的详细信息")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initContainers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化容器，在容器启动之前执行的一些初始化操作")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" sh\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' echo "I am InitContainer for init some configuration"\n    '),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("container\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，容器列表")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，符合RFC 1035规范的容器名称")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必选，容器所用的镜像的地址")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，镜像拉取策略")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，容器启动执行的命令")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nginx \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("g\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"daemon off;"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("workingDir")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /usr/share/nginx/html       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，容器的工作目录")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，存储卷配置，可以配置多个")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webroot "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储卷名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /usr/share/nginx/html "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 挂载目录")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readOnly")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只读")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，容器需要暴露的端口号列表")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口号")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口协议，默认TCP")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，环境变量配置列表")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TZ      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 变量名")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Asia/Shanghai "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 变量的值")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" LANG\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" en_US.utf8\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，资源限制和资源请求限制")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大限制设置")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1000m\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1024Mi\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动所需的资源")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100m\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 512Mi\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("startupProbe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，检测容器内进程是否完成启动。注意三种检查方式同时只能使用一种。")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("httpGet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# httpGet检测方式，生产环境建议使用httpGet实现接口级健康检查，健康检查由应用程序")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /api/successStart "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查路径")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readinessProbe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，健康检查。注意三种检查方式同时只能使用一种。")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("httpGet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# httpGet检测方式，生产环境建议使用httpGet实现接口级健康检查，健康检查由应用程序提供。")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" / "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查路径")]),s._v("\n         "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控端口")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("livenessProbe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，健康检查")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tcpSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口检测方式")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initialDelaySeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化时间")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeoutSeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 超时时间")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("periodSeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检测间隔")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("successThreshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查成功为2次表示就绪")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("failureThreshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检测失败1次表示未就绪")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，默认为Always")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullSecrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，拉取镜像使用的secret，可以配置多个")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dockercfg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86258")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostNetwork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选，是否为主机模式，如是，会占用主机端口")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 共享存储卷列表")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webroot "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 名称，与上述对应")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("emptyDir")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 挂载目录")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br")])]),a("p",[s._v("从上面得输出可以看出有部分请求处理失败了，要弄清楚失败的原因就需要弄明白当应用在滚动更新期间重新路由流量时，从旧的 Pod 实例到新的实例究竟会发生什么，首先让我们先看看 Kubernetes 是如何管理工作负载连接的。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ fortio load -a -c "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" -qps "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" -t 60s http://192.168.1.103:30413\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 50% 0.0629646")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 75% 0.0782498")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 90% 0.0940893")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 99% 0.156753")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 99.9% 0.38783")]),s._v("\nSockets used: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("for perfect keepalive, would be "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nJitter: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nCode  -1 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nCode "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7210")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.9")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nResponse Header Sizes "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" count "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7217")]),s._v(" avg "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("275.91659")]),s._v(" +/- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.797")]),s._v(" min "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" max "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("295")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1991290")]),s._v("\nResponse Body/Total Sizes "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" count "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7217")]),s._v(" avg "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27802.192")]),s._v(" +/- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("866.3")]),s._v(" min "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" max "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27848")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200648420")]),s._v("\nAll "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7217")]),s._v(" calls "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("plus "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" warmup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("66.533")]),s._v(" ms avg, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("120.2")]),s._v(" qps\nSuccessfully wrote "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4343")]),s._v(" bytes of Json data to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-14-170249_192_168_1_103_30413_es.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h3",{attrs:{id:"失败原因分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#失败原因分析"}},[s._v("#")]),s._v(" 失败原因分析")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.kubesre.com/img/%E9%9B%B6%E5%AE%95%E6%9C%BA.png",alt:"kubernetes kube-proxy"}})]),s._v(" "),a("p",[s._v("Kubernetes 会根据 Pods 的状态去更新 Endpoints 对象，这样就可以保证 Endpoints 中包含的都是准备好处理请求的 Pod。一旦新的 Pod 处于活动状态并准备就绪后，Kubernetes 就将会停止旧的 Pod，从而将 Pod 的状态更新为 "),a("code",[s._v("“Terminating”")]),s._v("，然后从 Endpoints 对象中移除，并且发送一个 "),a("code",[s._v("SIGTERM")]),s._v(" 信号给 Pod 的主进程。"),a("code",[s._v("SIGTERM")]),s._v(" 信号就会让容器以正常的方式关闭，并且不接受任何新的连接。Pod 从 Endpoints 对象中被移除后，前面的负载均衡器就会将流量路由到其他（新的）Pod 中去。因为在负载均衡器注意到变更并更新其配置之前，终止信号就会去停用 Pod，而这个重新配置过程又是"),a("strong",[s._v("异步")]),s._v("发生的，并不能保证正确的顺序，所以就可能导致很少的请求会被路由到已经终止的 Pod 上去了，也就出现了上面我们说的情况。")]),s._v(" "),a("h3",{attrs:{id:"零宕机实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#零宕机实现"}},[s._v("#")]),s._v(" 零宕机实现")]),s._v(" "),a("p",[s._v("生命周期钩子函数是"),a("strong",[s._v("同步")]),s._v("的，所以必须在将最终停止信号发送到容器之前完成，在我们的示例中，我们使用该钩子简单的等待，然后 "),a("code",[s._v("SIGTERM")]),s._v(" 信号将停止应用程序进程。同时，Kubernetes 将从 Endpoints 对象中删除该 Pod，所以该 Pod 将会从我们的负载均衡器中排除，基本上来说我们的生命周期钩子函数等待的时间可以确保在应用程序停止之前重新配置负载均衡器：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readinessProbe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lifecycle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preStop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/bash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep 20"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("我们这里使用 "),a("code",[s._v("preStop")]),s._v(" 设置了一个 20s 的宽限期，Pod 在真正销毁前会先 sleep 等待 20s，这就相当于留了时间给 Endpoints 控制器和 kube-proxy 更新去 Endpoints 对象和转发规则，这段时间 Pod 虽然处于 Terminating 状态，即便在转发规则更新完全之前有请求被转发到这个 Terminating 的 Pod，依然可以被正常处理，因为它还在 sleep，没有被真正销毁。")]),s._v(" "),a("p",[s._v("现在，当我们去查看滚动更新期间的 Pod 行为时，我们将看到正在终止的 Pod 处于 "),a("code",[s._v("Terminating")]),s._v(" 状态，但是在等待时间结束之前不会关闭的，如果我们使用 "),a("code",[s._v("Fortio")]),s._v(" 重新测试下，则会看到零失败请求的理想状态。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ fortio load -a -c "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" -qps "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" -t 60s http://192.168.1.103:30413\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.5")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.573803")]),s._v(" , "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.536902")]),s._v(" , "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.00")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 50% 0.0603096")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 75% 0.0730083")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 90% 0.0857454")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 99% 0.13218")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target 99.9% 0.190947")]),s._v("\nSockets used: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("for perfect keepalive, would be "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nJitter: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nCode "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7716")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.0")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nResponse Header Sizes "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" count "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7716")]),s._v(" avg "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("276.17729")]),s._v(" +/- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.827")]),s._v(" min "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("276")]),s._v(" max "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("295")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2130984")]),s._v("\nResponse Body/Total Sizes "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" count "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7716")]),s._v(" avg "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27829.177")]),s._v(" +/- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.827")]),s._v(" min "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27829")]),s._v(" max "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27848")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("214729932")]),s._v("\nAll "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7716")]),s._v(" calls "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("plus "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" warmup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("62.217")]),s._v(" ms avg, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128.5")]),s._v(" qps\nSuccessfully wrote "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3483")]),s._v(" bytes of Json data to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-10-14-171008_192_168_1_103_30413_es.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("温馨提示： Kubernetes 将在 30 秒后强行终止该进程（ Pod 定义中的 "),a("code",[s._v("terminationGracePeriodSeconds")]),s._v("） terminationGracePeriodSeconds默认值是30s")])])}),[],!1,null,null,null);t.default=e.exports}}]);