import { _ as _export_sfc, r as resolveComponent, o as openBlock, c as createElementBlock, b as createBaseVNode, d as createTextVNode, e as createVNode, a as createStaticVNode } from "./app-45f9d385.js";
const _sfc_main = {};
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h2 id="上篇回顾" tabindex="-1"><a class="header-anchor" href="#上篇回顾" aria-hidden="true">#</a> 上篇回顾</h2><p>上篇文章我们讲解了自定义监控，但是我们会发现，每次新增一个监控对象都需要我们手动的创建一个ServiceMonitor，这无疑是比较麻烦的，那么有没有一种可以自动发现的实现方案呢。本篇文章我们讲解如何自动发现监控目标</p><h2 id="prometheus配置文件及标签" tabindex="-1"><a class="header-anchor" href="#prometheus配置文件及标签" aria-hidden="true">#</a> prometheus配置文件及标签</h2><p>通过Promethues控制台查看：</p><p><img src="https://img.kubesre.com/kubesre/20230821/1.png" alt=""></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>\n<span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> serviceMonitor/monitoring/alertmanager/0\n  <span class="token key atrule">honor_timestamps</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 30s\n  <span class="token key atrule">scrape_timeout</span><span class="token punctuation">:</span> 10s\n  <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> /metrics\n  <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http\n  <span class="token key atrule">follow_redirects</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n  <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>job<span class="token punctuation">]</span>\n    <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;\n    <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.<span class="token important">*)</span>\n    <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __tmp_prometheus_job_name\n    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1\n    <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_label_alertmanager<span class="token punctuation">]</span>\n    <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;\n    <span class="token key atrule">regex</span><span class="token punctuation">:</span> main\n    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1\n    <span class="token key atrule">action</span><span class="token punctuation">:</span> keep\n  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_label_app_kubernetes_io_component<span class="token punctuation">]</span>\n    <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;\n    <span class="token key atrule">regex</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>router\n    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1\n    <span class="token key atrule">action</span><span class="token punctuation">:</span> keep\n  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_label_app_kubernetes_io_name<span class="token punctuation">]</span>\n    <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;\n    <span class="token key atrule">regex</span><span class="token punctuation">:</span> alertmanager\n    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1\n    <span class="token key atrule">action</span><span class="token punctuation">:</span> keep\n  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_label_app_kubernetes_io_part_of<span class="token punctuation">]</span>\n    <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;\n    <span class="token key atrule">regex</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus\n    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1\n    <span class="token key atrule">action</span><span class="token punctuation">:</span> keep\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注：仅截取了部分文件内容</p></blockquote><h3 id="标签详解" tabindex="-1"><a class="header-anchor" href="#标签详解" aria-hidden="true">#</a> 标签详解</h3><ul><li><p>Prometheus 加载 Targets 后，这些 Targets 会自动包含一些默认的标签，Target 以 __ 作为前置的标签是在系统内部使用的，这些标签不会被写入到样本数据中。</p></li><li><p>默认每次增加 Target 时会自动增加一个 instance 标签，而 instance 标签的内容刚好对应 Target 实例的 address 值，这是因为实际上 Prometheus 内部做了一次标签重写处理，默认 address 标签设置为 : 地址，经过标签重写后，默认会自动将该值设置为 instance 标签，所以我们能够在页面看到该标签。</p></li></ul><h3 id="前缀标签含义" tabindex="-1"><a class="header-anchor" href="#前缀标签含义" aria-hidden="true">#</a> 前缀标签含义</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>__meta_：在重新标记阶段可以使用以 _meta_ 为前缀的附加标签。它们由提供目标的服务发现机制设置的，并因机制而异。\n__：目标重新标记完成后，以 __ 开头的标签将从标签集中删除。\n__tmp：如果重新标记步骤仅需要临时存储标签值（作为后续重新标记步骤的输入），请使用这个标签名称前缀。这个前缀保证永远不会被 Prometheus 本身使用。\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="操作标签动作" tabindex="-1"><a class="header-anchor" href="#操作标签动作" aria-hidden="true">#</a> 操作标签动作</h3><ul><li>replace：根据 regex 的配置匹配 source_labels 标签的值（注意：多个 source_label 的值会按照 separator 进行拼接），并且将匹配到的值写入到 target_label 当中如果有多个匹配组，则可以使用 ${1}, ${2} 确定写入的内容。如果没匹配到任何内容则不对 target_label 进行替换， 默认为 replace</li><li>keep：丢弃 source_labels 的值中没有匹配到 regex 正则表达式内容的 Target 实例</li><li>drop：丢弃 source_labels 的值中匹配到 regex 正则表达式内容的 Target 实例</li><li>hashmod：将 target_label 设置为关联的 source_label 的哈希模块</li><li>labelmap：根据 regex 去匹配 Target 实例所有标签的名称（注意是名称），并且将捕获到的内容作为为新的标签名称，regex 匹配到标签的的值作为新标签的值。</li><li>labeldrop：对 Target 标签进行过滤，会移除匹配过滤条件的所有标签</li><li>labelkeep：对 Target 标签进行过滤，会移除不匹配过滤条件的所有标签</li></ul><h2 id="案例介绍" tabindex="-1"><a class="header-anchor" href="#案例介绍" aria-hidden="true">#</a> 案例介绍</h2><p>本次案例自动发现使用kubernetes_sd_configs，也就是在kubernetes中的自动发现。</p>', 15);
const _hoisted_16 = {
  href: "https://prometheus.io/docs/prometheus/latest/configuration/configuration/#configuration-file",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_17 = /* @__PURE__ */ createStaticVNode('<h2 id="环境概览" tabindex="-1"><a class="header-anchor" href="#环境概览" aria-hidden="true">#</a> 环境概览</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># kubectl get nodes</span>\nNAME               STATUS   ROLES                  AGE   VERSION\nk8s-master-50.57   Ready    control-plane,master   77d   v1.20.5\nk8s-node-50.58     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 77d   v1.20.5\nk8s-node-50.59     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 77d   v1.20.5\n\n<span class="token comment"># kubectl get pod -n monitoring  </span>\nNAME                                  READY   STATUS    RESTARTS   AGE\nalertmanager-main-0                   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21h\nalertmanager-main-1                   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21h\nalertmanager-main-2                   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21h\nblackbox-exporter-55c457d5fb-5m7ql    <span class="token number">3</span>/3     Running   <span class="token number">0</span>          21h\ngrafana-9df57cdc4-gpzsq               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21h\nkube-state-metrics-56dbb74497-gpkn9   <span class="token number">3</span>/3     Running   <span class="token number">0</span>          21h\nnode-exporter-4wl6d                   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21h\nnode-exporter-b4595                   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21h\nnode-exporter-g4l99                   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21h\nprometheus-adapter-59df95d9f5-tnt4w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21h\nprometheus-adapter-59df95d9f5-xhz5v   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21h\nprometheus-k8s-0                      <span class="token number">2</span>/2     Running   <span class="token number">1</span>          21h\nprometheus-k8s-1                      <span class="token number">2</span>/2     Running   <span class="token number">1</span>          21h\nprometheus-operator-c46b8b7c9-mg9cv   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21h\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="创建secret" tabindex="-1"><a class="header-anchor" href="#创建secret" aria-hidden="true">#</a> 创建secret</h2><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>\n<span class="token comment"># cat kubesre-com.yaml</span>\n\n<span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">&quot;kubesre-com&quot;</span> \n  <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>   <span class="token comment"># 指定k8s服务发现的配置</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints   <span class="token comment"># 使用endpoints角色进行服务发现</span>\n  <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span> <span class="token comment"># 指标采集之前或采集过程中去重新配置</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scrape<span class="token punctuation">]</span>   <span class="token comment"># 源标签名称</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep <span class="token comment"># 保留具有 prometheus.io/scrape=true 这个注解的Service</span>\n      <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_path<span class="token punctuation">]</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__\n      <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span>\n        <span class="token punctuation">[</span>__address__<span class="token punctuation">,</span> __meta_kubernetes_service_annotation_prometheus_io_port<span class="token punctuation">]</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__\n      <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">[</span>^<span class="token punctuation">:</span><span class="token punctuation">]</span>+)(<span class="token punctuation">?</span><span class="token punctuation">:</span><span class="token punctuation">:</span>\\d+)<span class="token punctuation">?</span>;(\\d+) <span class="token comment"># RE2 正则规则，+是一次多多次，?是0次或1次，其中?:表示非匹配组(意思就是不获取匹配结果)</span>\n      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1<span class="token punctuation">:</span>$2\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scheme<span class="token punctuation">]</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __scheme__\n      <span class="token key atrule">regex</span><span class="token punctuation">:</span> (https<span class="token punctuation">?</span>)\n    <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap\n      <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_service_label_(.+)\n      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_service\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_name<span class="token punctuation">]</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_pod\n    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_node_name<span class="token punctuation">]</span>\n      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace\n      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_node\n      \n\n<span class="token comment"># kubectl create secret generic kubesre-com-secret  --from-file=kubesre-com.yaml -n monitoring</span>\nsecret/kubesre<span class="token punctuation">-</span>com<span class="token punctuation">-</span>secret created\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="查看secret" tabindex="-1"><a class="header-anchor" href="#查看secret" aria-hidden="true">#</a> 查看secret</h2><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># kubectl get secret kubesre-com-secret -n monitoring  -o yaml </span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">data</span><span class="token punctuation">:</span>\n  <span class="token key atrule">kubesre-com.yaml</span><span class="token punctuation">:</span> LSBqb2JfbmFtZTogImt1YmVzcmUuY29tIiAKICBrdWJlcm5ldGVzX3NkX2NvbmZpZ3M6ICAgIyDmjIflrpprOHPmnI3liqHlj5HnjrDnmoTphY3nva4KICAgIC0gcm9sZTogZW5kcG9pbnRzICAgIyDkvb/nlKhlbmRwb2ludHPop5LoibLov5vooYzmnI3liqHlj5HnjrAKICByZWxhYmVsX2NvbmZpZ3M6ICMg5oyH5qCH6YeH6ZuG5LmL5YmN5oiW6YeH6ZuG6L+H56iL5Lit5Y676YeN5paw6YWN572uCiAgICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19zZXJ2aWNlX2Fubm90YXRpb25fcHJvbWV0aGV1c19pb19zY3JhcGVdICAgIyDmupDmoIfnrb7lkI3np7AKICAgICAgYWN0aW9uOiBrZWVwICMg5L+d55WZ5YW35pyJIHByb21ldGhldXMuaW8vc2NyYXBlPXRydWUg6L+Z5Liq5rOo6Kej55qEU2VydmljZQogICAgICByZWdleDogdHJ1ZQogICAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9hbm5vdGF0aW9uX3Byb21ldGhldXNfaW9fcGF0aF0KICAgICAgYWN0aW9uOiByZXBsYWNlCiAgICAgIHRhcmdldF9sYWJlbDogX19tZXRyaWNzX3BhdGhfXwogICAgICByZWdleDogKC4rKQogICAgLSBzb3VyY2VfbGFiZWxzOgogICAgICAgIFtfX2FkZHJlc3NfXywgX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9hbm5vdGF0aW9uX3Byb21ldGhldXNfaW9fcG9ydF0KICAgICAgYWN0aW9uOiByZXBsYWNlCiAgICAgIHRhcmdldF9sYWJlbDogX19hZGRyZXNzX18KICAgICAgcmVnZXg6IChbXjpdKykoPzo6XGQrKT87KFxkKykgIyBSRTIg5q2j5YiZ6KeE5YiZ77yMK+aYr+S4gOasoeWkmuWkmuasoe+8jD/mmK8w5qyh5oiWMeasoe+8jOWFtuS4rT866KGo56S66Z2e5Yy56YWN57uEKOaEj+aAneWwseaYr+S4jeiOt+WPluWMuemFjee7k+aenCkKICAgICAgcmVwbGFjZW1lbnQ6ICQxOiQyCiAgICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19zZXJ2aWNlX2Fubm90YXRpb25fcHJvbWV0aGV1c19pb19zY2hlbWVdCiAgICAgIGFjdGlvbjogcmVwbGFjZQogICAgICB0YXJnZXRfbGFiZWw6IF9fc2NoZW1lX18KICAgICAgcmVnZXg6IChodHRwcz8pCiAgICAtIGFjdGlvbjogbGFiZWxtYXAKICAgICAgcmVnZXg6IF9fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfbGFiZWxfKC4rKQogICAgICByZXBsYWNlbWVudDogJDEKICAgIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX25hbWVzcGFjZV0KICAgICAgYWN0aW9uOiByZXBsYWNlCiAgICAgIHRhcmdldF9sYWJlbDoga3ViZXJuZXRlc19uYW1lc3BhY2UKICAgIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfbmFtZV0KICAgICAgYWN0aW9uOiByZXBsYWNlCiAgICAgIHRhcmdldF9sYWJlbDoga3ViZXJuZXRlc19zZXJ2aWNlCiAgICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19wb2RfbmFtZV0KICAgICAgYWN0aW9uOiByZXBsYWNlCiAgICAgIHRhcmdldF9sYWJlbDoga3ViZXJuZXRlc19wb2QKICAgIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX25vZGVfbmFtZV0KICAgICAgYWN0aW9uOiByZXBsYWNlCiAgICAgIHRhcmdldF9sYWJlbDoga3ViZXJuZXRlc19ub2RlCg==\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2023-08-13T11:50:22Z&quot;</span>\n  <span class="token key atrule">managedFields</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n    <span class="token key atrule">fieldsType</span><span class="token punctuation">:</span> FieldsV1\n    <span class="token key atrule">fieldsV1</span><span class="token punctuation">:</span>\n      <span class="token key atrule">f:data</span><span class="token punctuation">:</span>\n        <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token key atrule">f:kubesre-com.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n      <span class="token key atrule">f:type</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token key atrule">manager</span><span class="token punctuation">:</span> kubectl<span class="token punctuation">-</span>create\n    <span class="token key atrule">operation</span><span class="token punctuation">:</span> Update\n    <span class="token key atrule">time</span><span class="token punctuation">:</span> <span class="token string">&quot;2023-08-13T11:50:22Z&quot;</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubesre<span class="token punctuation">-</span>com<span class="token punctuation">-</span>secret\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring\n  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;16541714&quot;</span>\n  <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /api/v1/namespaces/monitoring/secrets/kubesre<span class="token punctuation">-</span>com<span class="token punctuation">-</span>secret\n  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 3eecedbb<span class="token punctuation">-</span>5774<span class="token punctuation">-</span>4434<span class="token punctuation">-</span>953b<span class="token punctuation">-</span>d6e89887c96f\n<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="修改prometheus-prometheus-yaml" tabindex="-1"><a class="header-anchor" href="#修改prometheus-prometheus-yaml" aria-hidden="true">#</a> 修改prometheus-prometheus.yaml</h2><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">#  cat  prometheus-prometheus.yaml</span>\n<span class="token comment">### 省略内容</span>\n<span class="token key atrule">additionalScrapeConfigs</span><span class="token punctuation">:</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> kubesre<span class="token punctuation">-</span>com<span class="token punctuation">-</span>secret\n    <span class="token key atrule">key</span><span class="token punctuation">:</span> kubesre<span class="token punctuation">-</span>com.yaml\n<span class="token comment">#  kubectl    apply   -f    prometheus-prometheus.yaml</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img.kubesre.com/kubesre/20230821/6.png" alt=""></p><h2 id="查看prometheus中targets" tabindex="-1"><a class="header-anchor" href="#查看prometheus中targets" aria-hidden="true">#</a> 查看prometheus中targets</h2><p><img src="https://img.kubesre.com/kubesre/20230821/3.png" alt=""></p>', 11);
const _hoisted_28 = /* @__PURE__ */ createBaseVNode(
  "code",
  null,
  "kubectl logs -f prometheus-k8s-0 prometheus -n monitoring",
  -1
  /* HOISTED */
);
const _hoisted_29 = /* @__PURE__ */ createBaseVNode(
  "code",
  null,
  "prometheus-clusterRole.yaml",
  -1
  /* HOISTED */
);
const _hoisted_30 = {
  href: "https://mp.weixin.qq.com/s/HuhrjEgaIFF7VDGhzawskA",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_31 = /* @__PURE__ */ createStaticVNode('<h2 id="创建可被发现服务" tabindex="-1"><a class="header-anchor" href="#创建可被发现服务" aria-hidden="true">#</a> 创建可被发现服务</h2><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># cat  mysql-sd.yaml</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>ops\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>\n      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>\n    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>\n      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 70%\n      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%\n    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate\n  <span class="token key atrule">template</span><span class="token punctuation">:</span>\n    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n      <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n    <span class="token key atrule">spec</span><span class="token punctuation">:</span>\n      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>\n      <span class="token key atrule">containers</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/mysqld<span class="token punctuation">-</span>exporter\n        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent\n        <span class="token key atrule">env</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATA_SOURCE_NAME\n          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&#39;root:aMIZi9Ydh2GRKe@(192.168.70.204:3306)/&#39;</span> <span class="token comment"># user:password@(hostname:3306)/</span>\n        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>\n          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>\n            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9104</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health\n          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>\n          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>\n          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>\n        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>\n          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>\n            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9104</span>\n            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health\n          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>\n          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>\n          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>\n          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>\n        <span class="token key atrule">resources</span><span class="token punctuation">:</span>\n          <span class="token key atrule">limits</span><span class="token punctuation">:</span>\n            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m\n            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi\n          <span class="token key atrule">requests</span><span class="token punctuation">:</span>\n            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m\n            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi\n<span class="token punctuation">---</span>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>\n    <span class="token key atrule">prometheus.io/path</span><span class="token punctuation">:</span> /metrics    <span class="token comment"># 指标路径，默认 /metrics</span>\n    <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">&quot;9104&quot;</span>   <span class="token comment"># 暴露指标的端口</span>\n    <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>  <span class="token comment">#  开启</span>\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>ops\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n  <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter\n    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9104</span>\n    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP\n  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP\n\n<span class="token comment"># kubectl   apply  -f   mysql-sd.yaml</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>此案例是上一篇的mysql_exporter，上篇使用的<code>ServiceMonitor</code>，此次使用注解的方式，使其可被kubernetes自动发现</p></blockquote><h2 id="再次查看prometheus中targets" tabindex="-1"><a class="header-anchor" href="#再次查看prometheus中targets" aria-hidden="true">#</a> 再次查看prometheus中targets</h2><p><img src="https://img.kubesre.com/kubesre/20230821/4.png" alt=""></p><h2 id="验证指标" tabindex="-1"><a class="header-anchor" href="#验证指标" aria-hidden="true">#</a> 验证指标</h2><p><img src="https://img.kubesre.com/kubesre/20230821/5.png" alt=""></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本此文章主要讲解了在kubernetes中如何自动发现并纳入监控中，以及一些标签和操作标签动作。下期内容：Prometheus告警</p>', 9);
function _sfc_render(_ctx, _cache) {
  const _component_ExternalLinkIcon = resolveComponent("ExternalLinkIcon");
  return openBlock(), createElementBlock("div", null, [
    _hoisted_1,
    createBaseVNode("blockquote", null, [
      createBaseVNode("p", null, [
        createTextVNode("更多自动发现可以参考："),
        createBaseVNode("a", _hoisted_16, [
          createTextVNode("https://prometheus.io/docs/prometheus/latest/configuration/configuration/#configuration-file"),
          createVNode(_component_ExternalLinkIcon)
        ])
      ])
    ]),
    _hoisted_17,
    createBaseVNode("blockquote", null, [
      createBaseVNode("p", null, [
        createTextVNode("注：如果没有该target，需要查看一个日志"),
        _hoisted_28,
        createTextVNode("，大多数情况是因为权限的问题，在上篇文章中我们已经修改了"),
        _hoisted_29,
        createTextVNode("。具体修改内容可以参考"),
        createBaseVNode("a", _hoisted_30, [
          createTextVNode("上篇文章"),
          createVNode(_component_ExternalLinkIcon)
        ])
      ])
    ]),
    _hoisted_31
  ]);
}
const zidongfaxian_html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "zidongfaxian.html.vue"]]);
export {
  zidongfaxian_html as default
};
