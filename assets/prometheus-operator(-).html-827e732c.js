import { _ as _export_sfc, r as resolveComponent, o as openBlock, c as createElementBlock, b as createBaseVNode, d as createTextVNode, e as createVNode, a as createStaticVNode } from "./app-d515af8b.js";
const _sfc_main = {};
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h2 id="简单介绍" tabindex="-1"><a class="header-anchor" href="#简单介绍" aria-hidden="true">#</a> 简单介绍</h2><p>Prometheus Operator 是一个 Kubernetes 的运算符（Operator），它用于简化在 Kubernetes 上部署、管理和操作 Prometheus 及相关组件的过程。</p><p>Prometheus Operator 提供了一种声明式的方式来定义和管理 Prometheus 实例、ServiceMonitors、Alertmanagers 和其他与 Prometheus 相关的资源。它使用自定义资源定义（Custom Resource Definitions，CRDs）来扩展 Kubernetes API，并通过控制器（Controller）管理这些资源的生命周期。</p><p>以下是 Prometheus Operator 的一些主要功能和概念：</p><ul><li>Prometheus 实例管理: Prometheus Operator 允许你通过创建 Prometheus 自定义资源（Prometheus CRD）来定义和部署 Prometheus 实例。你可以指定监测目标、配置规则和警报规则等信息。</li><li>ServiceMonitor 管理: 通过创建 ServiceMonitor 自定义资源，你可以定义要由 Prometheus 监测的服务和端点。Prometheus Operator 将根据这些定义自动配置 Prometheus 实例来收集指标。</li><li>Alertmanager 管理: Prometheus Operator 还支持创建和管理 Alertmanager 实例。你可以使用 Alertmanager CRD 来定义警报规则并配置警报通知的接收者。</li><li>自动发现和自动配置: Prometheus Operator 使用 Kubernetes 的标签查询机制和服务发现特性，从而实现自动发现和配置需要监测的目标。当你添加或删除带有特定标签的 Pod 或服务时，Prometheus Operator 将相应地更新 Prometheus 配置。</li><li>水平伸缩和高可用性: Prometheus Operator 具有内置的水平伸缩支持，可以自动根据工作负载的变化调整 Prometheus 实例的数量。此外，它还支持在集群中自动部署多个实例以实现高可用性。</li></ul><p>使用 Prometheus Operator 可以简化 Prometheus 的运维过程，并提供了一种基于 Kubernetes 原生特性的方式来管理和监控应用程序。它使得在 Kubernetes 集群中部署和管理 Prometheus 变得更加方便、灵活和可靠。</p><p><img src="https://img.kubesre.com/kubesre/20230809/15.png" alt=""></p><p>其中Prometheus资源描述了 Prometheus部署，而<code>ServiceMonitor</code>和<code>PodMonitor</code>资源 描述prometheus监控的服务</p><h2 id="版本支持" tabindex="-1"><a class="header-anchor" href="#版本支持" aria-hidden="true">#</a> 版本支持</h2><table><thead><tr><th>kube-prometheus版本</th><th>kubenetes版本</th></tr></thead><tbody><tr><td>release-0.4</td><td>1.16、1.17</td></tr><tr><td>release-0.5</td><td>1.18</td></tr><tr><td>release-0.6</td><td>1.18、1.19</td></tr><tr><td>release-0.7</td><td>1.19、1.20</td></tr><tr><td>release-0.8</td><td>1.20、1.21</td></tr><tr><td>release-0.9</td><td>1.21、1.22</td></tr><tr><td>release-0.10</td><td>1.22、1.23</td></tr><tr><td>release-0.11</td><td>1.23、1.24</td></tr><tr><td>main</td><td>1.24</td></tr></tbody></table>', 10);
const _hoisted_11 = {
  href: "https://github.com/prometheus-operator/kube-prometheus#compatibility",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_12 = /* @__PURE__ */ createStaticVNode('<h2 id="快速开始" tabindex="-1"><a class="header-anchor" href="#快速开始" aria-hidden="true">#</a> 快速开始</h2><h3 id="环境概览" tabindex="-1"><a class="header-anchor" href="#环境概览" aria-hidden="true">#</a> 环境概览</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># kubectl get nodes</span>\nNAME               STATUS   ROLES                  AGE   VERSION\nk8s-master-50.57   Ready    control-plane,master   77d   v1.20.5\nk8s-node-50.58     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 77d   v1.20.5\nk8s-node-50.59     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 77d   v1.20.5\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="下载kube-prometheus" tabindex="-1"><a class="header-anchor" href="#下载kube-prometheus" aria-hidden="true">#</a> 下载kube-prometheus</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">git</span> clone  <span class="token parameter variable">-b</span> release-0.8  https://github.com/prometheus-operator/kube-prometheus.git\n<span class="token comment">### 由gitee下载</span>\n<span class="token function">git</span> clone  <span class="token parameter variable">-b</span> release-0.8  https://gitee.com/root_007/kube-prometheus.git\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ll</span>\n总用量 <span class="token number">184</span>\n-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">679</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 build.sh\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">3039</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 code-of-conduct.md\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1422</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 DCO\ndrwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 docs\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">2051</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 example.jsonnet\ndrwxr-xr-x <span class="token number">7</span> root root  <span class="token number">4096</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 examples\ndrwxr-xr-x <span class="token number">3</span> root root    <span class="token number">28</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 experimental\n-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">237</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 go.mod\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">59996</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 go.sum\ndrwxr-xr-x <span class="token number">3</span> root root    <span class="token number">68</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 hack\ndrwxr-xr-x <span class="token number">3</span> root root    <span class="token number">29</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 jsonnet\n-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">206</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 jsonnetfile.json\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4857</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 jsonnetfile.lock.json\ndrwxr-xr-x <span class="token number">2</span> root root     <span class="token number">6</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 kube-prometheus\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4437</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 kustomization.yaml\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">11325</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 LICENSE\n-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">2101</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 Makefile\ndrwxr-xr-x <span class="token number">3</span> root root  <span class="token number">4096</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 manifests\n-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">126</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 NOTICE\n-rw-r--r-- <span class="token number">1</span> root root <span class="token number">38246</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 README.md\ndrwxr-xr-x <span class="token number">2</span> root root   <span class="token number">187</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 scripts\n-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">928</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 sync-to-internal-registry.jsonnet\ndrwxr-xr-x <span class="token number">3</span> root root    <span class="token number">17</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 tests\n-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">808</span> <span class="token number">8</span>月   <span class="token number">3</span> <span class="token number">13</span>:58 test.sh\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="部署" tabindex="-1"><a class="header-anchor" href="#部署" aria-hidden="true">#</a> 部署</h3><h4 id="部署文件清单" tabindex="-1"><a class="header-anchor" href="#部署文件清单" aria-hidden="true">#</a> 部署文件清单</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># tree manifests/ </span>\nmanifests/\n├── alertmanager-alertmanager.yaml\n├── alertmanager-podDisruptionBudget.yaml\n├── alertmanager-prometheusRule.yaml\n├── alertmanager-secret.yaml\n├── alertmanager-serviceAccount.yaml\n├── alertmanager-serviceMonitor.yaml\n├── alertmanager-service.yaml\n├── blackbox-exporter-clusterRoleBinding.yaml\n├── blackbox-exporter-clusterRole.yaml\n├── blackbox-exporter-configuration.yaml\n├── blackbox-exporter-deployment.yaml\n├── blackbox-exporter-serviceAccount.yaml\n├── blackbox-exporter-serviceMonitor.yaml\n├── blackbox-exporter-service.yaml\n├── grafana-dashboardDatasources.yaml\n├── grafana-dashboardDefinitions.yaml\n├── grafana-dashboardSources.yaml\n├── grafana-deployment.yaml\n├── grafana-serviceAccount.yaml\n├── grafana-serviceMonitor.yaml\n├── grafana-service.yaml\n├── kube-prometheus-prometheusRule.yaml\n├── kubernetes-prometheusRule.yaml\n├── kubernetes-serviceMonitorApiserver.yaml\n├── kubernetes-serviceMonitorCoreDNS.yaml\n├── kubernetes-serviceMonitorKubeControllerManager.yaml\n├── kubernetes-serviceMonitorKubelet.yaml\n├── kubernetes-serviceMonitorKubeScheduler.yaml\n├── kube-state-metrics-clusterRoleBinding.yaml\n├── kube-state-metrics-clusterRole.yaml\n├── kube-state-metrics-deployment.yaml\n├── kube-state-metrics-prometheusRule.yaml\n├── kube-state-metrics-serviceAccount.yaml\n├── kube-state-metrics-serviceMonitor.yaml\n├── kube-state-metrics-service.yaml\n├── node-exporter-clusterRoleBinding.yaml\n├── node-exporter-clusterRole.yaml\n├── node-exporter-daemonset.yaml\n├── node-exporter-prometheusRule.yaml\n├── node-exporter-serviceAccount.yaml\n├── node-exporter-serviceMonitor.yaml\n├── node-exporter-service.yaml\n├── prometheus-adapter-apiService.yaml\n├── prometheus-adapter-clusterRoleAggregatedMetricsReader.yaml\n├── prometheus-adapter-clusterRoleBindingDelegator.yaml\n├── prometheus-adapter-clusterRoleBinding.yaml\n├── prometheus-adapter-clusterRoleServerResources.yaml\n├── prometheus-adapter-clusterRole.yaml\n├── prometheus-adapter-configMap.yaml\n├── prometheus-adapter-deployment.yaml\n├── prometheus-adapter-roleBindingAuthReader.yaml\n├── prometheus-adapter-serviceAccount.yaml\n├── prometheus-adapter-serviceMonitor.yaml\n├── prometheus-adapter-service.yaml\n├── prometheus-clusterRoleBinding.yaml\n├── prometheus-clusterRole.yaml\n├── prometheus-operator-prometheusRule.yaml\n├── prometheus-operator-serviceMonitor.yaml\n├── prometheus-podDisruptionBudget.yaml\n├── prometheus-prometheusRule.yaml\n├── prometheus-prometheus.yaml\n├── prometheus-roleBindingConfig.yaml\n├── prometheus-roleBindingSpecificNamespaces.yaml\n├── prometheus-roleConfig.yaml\n├── prometheus-roleSpecificNamespaces.yaml\n├── prometheus-serviceAccount.yaml\n├── prometheus-serviceMonitor.yaml\n├── prometheus-service.yaml\n└── setup\n    ├── 0namespace-namespace.yaml\n    ├── prometheus-operator-0alertmanagerConfigCustomResourceDefinition.yaml\n    ├── prometheus-operator-0alertmanagerCustomResourceDefinition.yaml\n    ├── prometheus-operator-0podmonitorCustomResourceDefinition.yaml\n    ├── prometheus-operator-0probeCustomResourceDefinition.yaml\n    ├── prometheus-operator-0prometheusCustomResourceDefinition.yaml\n    ├── prometheus-operator-0prometheusruleCustomResourceDefinition.yaml\n    ├── prometheus-operator-0servicemonitorCustomResourceDefinition.yaml\n    ├── prometheus-operator-0thanosrulerCustomResourceDefinition.yaml\n    ├── prometheus-operator-clusterRoleBinding.yaml\n    ├── prometheus-operator-clusterRole.yaml\n    ├── prometheus-operator-deployment.yaml\n    ├── prometheus-operator-serviceAccount.yaml\n    └── prometheus-operator-service.yaml\n\n<span class="token number">1</span> directory, <span class="token number">82</span> files\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="执行编排文件" tabindex="-1"><a class="header-anchor" href="#执行编排文件" aria-hidden="true">#</a> 执行编排文件</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span>  manifests/setup/\nkubectl apply <span class="token parameter variable">-f</span>  manifests/\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>首先创建名称空间和CRDs，避免在部署其他组件时出现竞争</p><h4 id="查看pod状态" tabindex="-1"><a class="header-anchor" href="#查看pod状态" aria-hidden="true">#</a> 查看pod状态</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># kubectl get pod -n monitoring  </span>\nNAME                                   READY   STATUS    RESTARTS   AGE\nalertmanager-main-0                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m\nalertmanager-main-1                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m\nalertmanager-main-2                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m\nblackbox-exporter-55c457d5fb-4ldl5     <span class="token number">3</span>/3     Running   <span class="token number">0</span>          21m\ngrafana-9df57cdc4-qqqdl                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m\nkube-state-metrics-657b8c7649-sprs5    <span class="token number">3</span>/3     Running   <span class="token number">0</span>          3m23s\nnode-exporter-n4qp9                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m\nnode-exporter-nm9hm                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m\nnode-exporter-rzxbb                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m\nprometheus-adapter-59df95d9f5-hj75h    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m\nprometheus-adapter-59df95d9f5-qcpbq    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m\nprometheus-k8s-0                       <span class="token number">2</span>/2     Running   <span class="token number">1</span>          21m\nprometheus-k8s-1                       <span class="token number">2</span>/2     Running   <span class="token number">1</span>          21m\nprometheus-operator-7775c66ccf-qfsxh   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m\n<span class="token comment"># 出现如上状态，表示安装成功</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注：镜像下载失败参考https://github.com/DaoCloud/public-image-mirror该项目做映射，或者使用其他的下载方式，当然如果有魔法可以使用魔法打败魔法</p><h4 id="查看创建的crd" tabindex="-1"><a class="header-anchor" href="#查看创建的crd" aria-hidden="true">#</a> 查看创建的CRD</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># kubectl get crd | grep monitoring.coreos.com </span>\nalertmanagerconfigs.monitoring.coreos.com   <span class="token number">2023</span>-08-03T06:12:40Z\nalertmanagers.monitoring.coreos.com         <span class="token number">2023</span>-08-03T06:12:40Z\npodmonitors.monitoring.coreos.com           <span class="token number">2023</span>-08-03T06:12:40Z\nprobes.monitoring.coreos.com                <span class="token number">2023</span>-08-03T06:12:40Z\nprometheuses.monitoring.coreos.com          <span class="token number">2023</span>-08-03T06:12:40Z\nprometheusrules.monitoring.coreos.com       <span class="token number">2023</span>-08-03T06:12:41Z\nservicemonitors.monitoring.coreos.com       <span class="token number">2023</span>-08-03T06:12:41Z\nthanosrulers.monitoring.coreos.com          <span class="token number">2023</span>-08-03T06:12:41Z\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CRD说明：</strong></p><p>alertmanagerconfigs：</p><ul><li>该CRD定义了alertmanager配置的一部分，主要是定义告警路由相关</li></ul><p>alertmanagers：</p><ul><li>该CRD定义了在k8s集群中运行的Alertmanager的配置，同样提供了多种配置，包含持久化存储。</li><li>对于每个Alertmanager资源，Operator都会在相同的名称空间中部署一个对应配置的sts，Alertmanager pod被配置为一个包含名为alertmanager-name的secret，该secret以alertmanager.yaml为key的方式保存使用的配置文件</li></ul><p>podmonitors：</p><ul><li>该CRD用于定义如何监控一组动态pod，使用标签来定义那些pod被选择进行监控。</li></ul><p>probes：</p><ul><li>该CRD用于定义如何监控一组Ingress和静态目标，除了target之外，Probe对象还需要一个Prober，它是监控的目标并为prometheus提供指标的服务，例如可以通过使用blackbox-exporter来提供这个服务</li></ul><p>prometheuses：</p><ul><li>该CRD声明定义了Prometheus期望在k8s集群中运行的配置，提供了配置选项来配置副本、持久化、报警等</li><li>对于每个Prometheus CRD资源，Operator都会以sts形式在形同的名称空间下部署对应配置，proemtheus pod的配置是通过一个包含prometheus配置的名为prometheus-name的secret对象声明挂载的</li><li>该CRD根据标签选择来指定部署到prometheus实例应该覆盖那些ServiceMonitors，然后Operator会根据包含的ServiceMonitor生成配置，并在包含配置的secret中进行更新</li></ul><p>prometheusrules：</p><ul><li>用于配置prometheus的rule规则文件，包括recording rule和alerting，可以自动被prometheus加载</li></ul><p>servicemonitors：</p><ul><li>该CRD定义了如何监控一组动态的服务，使用标签来定义那些service被选择进行监控</li><li>为了让Prometheus金控k8s内的任何应用，需要存在一个Endpoints对象，Endpoints对象本质上时IP地址的列表，通常Endpoints对象是由Service对象自动填充的，Service对象通过标签选择器匹配pod，并将其添加到Endpoints对象中，一个Service可以暴露一个或多个端口，这些端口由多个Endpoints列表支持，这些端点一般情况下都是指向一个pod</li><li>注意：endpoints是ServiceMonitor CRD中的字段，Endpoints是k8s的一种对象</li></ul><p>thanosrulers：</p><ul><li>该CRD定义了一个Thanos Ruler组件的配置，以方便在k8s集群中运行，通过Thanos Ruler，可以跨多个Proemtheus实例处理记录和报警规则</li><li>一个ThanosRuler实例至少需要一个queryEndpoint，它指向Thanos Queriers或prometheus实例的位置，queryEndpoints用于配置Thanos运行时的--query参数</li></ul><h2 id="验证" tabindex="-1"><a class="header-anchor" href="#验证" aria-hidden="true">#</a> 验证</h2><h3 id="访问prometheus" tabindex="-1"><a class="header-anchor" href="#访问prometheus" aria-hidden="true">#</a> 访问Prometheus</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 这里属于一个Demo，咱们就通过kubectl port-forward 做个端口映射，生产环境可以通过NodePort或者Ingress进行对外暴露</span>\n<span class="token punctuation">[</span>root@k8s-master-50.57 ~/prometheus/aa/kube-prometheus/manifests<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">192.168</span>.50.57\n<span class="token comment"># kubectl --namespace monitoring port-forward svc/prometheus-k8s --address 0.0.0.0 19090:9090</span>\nForwarding from <span class="token number">0.0</span>.0.0:19090 -<span class="token operator">&gt;</span> <span class="token number">9090</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那接下来，咱们就访问一下Prometheus吧！如下图：</p><p><img src="https://img.kubesre.com/kubesre/20230809/16.png" alt=""></p><h3 id="访问grafana" tabindex="-1"><a class="header-anchor" href="#访问grafana" aria-hidden="true">#</a> 访问Grafana</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-50.57 ~/prometheus/aa/kube-prometheus/manifests<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">192.168</span>.50.57\n<span class="token comment"># kubectl --namespace monitoring port-forward svc/grafana --address 0.0.0.0 13000:3000</span>\nForwarding from <span class="token number">0.0</span>.0.0:13000 -<span class="token operator">&gt;</span> <span class="token number">3000</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那接下来，咱们就访问一下Grafana吧！如下图：</p><p>注：默认账号密码：admin/admin</p><p><img src="https://img.kubesre.com/kubesre/20230809/2.png" alt=""></p><h3 id="访问alertmanager" tabindex="-1"><a class="header-anchor" href="#访问alertmanager" aria-hidden="true">#</a> 访问Alertmanager</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-50.57 ~/prometheus/aa/kube-prometheus/manifests<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">192.168</span>.50.57\n<span class="token comment"># kubectl --namespace monitoring port-forward svc/alertmanager-main --address 0.0.0.0 19093:9093</span>\nForwarding from <span class="token number">0.0</span>.0.0:19093 -<span class="token operator">&gt;</span> <span class="token number">9093</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那接下来，咱们就访问一下Alertmanager吧！如下图： <img src="https://img.kubesre.com/kubesre/20230809/3.png" alt=""></p><h3 id="修改访问方式" tabindex="-1"><a class="header-anchor" href="#修改访问方式" aria-hidden="true">#</a> 修改访问方式</h3><p>修改grafana的service类型为NodePort</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>\n<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> grafana\n    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> grafana\n    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus\n    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 7.5.4\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort\n  <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http\n    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3000</span>\n    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> grafana\n    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> grafana\n    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-50.57 ~/prometheus/aa/kube-prometheus/manifests<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">192.168</span>.50.57\n<span class="token comment"># kubectl get svc -n monitoring  | grep grafana</span>\ngrafana                 NodePort    <span class="token number">200.96</span>.25.92      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3000</span>:30966/TCP               44m\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img.kubesre.com/kubesre/20230809/2.png" alt=""></p><ul><li></li></ul><p>修改prometheus的service类型为NodePort</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1\n<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service\n<span class="token key atrule">metadata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">labels</span><span class="token punctuation">:</span>\n    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus\n    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus\n    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus\n    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.26.0\n    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s\n  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s\n  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring\n<span class="token key atrule">spec</span><span class="token punctuation">:</span>\n  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort\n  <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web\n    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>\n    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> web\n  <span class="token key atrule">selector</span><span class="token punctuation">:</span>\n    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus\n    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus\n    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus\n    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus\n    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s\n  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> ClientIP\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-50.57 ~/prometheus/aa/kube-prometheus/manifests<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">192.168</span>.50.57\n<span class="token comment"># kubectl get svc -n monitoring  | grep prometheus-k8s</span>\nprometheus-k8s          NodePort    <span class="token number">200.108</span>.12.8      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>:32024/TCP               46m\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img.kubesre.com/kubesre/20230809/3.png" alt=""></p><h3 id="grafana对接prometheus" tabindex="-1"><a class="header-anchor" href="#grafana对接prometheus" aria-hidden="true">#</a> Grafana对接Prometheus</h3><p><img src="https://img.kubesre.com/kubesre/20230809/6.png" alt=""></p><p>输入Prometheus连接信息</p><p><img src="https://img.kubesre.com/kubesre/20230809/7.png" alt=""></p><p>点击Test出现Data source is working即为成功</p><p><img src="https://img.kubesre.com/kubesre/20230809/8.png" alt=""></p><h3 id="grafana加载dashboard" tabindex="-1"><a class="header-anchor" href="#grafana加载dashboard" aria-hidden="true">#</a> Grafana加载Dashboard</h3><p><img src="https://img.kubesre.com/kubesre/20230809/9.png" alt=""></p><p>拷贝dashboard面板ID，当然也可以下载该dashboard对应的json文件</p><p><img src="https://img.kubesre.com/kubesre/20230809/10.png" alt=""></p><p>然后到Grafana控制台进行导入模版</p><p><img src="https://img.kubesre.com/kubesre/20230809/11.png" alt=""></p><p>点击Load</p><p><img src="https://img.kubesre.com/kubesre/20230809/12.png" alt=""></p><p>本次案例使用的是ID，当然也可以使用加载json文件的方式。</p><p><img src="https://img.kubesre.com/kubesre/20230809/13.png" alt=""> 导入成功了，咱们可以看下效果，如下图！</p><p><img src="https://img.kubesre.com/kubesre/20230809/14.png" alt=""></p>', 74);
function _sfc_render(_ctx, _cache) {
  const _component_ExternalLinkIcon = resolveComponent("ExternalLinkIcon");
  return openBlock(), createElementBlock("div", null, [
    _hoisted_1,
    createBaseVNode("p", null, [
      createTextVNode("参考连接： "),
      createBaseVNode("a", _hoisted_11, [
        createTextVNode("https://github.com/prometheus-operator/kube-prometheus#compatibility"),
        createVNode(_component_ExternalLinkIcon)
      ])
    ]),
    _hoisted_12
  ]);
}
const prometheusOperator____html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "prometheus-operator(-).html.vue"]]);
export {
  prometheusOperator____html as default
};
